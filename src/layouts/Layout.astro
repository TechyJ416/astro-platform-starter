---
// src/layouts/Layout.astro
import { supabase } from "../lib/supabase";
import ImpersonationBanner from "../components/ImpersonationBanner.astro";

interface Props {
  title?: string;
  description?: string;
}

const { title, description } = Astro.props;

let general = {
  siteName: "Banity",
  tagline: "Create Authentic Content. Get Paid.",
  description: "Banity connects creators with brands for authentic UGC campaigns.",
};

let appearance = {
  primaryColor: "#4f8bff",
  accentColor: "#a855f7",
  logoUrl: "",
  faviconUrl: "",
};

try {
  const { data } = await supabase.from("site_settings").select("key, value");
  if (data) {
    for (const row of data) {
      if (row.key === "general") general = { ...general, ...row.value };
      if (row.key === "appearance") appearance = { ...appearance, ...row.value };
    }
  }
} catch (e) {}

const pageTitle = title ? `${title} | ${general.siteName}` : `${general.siteName} - ${general.tagline}`;
const pageDescription = description || general.description;

const session = Astro.locals?.session;
const isAdmin = Astro.locals?.isAdmin;
const isModerator = Astro.locals?.isModerator;
const isImpersonating = Astro.locals?.isImpersonating || false;
const impersonatedUser = Astro.locals?.impersonatedUser;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    {appearance.faviconUrl ? (
      <link rel="icon" href={appearance.faviconUrl} />
    ) : (
      <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    )}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  </head>

  <body class:list={[{ "has-impersonation-banner": isImpersonating }]}>
    <canvas id="bg-particles" aria-hidden="true"></canvas>

    {isImpersonating && impersonatedUser && (
      <ImpersonationBanner user={impersonatedUser} />
    )}

    <nav class="main-nav">
      <div class="nav-content">
        <a href="/" class="nav-logo">
          {appearance.logoUrl ? (
            <img src={appearance.logoUrl} alt={general.siteName} class="logo-img" />
          ) : (
            <>
              <span class="logo-icon">✦</span>
              <span class="logo-text">{general.siteName}</span>
            </>
          )}
        </a>
        <div class="nav-links">
          <a href="/campaigns">Campaigns</a>
          <a href="/creators">Creators</a>
          <a href="/community">Community</a>
          <a href="/contact">Contact</a>
        </div>
        <div class="nav-actions">
          {session ? (
            <>
              <a href="/dashboard" class="nav-link">Dashboard</a>
              {(isAdmin || isModerator) && !isImpersonating && (
                <a href="/admin" class="nav-link">Admin</a>
              )}
              {!isImpersonating && <a href="/logout" class="nav-link">Log Out</a>}
            </>
          ) : (
            <>
              <a href="/login" class="nav-link">Sign In</a>
              <a href="/signup" class="nav-btn">Join Now</a>
            </>
          )}
        </div>
      </div>
    </nav>

    <main class="main-content">
      <slot />
    </main>

    <footer class="main-footer">
      <div class="footer-inner">
        <div class="footer-brand">
          <span class="footer-logo">✦ {general.siteName}</span>
          <p>The premier platform for UGC creators</p>
        </div>
        <div class="footer-links">
          <a href="/campaigns">Campaigns</a>
          <a href="/community">Community</a>
          <a href="/contact">Contact</a>
        </div>
        <div class="footer-copy">© 2024 {general.siteName}. All rights reserved.</div>
      </div>
    </footer>

    <style is:global>
      :root {
        --void: #030108;
        --nebula: #0a0510;
        --stardust: #150a20;
        --surface: #1a1025;
        --surface-light: #251535;
        --cosmic-blue: #8b5cf6;
        --cosmic-purple: #c026d3;
        --cosmic-pink: #ec4899;
        --cosmic-magenta: #d946ef;
        --cosmic-cyan: #a78bfa;
        --star-white: #f8fafc;
        --star-dim: #a78bfa;
        --star-muted: #7c3aed;
        --glow-purple: rgba(192, 38, 211, 0.5);
        --glow-pink: rgba(236, 72, 153, 0.5);
        --glow-violet: rgba(139, 92, 246, 0.5);
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --font-display: 'Syne', system-ui, sans-serif;
        --font-mono: 'Space Mono', monospace;
      }

      * { margin: 0; padding: 0; box-sizing: border-box; }
      html { scroll-behavior: smooth; }

      body {
        font-family: var(--font-display);
        background: var(--void);
        color: var(--star-white);
        line-height: 1.6;
        min-height: 100vh;
        overflow-x: hidden;
      }

      a { color: inherit; }

      #bg-particles {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
      }

      .main-nav {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        padding: 1rem 2rem;
        background: linear-gradient(180deg, rgba(3, 1, 8, 0.95) 0%, rgba(3, 1, 8, 0.7) 50%, transparent 100%);
        backdrop-filter: blur(12px);
      }

      .nav-content {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 2rem;
      }

      .nav-logo {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        text-decoration: none;
        color: var(--star-white);
      }

      .logo-img { height: 32px; width: auto; }

      .logo-icon {
        font-size: 1.5rem;
        color: var(--cosmic-purple);
        text-shadow: 0 0 20px var(--glow-purple);
        animation: logo-glow 3s ease-in-out infinite;
      }

      @keyframes logo-glow {
        0%, 100% { text-shadow: 0 0 20px var(--glow-purple); }
        50% { text-shadow: 0 0 30px var(--glow-purple), 0 0 50px var(--glow-pink); }
      }

      .logo-text {
        font-size: 1.25rem;
        font-weight: 700;
        letter-spacing: -0.02em;
      }

      .nav-links {
        display: flex;
        align-items: center;
        gap: 2rem;
      }

      .nav-links a {
        color: rgba(255, 255, 255, 0.6);
        text-decoration: none;
        font-size: 0.9375rem;
        font-weight: 500;
        transition: color 0.3s;
      }

      .nav-links a:hover { color: var(--star-white); }

      .nav-actions {
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }

      .nav-link {
        color: rgba(255, 255, 255, 0.6);
        text-decoration: none;
        font-size: 0.9375rem;
        font-weight: 500;
        transition: color 0.3s;
      }

      .nav-link:hover { color: var(--star-white); }

      .nav-btn {
        padding: 0.625rem 1.5rem;
        background: linear-gradient(135deg, var(--cosmic-purple), var(--cosmic-pink));
        border-radius: 100px;
        color: white !important;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.3s;
        box-shadow: 0 4px 20px rgba(192, 38, 211, 0.3);
      }

      .nav-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(192, 38, 211, 0.5);
      }

      .main-content {
        position: relative;
        z-index: 1;
        min-height: calc(100vh - 200px);
        padding-top: 80px;
      }

      .main-footer {
        position: relative;
        z-index: 1;
        padding: 3rem 2rem;
        border-top: 1px solid rgba(192, 38, 211, 0.1);
        background: linear-gradient(180deg, transparent, rgba(3, 1, 8, 0.9));
      }

      .footer-inner {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 2rem;
      }

      .footer-logo {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--star-white);
      }

      .footer-brand p {
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.5);
      }

      .footer-links {
        display: flex;
        gap: 2rem;
      }

      .footer-links a {
        color: rgba(255, 255, 255, 0.5);
        text-decoration: none;
        font-size: 0.875rem;
        transition: color 0.3s;
      }

      .footer-links a:hover { color: var(--star-white); }

      .footer-copy {
        width: 100%;
        text-align: center;
        padding-top: 2rem;
        border-top: 1px solid rgba(192, 38, 211, 0.1);
        font-size: 0.8125rem;
        color: rgba(255, 255, 255, 0.4);
      }

      /* Global utility classes */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9375rem;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--cosmic-purple), var(--cosmic-pink));
        color: white;
        box-shadow: 0 4px 20px rgba(192, 38, 211, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(192, 38, 211, 0.5);
      }

      .btn-secondary {
        background: rgba(192, 38, 211, 0.15);
        color: var(--star-white);
        border: 1px solid rgba(192, 38, 211, 0.3);
      }

      .btn-secondary:hover {
        background: rgba(192, 38, 211, 0.25);
        border-color: var(--cosmic-purple);
      }

      .btn-disabled {
        background: var(--surface);
        color: var(--star-muted);
        cursor: not-allowed;
      }

      @media (max-width: 768px) {
        .nav-links { display: none; }
        .nav-actions { gap: 1rem; }
        .footer-inner { flex-direction: column; text-align: center; }
        .footer-links { justify-content: center; }
      }
    </style>

    <script is:inline>
      class NebulaParticleSystem {
        constructor(canvas) {
          this.canvas = canvas;
          this.ctx = canvas.getContext('2d');
          this.particles = [];
          this.nebulaClouds = [];
          this.sparkles = [];
          this.time = 0;
          this.flowSpeed = 0.4;
          
          this.init();
          this.animate();
        }

        init() {
          this.resize();
          this.createNebulaClouds();
          this.createParticles();
          this.createSparkles();
          
          window.addEventListener('resize', () => {
            this.resize();
            this.createNebulaClouds();
            this.createParticles();
            this.createSparkles();
          });
        }

        resize() {
          this.canvas.width = window.innerWidth;
          this.canvas.height = window.innerHeight;
        }

        createNebulaClouds() {
          this.nebulaClouds = [];
          const cloudCount = 25;
          
          for (let i = 0; i < cloudCount; i++) {
            this.nebulaClouds.push({
              x: Math.random() * this.canvas.width,
              y: Math.random() * this.canvas.height,
              baseY: Math.random() * this.canvas.height,
              size: Math.random() * 300 + 150,
              color: this.getNebulaColor(),
              opacity: Math.random() * 0.15 + 0.05,
              speedY: Math.random() * 0.3 + 0.1,
              wobbleSpeed: Math.random() * 0.001 + 0.0005,
              wobbleAmount: Math.random() * 50 + 20,
              phase: Math.random() * Math.PI * 2,
              pulseSpeed: Math.random() * 0.002 + 0.001,
              pulsePhase: Math.random() * Math.PI * 2
            });
          }
        }

        createParticles() {
          this.particles = [];
          const particleCount = 15000;
          
          for (let i = 0; i < particleCount; i++) {
            const layer = Math.random();
            let size, speed, opacity;
            
            if (layer < 0.3) {
              size = Math.random() * 0.8 + 0.3;
              speed = Math.random() * 0.8 + 0.3;
              opacity = Math.random() * 0.3 + 0.1;
            } else if (layer < 0.7) {
              size = Math.random() * 1.2 + 0.5;
              speed = Math.random() * 0.5 + 0.2;
              opacity = Math.random() * 0.5 + 0.2;
            } else {
              size = Math.random() * 1.8 + 0.8;
              speed = Math.random() * 0.3 + 0.1;
              opacity = Math.random() * 0.7 + 0.3;
            }
            
            this.particles.push({
              x: Math.random() * this.canvas.width,
              y: Math.random() * this.canvas.height,
              size: size,
              baseSize: size,
              color: this.getParticleColor(),
              opacity: opacity,
              baseOpacity: opacity,
              speedY: speed * this.flowSpeed,
              wobbleX: Math.random() * 0.5 + 0.1,
              wobblePhase: Math.random() * Math.PI * 2,
              pulseSpeed: Math.random() * 0.03 + 0.01,
              pulsePhase: Math.random() * Math.PI * 2
            });
          }
        }

        createSparkles() {
          this.sparkles = [];
          const sparkleCount = 500;
          
          for (let i = 0; i < sparkleCount; i++) {
            this.sparkles.push({
              x: Math.random() * this.canvas.width,
              y: Math.random() * this.canvas.height,
              size: Math.random() * 2 + 1,
              brightness: Math.random(),
              twinkleSpeed: Math.random() * 0.05 + 0.02,
              twinklePhase: Math.random() * Math.PI * 2,
              speedY: Math.random() * 0.2 + 0.05
            });
          }
        }

        getNebulaColor() {
          const colors = [
            { r: 147, g: 51, b: 234 },
            { r: 192, g: 38, b: 211 },
            { r: 236, g: 72, b: 153 },
            { r: 139, g: 92, b: 246 },
            { r: 168, g: 85, b: 247 },
            { r: 217, g: 70, b: 239 },
            { r: 124, g: 58, b: 237 },
            { r: 99, g: 102, b: 241 }
          ];
          return colors[Math.floor(Math.random() * colors.length)];
        }

        getParticleColor() {
          const rand = Math.random();
          if (rand < 0.35) {
            return { r: 192 + Math.random() * 40, g: 38 + Math.random() * 30, b: 211 + Math.random() * 44 };
          } else if (rand < 0.65) {
            return { r: 147 + Math.random() * 50, g: 51 + Math.random() * 40, b: 234 + Math.random() * 21 };
          } else if (rand < 0.85) {
            return { r: 236 + Math.random() * 19, g: 72 + Math.random() * 50, b: 153 + Math.random() * 60 };
          } else {
            return { r: 200 + Math.random() * 55, g: 180 + Math.random() * 75, b: 255 };
          }
        }

        update() {
          this.time += 0.016;
          
          this.nebulaClouds.forEach(cloud => {
            cloud.y += cloud.speedY * this.flowSpeed;
            cloud.x = cloud.x + Math.sin(this.time * cloud.wobbleSpeed + cloud.phase) * 0.3;
            cloud.currentOpacity = cloud.opacity * (0.7 + 0.3 * Math.sin(this.time * cloud.pulseSpeed + cloud.pulsePhase));
            
            if (cloud.y - cloud.size > this.canvas.height) {
              cloud.y = -cloud.size;
              cloud.x = Math.random() * this.canvas.width;
            }
          });
          
          this.particles.forEach(p => {
            p.y += p.speedY;
            p.x += Math.sin(this.time * p.wobbleX + p.wobblePhase) * 0.2;
            
            const pulse = Math.sin(this.time * p.pulseSpeed + p.pulsePhase);
            p.size = p.baseSize * (0.8 + 0.4 * pulse);
            p.opacity = p.baseOpacity * (0.6 + 0.4 * pulse);
            
            if (p.y > this.canvas.height + 10) {
              p.y = -10;
              p.x = Math.random() * this.canvas.width;
            }
          });
          
          this.sparkles.forEach(s => {
            s.y += s.speedY * this.flowSpeed;
            s.currentBrightness = s.brightness * (0.3 + 0.7 * Math.abs(Math.sin(this.time * s.twinkleSpeed + s.twinklePhase)));
            
            if (s.y > this.canvas.height + 5) {
              s.y = -5;
              s.x = Math.random() * this.canvas.width;
            }
          });
        }

        render() {
          this.ctx.fillStyle = '#030108';
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
          
          const bgGradient = this.ctx.createRadialGradient(
            this.canvas.width / 2, this.canvas.height / 2, 0,
            this.canvas.width / 2, this.canvas.height / 2, this.canvas.width * 0.7
          );
          bgGradient.addColorStop(0, 'rgba(75, 0, 90, 0.15)');
          bgGradient.addColorStop(0.5, 'rgba(40, 0, 60, 0.1)');
          bgGradient.addColorStop(1, 'transparent');
          this.ctx.fillStyle = bgGradient;
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
          
          this.ctx.globalCompositeOperation = 'screen';
          
          this.nebulaClouds.forEach(cloud => {
            const gradient = this.ctx.createRadialGradient(
              cloud.x, cloud.y, 0,
              cloud.x, cloud.y, cloud.size
            );
            gradient.addColorStop(0, `rgba(${cloud.color.r}, ${cloud.color.g}, ${cloud.color.b}, ${cloud.currentOpacity * 0.8})`);
            gradient.addColorStop(0.3, `rgba(${cloud.color.r}, ${cloud.color.g}, ${cloud.color.b}, ${cloud.currentOpacity * 0.4})`);
            gradient.addColorStop(0.6, `rgba(${cloud.color.r * 0.8}, ${cloud.color.g * 0.8}, ${cloud.color.b}, ${cloud.currentOpacity * 0.15})`);
            gradient.addColorStop(1, 'transparent');
            
            this.ctx.fillStyle = gradient;
            this.ctx.beginPath();
            this.ctx.arc(cloud.x, cloud.y, cloud.size, 0, Math.PI * 2);
            this.ctx.fill();
          });
          
          this.ctx.globalCompositeOperation = 'lighter';
          
          this.particles.forEach(p => {
            if (p.size > 1.2) {
              const glowGradient = this.ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size * 3);
              glowGradient.addColorStop(0, `rgba(${p.color.r}, ${p.color.g}, ${p.color.b}, ${p.opacity * 0.4})`);
              glowGradient.addColorStop(0.5, `rgba(${p.color.r}, ${p.color.g}, ${p.color.b}, ${p.opacity * 0.1})`);
              glowGradient.addColorStop(1, 'transparent');
              this.ctx.fillStyle = glowGradient;
              this.ctx.beginPath();
              this.ctx.arc(p.x, p.y, p.size * 3, 0, Math.PI * 2);
              this.ctx.fill();
            }
            
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            this.ctx.fillStyle = `rgba(${p.color.r}, ${p.color.g}, ${p.color.b}, ${p.opacity})`;
            this.ctx.fill();
          });
          
          this.sparkles.forEach(s => {
            const sparkleGradient = this.ctx.createRadialGradient(s.x, s.y, 0, s.x, s.y, s.size * 2);
            sparkleGradient.addColorStop(0, `rgba(255, 255, 255, ${s.currentBrightness})`);
            sparkleGradient.addColorStop(0.3, `rgba(230, 200, 255, ${s.currentBrightness * 0.5})`);
            sparkleGradient.addColorStop(1, 'transparent');
            this.ctx.fillStyle = sparkleGradient;
            this.ctx.beginPath();
            this.ctx.arc(s.x, s.y, s.size * 2, 0, Math.PI * 2);
            this.ctx.fill();
            
            this.ctx.beginPath();
            this.ctx.arc(s.x, s.y, s.size * 0.5, 0, Math.PI * 2);
            this.ctx.fillStyle = `rgba(255, 255, 255, ${s.currentBrightness})`;
            this.ctx.fill();
          });
          
          this.ctx.globalCompositeOperation = 'source-over';
        }

        animate() {
          this.update();
          this.render();
          requestAnimationFrame(() => this.animate());
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('bg-particles');
        if (canvas) new NebulaParticleSystem(canvas);
      });
    </script>
  </body>
</html>
