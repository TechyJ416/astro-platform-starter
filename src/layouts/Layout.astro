---
// src/layouts/Layout.astro
import { supabase } from "../lib/supabase";
import ImpersonationBanner from "../components/ImpersonationBanner.astro";

interface Props {
  title?: string;
  description?: string;
}

const { title, description } = Astro.props;

// Load settings from database
let general = {
  siteName: "Banity",
  tagline: "Create Authentic Content. Get Paid.",
  description: "Banity connects creators with brands for authentic UGC campaigns.",
  supportEmail: "support@banity.com",
  contactEmail: "hello@banity.com",
};

let appearance = {
  primaryColor: "#2563eb",
  accentColor: "#059669",
  logoUrl: "",
  faviconUrl: "",
};

try {
  const { data } = await supabase.from("site_settings").select("key, value");
  if (data) {
    for (const row of data) {
      if (row.key === "general") general = { ...general, ...row.value };
      if (row.key === "appearance") appearance = { ...appearance, ...row.value };
    }
  }
} catch (e) {
  console.error("Failed to load settings:", e);
}

const pageTitle = title
  ? `${title} | ${general.siteName}`
  : `${general.siteName} - ${general.tagline}`;

const pageDescription = description || general.description;

const session = Astro.locals?.session;
const isAdmin = Astro.locals?.isAdmin;
const isModerator = Astro.locals?.isModerator;
const isImpersonating = Astro.locals?.isImpersonating || false;
const impersonatedUser = Astro.locals?.impersonatedUser;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="view-transition" content="same-origin" />

    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />

    {appearance.faviconUrl ? (
      <link rel="icon" href={appearance.faviconUrl} />
    ) : (
      <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    )}

    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    {appearance.logoUrl && <meta property="og:image" content={appearance.logoUrl} />}

    <!-- Global particle styling only -->
    <link rel="stylesheet" href="/styles/particles.css" />
  </head>

  <body
    style={`--primary-color:${appearance.primaryColor};--accent-color:${appearance.accentColor};`}
    class:list={[{ "has-impersonation-banner": isImpersonating }]}
  >
    <!-- ðŸŒŒ GLOBAL BACKGROUND PARTICLES (persistent across pages) -->
    <canvas id="global-particles" aria-hidden="true"></canvas>

    {isImpersonating && impersonatedUser && (
      <ImpersonationBanner user={impersonatedUser} />
    )}

    <header class="site-header">
      <div class="header-container">
        <a href="/" class="logo">
          {appearance.logoUrl ? (
            <img src={appearance.logoUrl} alt={general.siteName} />
          ) : (
            <span>{general.siteName}</span>
          )}
        </a>

        <nav>
          <a href="/campaigns">Campaigns</a>
          <a href="/creators">Creators</a>
          <a href="/forum">Forum</a>
          <a href="/contact">Contact</a>
          <a href="/about">About</a>
        </nav>

        <div class="header-actions">
          {session ? (
            <>
              <a href="/dashboard">Dashboard</a>
              {(isAdmin || isModerator) && !isImpersonating && (
                <a href="/admin">Admin</a>
              )}
              {!isImpersonating && <a href="/logout">Log Out</a>}
            </>
          ) : (
            <>
              <a href="/login">Log In</a>
              <a href="/signup">Sign Up</a>
            </>
          )}
        </div>
      </div>
    </header>

    <main>
      <slot />
    </main>

    <footer class="site-footer">
      <slot name="footer" />
    </footer>

    <!-- ðŸŒŒ GLOBAL PARTICLE ENGINE (ONE TIME ONLY) -->
    <script type="module" src="/particles/globalParticles.js"></script>

    <style>
      body {
        background: radial-gradient(1200px at 50% -20%, #0b1024, #020208);
        overflow-x: hidden;
      }

      main {
        position: relative;
        z-index: 2;
      }

      header,
      footer {
        position: relative;
        z-index: 3;
      }

      #global-particles {
        position: fixed;
        inset: 0;
        z-index: 0;
        pointer-events: none;
      }
    </style>
  </body>
</html>
