---
// src/layouts/Layout.astro
import { supabase } from "../lib/supabase";
import ImpersonationBanner from "../components/ImpersonationBanner.astro";

interface Props {
  title?: string;
  description?: string;
}

const { title, description } = Astro.props;

let general = {
  siteName: "Banity",
  tagline: "Create Authentic Content. Get Paid.",
  description: "Banity connects creators with brands for authentic UGC campaigns.",
};

let appearance = {
  primaryColor: "#4f8bff",
  accentColor: "#a855f7",
  logoUrl: "",
  faviconUrl: "",
};

try {
  const { data } = await supabase.from("site_settings").select("key, value");
  if (data) {
    for (const row of data) {
      if (row.key === "general") general = { ...general, ...row.value };
      if (row.key === "appearance") appearance = { ...appearance, ...row.value };
    }
  }
} catch (e) {}

const pageTitle = title ? `${title} | ${general.siteName}` : `${general.siteName} - ${general.tagline}`;
const pageDescription = description || general.description;

const session = Astro.locals?.session;
const isAdmin = Astro.locals?.isAdmin;
const isModerator = Astro.locals?.isModerator;
const isImpersonating = Astro.locals?.isImpersonating || false;
const impersonatedUser = Astro.locals?.impersonatedUser;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    {appearance.faviconUrl ? (
      <link rel="icon" href={appearance.faviconUrl} />
    ) : (
      <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    )}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  </head>

  <body class:list={[{ "has-impersonation-banner": isImpersonating }]}>
    <canvas id="bg-particles" aria-hidden="true"></canvas>

    {isImpersonating && impersonatedUser && (
      <ImpersonationBanner user={impersonatedUser} />
    )}

    <nav class="main-nav">
      <div class="nav-content">
        <a href="/" class="nav-logo">
          {appearance.logoUrl ? (
            <img src={appearance.logoUrl} alt={general.siteName} class="logo-img" />
          ) : (
            <>
              <span class="logo-icon">✦</span>
              <span class="logo-text">{general.siteName}</span>
            </>
          )}
        </a>
        <div class="nav-links">
          <a href="/campaigns">Campaigns</a>
          <a href="/creators">Creators</a>
          <a href="/community">Community</a>
          <a href="/contact">Contact</a>
        </div>
        <div class="nav-actions">
          {session ? (
            <>
              <a href="/dashboard" class="nav-link">Dashboard</a>
              {(isAdmin || isModerator) && !isImpersonating && (
                <a href="/admin" class="nav-link">Admin</a>
              )}
              {!isImpersonating && <a href="/logout" class="nav-link">Log Out</a>}
            </>
          ) : (
            <>
              <a href="/login" class="nav-link">Sign In</a>
              <a href="/signup" class="nav-btn">Join Now</a>
            </>
          )}
        </div>
      </div>
    </nav>

    <main class="main-content">
      <slot />
    </main>

    <footer class="main-footer">
      <div class="footer-inner">
        <div class="footer-brand">
          <span class="footer-logo">✦ {general.siteName}</span>
          <p>The premier platform for UGC creators</p>
        </div>
        <div class="footer-links">
          <a href="/campaigns">Campaigns</a>
          <a href="/community">Community</a>
          <a href="/contact">Contact</a>
        </div>
        <div class="footer-copy">© 2024 {general.siteName}. All rights reserved.</div>
      </div>
    </footer>

    <style is:global>
      :root {
        --void: #020206;
        --nebula: #080812;
        --stardust: #12121f;
        --surface: #1a1a2e;
        --surface-light: #252540;
        --cosmic-blue: #4f8bff;
        --cosmic-purple: #a855f7;
        --cosmic-pink: #ec4899;
        --cosmic-cyan: #22d3ee;
        --star-white: #f8fafc;
        --star-dim: #94a3b8;
        --star-muted: #64748b;
        --glow-blue: rgba(79, 139, 255, 0.5);
        --glow-purple: rgba(168, 85, 247, 0.5);
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --font-display: 'Syne', system-ui, sans-serif;
        --font-mono: 'Space Mono', monospace;
      }

      * { margin: 0; padding: 0; box-sizing: border-box; }
      html { scroll-behavior: smooth; }

      body {
        font-family: var(--font-display);
        background: var(--void);
        color: var(--star-white);
        line-height: 1.6;
        min-height: 100vh;
        overflow-x: hidden;
      }

      a { color: inherit; }

      #bg-particles {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
      }

      .main-nav {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        padding: 1rem 2rem;
        background: linear-gradient(180deg, rgba(2, 2, 6, 0.95) 0%, rgba(2, 2, 6, 0.7) 50%, transparent 100%);
        backdrop-filter: blur(12px);
      }

      .nav-content {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 2rem;
      }

      .nav-logo {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        text-decoration: none;
        color: var(--star-white);
      }

      .logo-img { height: 32px; width: auto; }

      .logo-icon {
        font-size: 1.5rem;
        color: var(--cosmic-blue);
        text-shadow: 0 0 20px var(--glow-blue);
      }

      .logo-text {
        font-size: 1.25rem;
        font-weight: 700;
        letter-spacing: -0.02em;
      }

      .nav-links {
        display: flex;
        align-items: center;
        gap: 2rem;
      }

      .nav-links a {
        color: var(--star-dim);
        text-decoration: none;
        font-size: 0.9375rem;
        font-weight: 500;
        transition: color 0.3s;
      }

      .nav-links a:hover { color: var(--star-white); }

      .nav-actions {
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }

      .nav-link {
        color: var(--star-dim);
        text-decoration: none;
        font-size: 0.9375rem;
        font-weight: 500;
        transition: color 0.3s;
      }

      .nav-link:hover { color: var(--star-white); }

      .nav-btn {
        padding: 0.625rem 1.5rem;
        background: linear-gradient(135deg, var(--cosmic-blue), var(--cosmic-purple));
        border-radius: 100px;
        color: white !important;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.3s;
      }

      .nav-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 40px var(--glow-blue);
      }

      .main-content {
        position: relative;
        z-index: 1;
        min-height: calc(100vh - 200px);
        padding-top: 80px;
      }

      .main-footer {
        position: relative;
        z-index: 1;
        padding: 3rem 2rem;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        background: linear-gradient(180deg, transparent, rgba(2, 2, 6, 0.9));
      }

      .footer-inner {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 2rem;
      }

      .footer-logo {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--star-white);
      }

      .footer-brand p {
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: var(--star-dim);
      }

      .footer-links {
        display: flex;
        gap: 2rem;
      }

      .footer-links a {
        color: var(--star-dim);
        text-decoration: none;
        font-size: 0.875rem;
        transition: color 0.3s;
      }

      .footer-links a:hover { color: var(--star-white); }

      .footer-copy {
        width: 100%;
        text-align: center;
        padding-top: 2rem;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 0.8125rem;
        color: var(--star-dim);
      }

      /* Global utility classes */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9375rem;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--cosmic-blue), var(--cosmic-purple));
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 40px var(--glow-blue);
      }

      .btn-secondary {
        background: var(--surface-light);
        color: var(--star-white);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .btn-secondary:hover {
        background: var(--surface);
        border-color: var(--cosmic-blue);
      }

      .btn-disabled {
        background: var(--surface);
        color: var(--star-muted);
        cursor: not-allowed;
      }

      @media (max-width: 768px) {
        .nav-links { display: none; }
        .nav-actions { gap: 1rem; }
        .footer-inner { flex-direction: column; text-align: center; }
        .footer-links { justify-content: center; }
      }
    </style>

    <script is:inline>
      class CosmicBlobSystem {
        constructor(canvas) {
          this.canvas = canvas;
          this.ctx = canvas.getContext('2d');
          this.particles = [];
          this.backgroundStars = [];
          this.time = 0;
          this.mouseX = 0;
          this.mouseY = 0;
          this.scrollOffset = 0;
          
          // Blob configuration
          this.blobCenterX = 0;
          this.connectionDistance = 120;
          this.particleCount = 400;
          this.backgroundStarCount = 300;
          
          this.init();
          this.animate();
        }

        init() {
          this.resize();
          this.createBackgroundStars();
          this.createBlobParticles();
          
          window.addEventListener('resize', () => {
            this.resize();
            this.createBackgroundStars();
            this.createBlobParticles();
          });
          
          window.addEventListener('scroll', () => {
            this.scrollOffset = window.scrollY * 0.3;
          });
          
          window.addEventListener('mousemove', (e) => {
            this.mouseX = e.clientX;
            this.mouseY = e.clientY;
          });
        }

        resize() {
          this.canvas.width = window.innerWidth;
          this.canvas.height = window.innerHeight;
          this.blobCenterX = this.canvas.width / 2;
        }

        createBackgroundStars() {
          this.backgroundStars = [];
          for (let i = 0; i < this.backgroundStarCount; i++) {
            this.backgroundStars.push({
              x: Math.random() * this.canvas.width,
              y: Math.random() * this.canvas.height,
              size: Math.random() * 1.2 + 0.2,
              brightness: Math.random() * 0.4 + 0.1,
              twinkleSpeed: Math.random() * 0.015 + 0.005,
              twinklePhase: Math.random() * Math.PI * 2
            });
          }
        }

        createBlobParticles() {
          this.particles = [];
          const centerX = this.canvas.width / 2;
          const pageHeight = Math.max(document.body.scrollHeight, this.canvas.height * 3);
          
          for (let i = 0; i < this.particleCount; i++) {
            // Vertical distribution along the page
            const yPos = Math.random() * pageHeight;
            
            // Horizontal distribution - denser in middle, spread on sides
            const distFromCenter = this.gaussianRandom() * 200;
            const xPos = centerX + distFromCenter;
            
            // Determine if core particle (dense middle) or floating (sides)
            const isCore = Math.abs(distFromCenter) < 100;
            
            const baseSize = isCore ? 
              Math.random() * 2.5 + 1 : 
              Math.random() * 1.8 + 0.5;
            
            const color = this.getParticleColor(Math.abs(distFromCenter) / 200);
            
            this.particles.push({
              baseX: xPos,
              baseY: yPos,
              x: xPos,
              y: yPos,
              size: baseSize,
              color: color,
              isCore: isCore,
              
              // Floating motion
              floatRadius: isCore ? 
                Math.random() * 15 + 5 : 
                Math.random() * 40 + 20,
              floatSpeedX: Math.random() * 0.0008 + 0.0002,
              floatSpeedY: Math.random() * 0.0006 + 0.0002,
              floatPhaseX: Math.random() * Math.PI * 2,
              floatPhaseY: Math.random() * Math.PI * 2,
              
              // Vertical drift
              driftSpeed: (Math.random() - 0.5) * 0.3,
              
              // Pulse
              pulseSpeed: Math.random() * 0.02 + 0.01,
              pulsePhase: Math.random() * Math.PI * 2,
              
              // Brightness
              brightness: isCore ? 
                Math.random() * 0.4 + 0.6 : 
                Math.random() * 0.5 + 0.3
            });
          }
        }

        gaussianRandom() {
          let u = 0, v = 0;
          while (u === 0) u = Math.random();
          while (v === 0) v = Math.random();
          return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }

        getParticleColor(distRatio) {
          // Core particles are brighter blue/cyan, outer are purple/pink
          if (distRatio < 0.3) {
            return { r: 79 + Math.random() * 40, g: 139 + Math.random() * 60, b: 255 };
          } else if (distRatio < 0.6) {
            return { r: 139 + Math.random() * 30, g: 92 + Math.random() * 50, b: 246 };
          } else {
            return { r: 168 + Math.random() * 40, g: 85 + Math.random() * 40, b: 247 };
          }
        }

        updateParticles() {
          this.time += 0.016;
          
          const viewportTop = this.scrollOffset - 200;
          const viewportBottom = this.scrollOffset + this.canvas.height + 200;
          
          this.particles.forEach(p => {
            // Floating motion
            const floatX = Math.sin(this.time * p.floatSpeedX + p.floatPhaseX) * p.floatRadius;
            const floatY = Math.cos(this.time * p.floatSpeedY + p.floatPhaseY) * p.floatRadius * 0.6;
            
            // Vertical drift
            p.baseY += p.driftSpeed;
            
            // Wrap vertically
            const pageHeight = Math.max(document.body.scrollHeight, this.canvas.height * 3);
            if (p.baseY > pageHeight + 100) p.baseY = -100;
            if (p.baseY < -100) p.baseY = pageHeight + 100;
            
            // Mouse repulsion for nearby particles
            const screenY = p.baseY - this.scrollOffset;
            const dx = p.baseX - this.mouseX;
            const dy = screenY - this.mouseY;
            const mouseDist = Math.sqrt(dx * dx + dy * dy);
            
            let mouseRepelX = 0;
            let mouseRepelY = 0;
            if (mouseDist < 150) {
              const repelForce = (150 - mouseDist) / 150 * 30;
              mouseRepelX = (dx / mouseDist) * repelForce;
              mouseRepelY = (dy / mouseDist) * repelForce;
            }
            
            p.x = p.baseX + floatX + mouseRepelX;
            p.y = p.baseY + floatY;
            p.screenY = screenY + floatY + mouseRepelY;
            
            // Pulse
            p.currentSize = p.size * (0.8 + 0.2 * Math.sin(this.time * p.pulseSpeed + p.pulsePhase));
            p.currentBrightness = p.brightness * (0.7 + 0.3 * Math.sin(this.time * p.pulseSpeed + p.pulsePhase));
            
            // Check if visible
            p.visible = p.screenY > -50 && p.screenY < this.canvas.height + 50;
          });
        }

        drawConnections() {
          const visibleParticles = this.particles.filter(p => p.visible);
          
          for (let i = 0; i < visibleParticles.length; i++) {
            const p1 = visibleParticles[i];
            
            for (let j = i + 1; j < visibleParticles.length; j++) {
              const p2 = visibleParticles[j];
              
              const dx = p1.x - p2.x;
              const dy = p1.screenY - p2.screenY;
              const dist = Math.sqrt(dx * dx + dy * dy);
              
              if (dist < this.connectionDistance) {
                const alpha = (1 - dist / this.connectionDistance) * 0.15;
                
                // Gradient line between particles
                const gradient = this.ctx.createLinearGradient(p1.x, p1.screenY, p2.x, p2.screenY);
                gradient.addColorStop(0, `rgba(${p1.color.r}, ${p1.color.g}, ${p1.color.b}, ${alpha})`);
                gradient.addColorStop(1, `rgba(${p2.color.r}, ${p2.color.g}, ${p2.color.b}, ${alpha})`);
                
                this.ctx.beginPath();
                this.ctx.moveTo(p1.x, p1.screenY);
                this.ctx.lineTo(p2.x, p2.screenY);
                this.ctx.strokeStyle = gradient;
                this.ctx.lineWidth = 0.5;
                this.ctx.stroke();
              }
            }
          }
        }

        render() {
          // Clear
          this.ctx.fillStyle = '#020206';
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
          
          // Background stars
          this.backgroundStars.forEach(star => {
            const twinkle = 0.5 + 0.5 * Math.sin(this.time * star.twinkleSpeed + star.twinklePhase);
            this.ctx.beginPath();
            this.ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
            this.ctx.fillStyle = `rgba(255, 255, 255, ${star.brightness * twinkle})`;
            this.ctx.fill();
          });
          
          // Vertical blob glow (center column)
          const blobGradient = this.ctx.createLinearGradient(
            this.canvas.width / 2 - 150, 0,
            this.canvas.width / 2 + 150, 0
          );
          blobGradient.addColorStop(0, 'transparent');
          blobGradient.addColorStop(0.3, 'rgba(79, 139, 255, 0.03)');
          blobGradient.addColorStop(0.5, 'rgba(139, 92, 246, 0.05)');
          blobGradient.addColorStop(0.7, 'rgba(79, 139, 255, 0.03)');
          blobGradient.addColorStop(1, 'transparent');
          
          this.ctx.fillStyle = blobGradient;
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
          
          // Draw connections
          this.drawConnections();
          
          // Draw particles
          const visibleParticles = this.particles.filter(p => p.visible);
          
          visibleParticles.forEach(p => {
            // Glow for core particles
            if (p.isCore && p.currentSize > 1.5) {
              const glowSize = p.currentSize * 4;
              const glowGradient = this.ctx.createRadialGradient(
                p.x, p.screenY, 0,
                p.x, p.screenY, glowSize
              );
              glowGradient.addColorStop(0, `rgba(${p.color.r}, ${p.color.g}, ${p.color.b}, ${p.currentBrightness * 0.3})`);
              glowGradient.addColorStop(1, 'transparent');
              
              this.ctx.fillStyle = glowGradient;
              this.ctx.beginPath();
              this.ctx.arc(p.x, p.screenY, glowSize, 0, Math.PI * 2);
              this.ctx.fill();
            }
            
            // Particle
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.screenY, p.currentSize, 0, Math.PI * 2);
            this.ctx.fillStyle = `rgba(${p.color.r}, ${p.color.g}, ${p.color.b}, ${p.currentBrightness})`;
            this.ctx.fill();
          });
        }

        animate() {
          this.updateParticles();
          this.render();
          requestAnimationFrame(() => this.animate());
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('bg-particles');
        if (canvas) new CosmicBlobSystem(canvas);
      });
    </script>
  </body>
</html>
