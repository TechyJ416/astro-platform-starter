---
// src/layouts/Layout.astro
import { supabase } from "../lib/supabase";
import ImpersonationBanner from "../components/ImpersonationBanner.astro";

interface Props {
  title?: string;
  description?: string;
}

const { title, description } = Astro.props;

let general = {
  siteName: "Banity",
  tagline: "Create Authentic Content. Get Paid.",
  description: "Banity connects creators with brands for authentic UGC campaigns.",
};

let appearance = {
  primaryColor: "#4f8bff",
  accentColor: "#a855f7",
  logoUrl: "",
  faviconUrl: "",
};

try {
  const { data } = await supabase.from("site_settings").select("key, value");
  if (data) {
    for (const row of data) {
      if (row.key === "general") general = { ...general, ...row.value };
      if (row.key === "appearance") appearance = { ...appearance, ...row.value };
    }
  }
} catch (e) {}

const pageTitle = title ? `${title} | ${general.siteName}` : `${general.siteName} - ${general.tagline}`;
const pageDescription = description || general.description;

const session = Astro.locals?.session;
const isAdmin = Astro.locals?.isAdmin;
const isModerator = Astro.locals?.isModerator;
const isImpersonating = Astro.locals?.isImpersonating || false;
const impersonatedUser = Astro.locals?.impersonatedUser;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    {appearance.faviconUrl ? (
      <link rel="icon" href={appearance.faviconUrl} />
    ) : (
      <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    )}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  </head>

  <body class:list={[{ "has-impersonation-banner": isImpersonating }]}>
    <canvas id="bg-particles" aria-hidden="true"></canvas>

    {isImpersonating && impersonatedUser && (
      <ImpersonationBanner user={impersonatedUser} />
    )}

    <nav class="main-nav">
      <div class="nav-content">
        <a href="/" class="nav-logo">
          {appearance.logoUrl ? (
            <img src={appearance.logoUrl} alt={general.siteName} class="logo-img" />
          ) : (
            <>
              <span class="logo-icon">✦</span>
              <span class="logo-text">{general.siteName}</span>
            </>
          )}
        </a>
        <div class="nav-links">
          <a href="/campaigns">Campaigns</a>
          <a href="/creators">Creators</a>
          <a href="/community">Community</a>
          <a href="/contact">Contact</a>
        </div>
        <div class="nav-actions">
          {session ? (
            <>
              <a href="/dashboard" class="nav-link">Dashboard</a>
              {(isAdmin || isModerator) && !isImpersonating && (
                <a href="/admin" class="nav-link">Admin</a>
              )}
              {!isImpersonating && <a href="/logout" class="nav-link">Log Out</a>}
            </>
          ) : (
            <>
              <a href="/login" class="nav-link">Sign In</a>
              <a href="/signup" class="nav-btn">Join Now</a>
            </>
          )}
        </div>
      </div>
    </nav>

    <main class="main-content">
      <slot />
    </main>

    <footer class="main-footer">
      <div class="footer-inner">
        <div class="footer-brand">
          <span class="footer-logo">✦ {general.siteName}</span>
          <p>The premier platform for UGC creators</p>
        </div>
        <div class="footer-links">
          <a href="/campaigns">Campaigns</a>
          <a href="/community">Community</a>
          <a href="/contact">Contact</a>
        </div>
        <div class="footer-copy">© 2024 {general.siteName}. All rights reserved.</div>
      </div>
    </footer>

    <style is:global>
      :root {
        --void: #030108;
        --nebula: #0a0510;
        --stardust: #150a20;
        --surface: #1a1025;
        --surface-light: #251535;
        --cosmic-blue: #8b5cf6;
        --cosmic-purple: #c026d3;
        --cosmic-pink: #ec4899;
        --cosmic-magenta: #d946ef;
        --cosmic-cyan: #a78bfa;
        --star-white: #f8fafc;
        --star-dim: #a78bfa;
        --star-muted: #7c3aed;
        --glow-purple: rgba(192, 38, 211, 0.5);
        --glow-pink: rgba(236, 72, 153, 0.5);
        --glow-violet: rgba(139, 92, 246, 0.5);
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --font-display: 'Syne', system-ui, sans-serif;
        --font-mono: 'Space Mono', monospace;
      }

      * { margin: 0; padding: 0; box-sizing: border-box; }
      html { scroll-behavior: smooth; }

      body {
        font-family: var(--font-display);
        background: var(--void);
        color: var(--star-white);
        line-height: 1.6;
        min-height: 100vh;
        overflow-x: hidden;
      }

      a { color: inherit; }

      #bg-particles {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
      }

      .main-nav {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        padding: 1rem 2rem;
        background: linear-gradient(180deg, rgba(3, 1, 8, 0.95) 0%, rgba(3, 1, 8, 0.7) 50%, transparent 100%);
        backdrop-filter: blur(12px);
      }

      .nav-content {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 2rem;
      }

      .nav-logo {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        text-decoration: none;
        color: var(--star-white);
      }

      .logo-img { height: 32px; width: auto; }

      .logo-icon {
        font-size: 1.5rem;
        color: var(--cosmic-purple);
        text-shadow: 0 0 20px var(--glow-purple);
        animation: logo-glow 3s ease-in-out infinite;
      }

      @keyframes logo-glow {
        0%, 100% { text-shadow: 0 0 20px var(--glow-purple); }
        50% { text-shadow: 0 0 30px var(--glow-purple), 0 0 50px var(--glow-pink); }
      }

      .logo-text {
        font-size: 1.25rem;
        font-weight: 700;
        letter-spacing: -0.02em;
      }

      .nav-links {
        display: flex;
        align-items: center;
        gap: 2rem;
      }

      .nav-links a {
        color: rgba(255, 255, 255, 0.6);
        text-decoration: none;
        font-size: 0.9375rem;
        font-weight: 500;
        transition: color 0.3s;
      }

      .nav-links a:hover { color: var(--star-white); }

      .nav-actions {
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }

      .nav-link {
        color: rgba(255, 255, 255, 0.6);
        text-decoration: none;
        font-size: 0.9375rem;
        font-weight: 500;
        transition: color 0.3s;
      }

      .nav-link:hover { color: var(--star-white); }

      .nav-btn {
        padding: 0.625rem 1.5rem;
        background: linear-gradient(135deg, var(--cosmic-purple), var(--cosmic-pink));
        border-radius: 100px;
        color: white !important;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.3s;
        box-shadow: 0 4px 20px rgba(192, 38, 211, 0.3);
      }

      .nav-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(192, 38, 211, 0.5);
      }

      .main-content {
        position: relative;
        z-index: 1;
        min-height: calc(100vh - 200px);
        padding-top: 80px;
      }

      .main-footer {
        position: relative;
        z-index: 1;
        padding: 3rem 2rem;
        border-top: 1px solid rgba(192, 38, 211, 0.1);
        background: linear-gradient(180deg, transparent, rgba(3, 1, 8, 0.9));
      }

      .footer-inner {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 2rem;
      }

      .footer-logo {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--star-white);
      }

      .footer-brand p {
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.5);
      }

      .footer-links {
        display: flex;
        gap: 2rem;
      }

      .footer-links a {
        color: rgba(255, 255, 255, 0.5);
        text-decoration: none;
        font-size: 0.875rem;
        transition: color 0.3s;
      }

      .footer-links a:hover { color: var(--star-white); }

      .footer-copy {
        width: 100%;
        text-align: center;
        padding-top: 2rem;
        border-top: 1px solid rgba(192, 38, 211, 0.1);
        font-size: 0.8125rem;
        color: rgba(255, 255, 255, 0.4);
      }

      /* Global utility classes */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9375rem;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--cosmic-purple), var(--cosmic-pink));
        color: white;
        box-shadow: 0 4px 20px rgba(192, 38, 211, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(192, 38, 211, 0.5);
      }

      .btn-secondary {
        background: rgba(192, 38, 211, 0.15);
        color: var(--star-white);
        border: 1px solid rgba(192, 38, 211, 0.3);
      }

      .btn-secondary:hover {
        background: rgba(192, 38, 211, 0.25);
        border-color: var(--cosmic-purple);
      }

      .btn-disabled {
        background: var(--surface);
        color: var(--star-muted);
        cursor: not-allowed;
      }

      @media (max-width: 768px) {
        .nav-links { display: none; }
        .nav-actions { gap: 1rem; }
        .footer-inner { flex-direction: column; text-align: center; }
        .footer-links { justify-content: center; }
      }
    </style>

    <script is:inline>
      class FlowingNebula {
        constructor(canvas) {
          this.canvas = canvas;
          this.ctx = canvas.getContext('2d');
          this.particles = [];
          this.clouds = [];
          this.time = 0;
          this.verticalSpeed = 1.5;
          
          // Simple noise using sine waves
          this.init();
          this.animate();
        }

        init() {
          this.resize();
          this.createClouds();
          this.createParticles();
          
          window.addEventListener('resize', () => {
            this.resize();
            this.createClouds();
            this.createParticles();
          });
        }

        resize() {
          this.canvas.width = window.innerWidth;
          this.canvas.height = window.innerHeight;
        }

        // Simple flow noise
        flowNoise(x, y, t) {
          return Math.sin(x * 0.01 + t) * Math.cos(y * 0.008 + t * 0.7) + 
                 Math.sin(x * 0.005 - t * 0.5) * Math.cos(y * 0.012 + t * 0.3);
        }

        createClouds() {
          this.clouds = [];
          const cloudCount = 60;
          
          for (let i = 0; i < cloudCount; i++) {
            this.clouds.push({
              x: Math.random() * this.canvas.width,
              y: Math.random() * this.canvas.height * 2 - this.canvas.height * 0.5,
              size: Math.random() * 200 + 100,
              color: this.getColor(),
              opacity: Math.random() * 0.12 + 0.03,
              speedY: Math.random() * 0.5 + 0.3,
              wobblePhase: Math.random() * Math.PI * 2,
              wobbleSpeed: Math.random() * 0.02 + 0.01
            });
          }
        }

        createParticles() {
          this.particles = [];
          const count = 18000;
          
          for (let i = 0; i < count; i++) {
            const layer = Math.random();
            let size, brightness, speed;
            
            if (layer < 0.6) {
              size = Math.random() * 1 + 0.3;
              brightness = Math.random() * 0.5 + 0.2;
              speed = Math.random() * 1 + 0.5;
            } else if (layer < 0.9) {
              size = Math.random() * 1.5 + 0.8;
              brightness = Math.random() * 0.7 + 0.3;
              speed = Math.random() * 0.8 + 0.3;
            } else {
              size = Math.random() * 2.5 + 1.5;
              brightness = Math.random() * 0.9 + 0.4;
              speed = Math.random() * 0.5 + 0.2;
            }
            
            this.particles.push({
              x: Math.random() * this.canvas.width,
              y: Math.random() * this.canvas.height,
              size: size,
              baseSize: size,
              brightness: Math.min(brightness, 1),
              baseBrightness: Math.min(brightness, 1),
              color: this.getColor(),
              speedY: speed,
              wobblePhase: Math.random() * Math.PI * 2,
              pulsePhase: Math.random() * Math.PI * 2
            });
          }
        }

        getColor() {
          const colors = [
            { r: 180, g: 30, b: 220 },   // Magenta
            { r: 140, g: 20, b: 200 },   // Purple
            { r: 220, g: 50, b: 180 },   // Pink
            { r: 160, g: 40, b: 240 },   // Violet
            { r: 200, g: 60, b: 200 },   // Bright magenta
            { r: 120, g: 30, b: 180 },   // Deep purple
          ];
          const c = colors[Math.floor(Math.random() * colors.length)];
          return { r: c.r + Math.random() * 30 - 15, g: c.g + Math.random() * 20 - 10, b: c.b + Math.random() * 30 - 15 };
        }

        update() {
          this.time += 0.01;
          
          // Update clouds
          this.clouds.forEach(cloud => {
            cloud.y += cloud.speedY * this.verticalSpeed;
            cloud.x += Math.sin(this.time * cloud.wobbleSpeed + cloud.wobblePhase) * 0.5;
            
            if (cloud.y - cloud.size > this.canvas.height) {
              cloud.y = -cloud.size;
              cloud.x = Math.random() * this.canvas.width;
            }
          });
          
          // Update particles
          this.particles.forEach(p => {
            // Flow field movement
            const flow = this.flowNoise(p.x, p.y, this.time);
            
            p.x += flow * 1.5;
            p.y += p.speedY * this.verticalSpeed;
            
            // Pulse effect
            const pulse = Math.sin(this.time * 2 + p.pulsePhase);
            p.currentSize = p.baseSize * (0.7 + 0.3 * pulse);
            p.currentBrightness = p.baseBrightness * (0.5 + 0.5 * pulse);
            
            // Wrap around
            if (p.y > this.canvas.height + 20) {
              p.y = -20;
              p.x = Math.random() * this.canvas.width;
            }
            if (p.x < -50) p.x = this.canvas.width + 50;
            if (p.x > this.canvas.width + 50) p.x = -50;
          });
        }

        render() {
          // Clear with dark background
          this.ctx.fillStyle = '#030108';
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
          
          // Background ambient glow
          const bgGlow = this.ctx.createRadialGradient(
            this.canvas.width * 0.5, this.canvas.height * 0.5, 0,
            this.canvas.width * 0.5, this.canvas.height * 0.5, this.canvas.width * 0.7
          );
          bgGlow.addColorStop(0, 'rgba(80, 20, 120, 0.2)');
          bgGlow.addColorStop(0.5, 'rgba(50, 10, 80, 0.1)');
          bgGlow.addColorStop(1, 'transparent');
          this.ctx.fillStyle = bgGlow;
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
          
          // Draw clouds (nebula gas)
          this.ctx.globalCompositeOperation = 'screen';
          
          this.clouds.forEach(cloud => {
            const gradient = this.ctx.createRadialGradient(
              cloud.x, cloud.y, 0,
              cloud.x, cloud.y, cloud.size
            );
            gradient.addColorStop(0, `rgba(${cloud.color.r}, ${cloud.color.g}, ${cloud.color.b}, ${cloud.opacity})`);
            gradient.addColorStop(0.4, `rgba(${cloud.color.r}, ${cloud.color.g}, ${cloud.color.b}, ${cloud.opacity * 0.5})`);
            gradient.addColorStop(0.7, `rgba(${cloud.color.r * 0.8}, ${cloud.color.g * 0.8}, ${cloud.color.b}, ${cloud.opacity * 0.2})`);
            gradient.addColorStop(1, 'transparent');
            
            this.ctx.fillStyle = gradient;
            this.ctx.beginPath();
            this.ctx.arc(cloud.x, cloud.y, cloud.size, 0, Math.PI * 2);
            this.ctx.fill();
          });
          
          // Draw particles
          this.ctx.globalCompositeOperation = 'lighter';
          
          this.particles.forEach(p => {
            const r = Math.min(255, p.color.r + 60);
            const g = Math.min(255, p.color.g + 40);
            const b = Math.min(255, p.color.b + 40);
            
            // Glow for larger particles
            if (p.currentSize > 1.2) {
              const glowSize = p.currentSize * 5;
              const glow = this.ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, glowSize);
              glow.addColorStop(0, `rgba(${r}, ${g}, ${b}, ${p.currentBrightness * 0.4})`);
              glow.addColorStop(0.3, `rgba(${p.color.r}, ${p.color.g}, ${p.color.b}, ${p.currentBrightness * 0.15})`);
              glow.addColorStop(1, 'transparent');
              
              this.ctx.fillStyle = glow;
              this.ctx.beginPath();
              this.ctx.arc(p.x, p.y, glowSize, 0, Math.PI * 2);
              this.ctx.fill();
            }
            
            // Core particle
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, p.currentSize, 0, Math.PI * 2);
            this.ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${p.currentBrightness})`;
            this.ctx.fill();
          });
          
          this.ctx.globalCompositeOperation = 'source-over';
        }

        animate() {
          this.update();
          this.render();
          requestAnimationFrame(() => this.animate());
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('bg-particles');
        if (canvas) {
          new FlowingNebula(canvas);
        }
      });
    </script>
  </body>
</html>
