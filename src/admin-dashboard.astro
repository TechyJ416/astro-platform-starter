---
// src/pages/admin-dashboard.astro
import Layout from '../layouts/Layout.astro';

// In production, this would check for valid auth token
// const authToken = Astro.cookies.get('adminToken');
// if (!authToken) return Astro.redirect('/admin-portal-xy7k2');
---

<Layout title="Admin Dashboard">
    <style>
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--color-border);
        }
        
        .dashboard-title {
            font-family: var(--font-serif);
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .logout-btn {
            padding: 0.625rem 1.5rem;
            background: #ef4444;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .logout-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }
        
        .stat-card {
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }
        
        .stat-label {
            color: var(--color-muted);
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-family: var(--font-serif);
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--color-accent);
        }
        
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--color-border);
            overflow-x: auto;
        }
        
        .tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            font-weight: 600;
            font-size: 0.9375rem;
            color: var(--color-muted);
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }
        
        .tab:hover {
            color: var(--color-ink);
        }
        
        .tab.active {
            color: var(--color-accent);
            border-bottom-color: var(--color-accent);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
        }
        
        /* Mailing List Table */
        .table-container {
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--color-border);
        }
        
        .table-title {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .search-box {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .search-input {
            padding: 0.5rem 1rem;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 0.875rem;
            width: 250px;
        }
        
        .export-btn {
            padding: 0.5rem 1rem;
            background: var(--color-accent);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .export-btn:hover {
            background: #1d4ed8;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table thead {
            background: var(--color-paper);
        }
        
        .data-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--color-muted);
            border-bottom: 1px solid var(--color-border);
        }
        
        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--color-border);
            font-size: 0.9375rem;
        }
        
        .data-table tbody tr:hover {
            background: var(--color-paper);
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        /* Server Message Manager */
        .message-manager {
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 2rem;
        }
        
        .section-title {
            font-family: var(--font-serif);
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9375rem;
        }
        
        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: var(--font-sans);
            transition: all 0.2s;
        }
        
        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .button-group {
            display: flex;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--color-accent);
            color: white;
        }
        
        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: white;
            color: var(--color-ink);
            border: 2px solid var(--color-border);
        }
        
        .btn-secondary:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }
        
        .active-messages {
            margin-top: 2rem;
        }
        
        .message-item {
            background: var(--color-paper);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .message-content {
            flex: 1;
        }
        
        .message-type {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        
        .message-text {
            color: var(--color-muted);
            margin-bottom: 0.5rem;
        }
        
        .message-time {
            font-size: 0.875rem;
            color: var(--color-muted);
        }
        
        .delete-btn {
            padding: 0.5rem 1rem;
            background: #fee2e2;
            color: #991b1b;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .delete-btn:hover {
            background: #fecaca;
        }
        
        /* Inbox */
        .inbox-container {
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .inbox-item {
            padding: 1.5rem;
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .inbox-item:hover {
            background: var(--color-paper);
        }
        
        .inbox-item.unread {
            background: #eff6ff;
        }
        
        .inbox-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        
        .inbox-from {
            font-weight: 600;
            color: var(--color-ink);
        }
        
        .inbox-date {
            font-size: 0.875rem;
            color: var(--color-muted);
        }
        
        .inbox-subject {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .inbox-preview {
            color: var(--color-muted);
            font-size: 0.9375rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d1fae5;
            border: 2px solid #34d399;
            color: #065f46;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--color-muted);
        }
        
        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .table-header {
                flex-direction: column;
                gap: 1rem;
            }
            
            .search-box {
                width: 100%;
                flex-direction: column;
            }
            
            .search-input {
                width: 100%;
            }
            
            .button-group {
                flex-direction: column;
            }
        }
    </style>

    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">Admin Dashboard</h1>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Subscribers</div>
                <div class="stat-value" id="totalSubscribers">247</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Messages</div>
                <div class="stat-value" id="activeMessages">3</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Unread Inbox</div>
                <div class="stat-value" id="unreadInbox">12</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">New This Week</div>
                <div class="stat-value" id="newThisWeek">18</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="mailing-list">Mailing List</button>
            <button class="tab" data-tab="messages">Server Messages</button>
            <button class="tab" data-tab="inbox">Inbox</button>
        </div>

        <!-- Mailing List Tab -->
        <div class="tab-content active" id="mailing-list">
            <div class="table-container">
                <div class="table-header">
                    <h2 class="table-title">Email Subscribers</h2>
                    <div class="search-box">
                        <input 
                            type="text" 
                            class="search-input" 
                            placeholder="Search subscribers..."
                            id="searchInput"
                        />
                        <button class="export-btn" id="exportBtn">Export CSV</button>
                    </div>
                </div>
                <table class="data-table" id="subscribersTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Platform</th>
                            <th>Followers</th>
                            <th>Status</th>
                            <th>Joined</th>
                        </tr>
                    </thead>
                    <tbody id="subscribersBody">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Server Messages Tab -->
        <div class="tab-content" id="messages">
            <div class="message-manager">
                <h2 class="section-title">Create Server Message</h2>
                
                <div id="messageSuccess" class="alert alert-success" style="display: none;">
                    Message published successfully!
                </div>
                
                <form id="messageForm">
                    <div class="form-group">
                        <label for="messageType" class="form-label">Message Type</label>
                        <select id="messageType" class="form-select" required>
                            <option value="info">Info (Blue)</option>
                            <option value="success">Success (Green)</option>
                            <option value="warning">Warning (Yellow)</option>
                            <option value="error">Error (Red)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="messageText" class="form-label">Message Text</label>
                        <textarea 
                            id="messageText" 
                            class="form-textarea" 
                            placeholder="Enter your message..."
                            required
                        ></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="messageLink" class="form-label">Link (Optional)</label>
                        <input 
                            type="url" 
                            id="messageLink" 
                            class="form-input" 
                            placeholder="https://example.com"
                        />
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Publish Message</button>
                        <button type="button" class="btn btn-secondary" id="previewBtn">Preview</button>
                    </div>
                </form>
                
                <div class="active-messages">
                    <h3 class="section-title">Active Messages</h3>
                    <div id="activeMessagesList">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Inbox Tab -->
        <div class="tab-content" id="inbox">
            <div class="inbox-container">
                <div class="table-header">
                    <h2 class="table-title">Creator Inbox</h2>
                    <div class="search-box">
                        <input 
                            type="text" 
                            class="search-input" 
                            placeholder="Search messages..."
                            id="inboxSearchInput"
                        />
                    </div>
                </div>
                <div id="inboxList">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check authentication (in production, verify token on server)
        const authToken = sessionStorage.getItem('adminToken') || localStorage.getItem('adminToken');
        if (!authToken) {
            window.location.href = '/admin-portal-xy7k2';
        }

        // Mock data for demonstration
        const subscribers = [
            { name: 'Sarah Johnson', email: 'sarah@example.com', platform: 'Instagram', followers: '15k-50k', status: 'Subscribed', joined: '2025-12-01' },
            { name: 'Mike Chen', email: 'mike@example.com', platform: 'TikTok', followers: '50k-100k', status: 'Subscribed', joined: '2025-11-28' },
            { name: 'Emma Davis', email: 'emma@example.com', platform: 'YouTube', followers: '10k-50k', status: 'Subscribed', joined: '2025-11-25' },
            { name: 'James Wilson', email: 'james@example.com', platform: 'Instagram', followers: '1k-10k', status: 'Pending', joined: '2025-12-03' },
            { name: 'Lisa Anderson', email: 'lisa@example.com', platform: 'TikTok', followers: '100k-500k', status: 'Subscribed', joined: '2025-11-20' },
        ];

        let activeMessages = JSON.parse(localStorage.getItem('serverMessages') || '[]');
        
        const inboxMessages = [
            { id: 1, from: 'Sarah Johnson', subject: 'Question about campaign requirements', preview: 'Hi, I wanted to clarify the deliverables for...', date: '2 hours ago', unread: true },
            { id: 2, from: 'Mike Chen', subject: 'Payment inquiry', preview: 'When can I expect payment for the last campaign...', date: 'Yesterday', unread: true },
            { id: 3, from: 'Emma Davis', subject: 'New content idea', preview: 'I have an exciting content concept I\'d like to discuss...', date: '2 days ago', unread: false },
        ];

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Populate subscribers table
        function populateSubscribersTable(data = subscribers) {
            const tbody = document.getElementById('subscribersBody');
            tbody.innerHTML = data.map(sub => `
                <tr>
                    <td>${sub.name}</td>
                    <td>${sub.email}</td>
                    <td>${sub.platform}</td>
                    <td>${sub.followers}</td>
                    <td><span class="badge ${sub.status === 'Subscribed' ? 'badge-success' : 'badge-pending'}">${sub.status}</span></td>
                    <td>${sub.joined}</td>
                </tr>
            `).join('');
        }

        populateSubscribersTable();

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const search = e.target.value.toLowerCase();
            const filtered = subscribers.filter(sub => 
                sub.name.toLowerCase().includes(search) || 
                sub.email.toLowerCase().includes(search)
            );
            populateSubscribersTable(filtered);
        });

        // Export CSV
        document.getElementById('exportBtn').addEventListener('click', () => {
            const csv = [
                ['Name', 'Email', 'Platform', 'Followers', 'Status', 'Joined'],
                ...subscribers.map(s => [s.name, s.email, s.platform, s.followers, s.status, s.joined])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `subscribers-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        });

        // Server message form
        document.getElementById('messageForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const message = {
                id: Date.now(),
                type: document.getElementById('messageType').value,
                text: document.getElementById('messageText').value,
                link: document.getElementById('messageLink').value,
                created: new Date().toISOString()
            };
            
            activeMessages.push(message);
            localStorage.setItem('serverMessages', JSON.stringify(activeMessages));
            
            document.getElementById('messageSuccess').style.display = 'block';
            setTimeout(() => {
                document.getElementById('messageSuccess').style.display = 'none';
            }, 3000);
            
            document.getElementById('messageForm').reset();
            renderActiveMessages();
            updateStats();
        });

        // Render active messages
        function renderActiveMessages() {
            const container = document.getElementById('activeMessagesList');
            if (activeMessages.length === 0) {
                container.innerHTML = '<div class="empty-state">No active messages</div>';
                return;
            }
            
            container.innerHTML = activeMessages.map(msg => `
                <div class="message-item">
                    <div class="message-content">
                        <div class="message-type" style="color: ${getTypeColor(msg.type)}">${msg.type.toUpperCase()}</div>
                        <div class="message-text">${msg.text}</div>
                        ${msg.link ? `<div class="message-time">Link: ${msg.link}</div>` : ''}
                        <div class="message-time">Created: ${new Date(msg.created).toLocaleString()}</div>
                    </div>
                    <button class="delete-btn" onclick="deleteMessage(${msg.id})">Delete</button>
                </div>
            `).join('');
        }

        function getTypeColor(type) {
            const colors = {
                info: '#2563eb',
                success: '#059669',
                warning: '#d97706',
                error: '#dc2626'
            };
            return colors[type] || '#2563eb';
        }

        window.deleteMessage = (id) => {
            activeMessages = activeMessages.filter(m => m.id !== id);
            localStorage.setItem('serverMessages', JSON.stringify(activeMessages));
            renderActiveMessages();
            updateStats();
        };

        renderActiveMessages();

        // Populate inbox
        function populateInbox() {
            const container = document.getElementById('inboxList');
            container.innerHTML = inboxMessages.map(msg => `
                <div class="inbox-item ${msg.unread ? 'unread' : ''}" onclick="openMessage(${msg.id})">
                    <div class="inbox-header">
                        <span class="inbox-from">${msg.from}</span>
                        <span class="inbox-date">${msg.date}</span>
                    </div>
                    <div class="inbox-subject">${msg.subject}</div>
                    <div class="inbox-preview">${msg.preview}</div>
                </div>
            `).join('');
        }

        window.openMessage = (id) => {
            alert(`Opening message ${id}. In production, this would open a full message view.`);
        };

        populateInbox();

        // Update stats
        function updateStats() {
            document.getElementById('totalSubscribers').textContent = subscribers.length;
            document.getElementById('activeMessages').textContent = activeMessages.length;
            document.getElementById('unreadInbox').textContent = inboxMessages.filter(m => m.unread).length;
        }

        updateStats();

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            sessionStorage.removeItem('adminToken');
            localStorage.removeItem('adminToken');
            window.location.href = '/admin-portal-xy7k2';
        });

        // Inbox search
        document.getElementById('inboxSearchInput').addEventListener('input', (e) => {
            const search = e.target.value.toLowerCase();
            document.querySelectorAll('.inbox-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(search) ? 'block' : 'none';
            });
        });
    </script>
</Layout>
