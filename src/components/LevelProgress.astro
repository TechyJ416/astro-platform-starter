---
// src/components/LevelProgress.astro
// Shows level progress bar with EXP details

interface Props {
  currentExp: number;
  currentLevel: number;
  showDetails?: boolean;
}

const { currentExp, currentLevel, showDetails = true } = Astro.props;

// Level definitions
const LEVELS: Record<number, { title: string; multiplier: number; color: string; icon: string; expRequired: number }> = {
  10: { title: 'Recruit', multiplier: 1.0, color: '#6b7280', icon: '⬡', expRequired: 10 },
  20: { title: 'Digital Scout', multiplier: 1.1, color: '#8b5cf6', icon: '⬢', expRequired: 20 },
  30: { title: 'Digital Specialist', multiplier: 1.1, color: '#a855f7', icon: '◈', expRequired: 30 },
  40: { title: 'Ops Enforcer', multiplier: 1.2, color: '#c026d3', icon: '◆', expRequired: 40 },
  50: { title: 'Tactical Uplink', multiplier: 1.2, color: '#d946ef', icon: '⬣', expRequired: 50 },
  60: { title: 'Network Commander', multiplier: 1.3, color: '#ec4899', icon: '✦', expRequired: 60 },
  70: { title: 'Digital General', multiplier: 1.3, color: '#f43f5e', icon: '★', expRequired: 70 },
  80: { title: 'Campaign Marshal', multiplier: 1.4, color: '#f59e0b', icon: '✪', expRequired: 80 },
  90: { title: 'Digital Warlord', multiplier: 1.4, color: '#eab308', icon: '⚔', expRequired: 90 },
  100: { title: '5 Star Digital General', multiplier: 1.5, color: '#fbbf24', icon: '⭐', expRequired: 100 },
};

const levelKeys = Object.keys(LEVELS).map(Number).sort((a, b) => a - b);

const currentLevelInfo = LEVELS[currentLevel] || LEVELS[10];
const currentLevelIndex = levelKeys.indexOf(currentLevel);
const nextLevelKey = currentLevelIndex < levelKeys.length - 1 ? levelKeys[currentLevelIndex + 1] : null;
const nextLevelInfo = nextLevelKey ? LEVELS[nextLevelKey] : null;

const isMaxLevel = currentLevel >= 100;

// Calculate progress
let progress = 100;
let expToNext = 0;

if (!isMaxLevel && nextLevelInfo) {
  const expInCurrentLevel = currentExp - currentLevelInfo.expRequired;
  const expNeededForNext = nextLevelInfo.expRequired - currentLevelInfo.expRequired;
  progress = Math.min(100, Math.round((expInCurrentLevel / expNeededForNext) * 100));
  expToNext = nextLevelInfo.expRequired - currentExp;
}
---

<div class="level-progress" style={`--current-color: ${currentLevelInfo.color}; --next-color: ${nextLevelInfo?.color || currentLevelInfo.color};`}>
  <div class="progress-header">
    <div class="current-rank">
      <span class="rank-icon">{currentLevelInfo.icon}</span>
      <div class="rank-info">
        <span class="rank-title">{currentLevelInfo.title}</span>
        <span class="rank-level">Level {currentLevel}</span>
      </div>
    </div>
    
    {!isMaxLevel && nextLevelInfo && (
      <div class="next-rank">
        <span class="next-label">Next:</span>
        <span class="next-title">{nextLevelInfo.title}</span>
        <span class="next-icon">{nextLevelInfo.icon}</span>
      </div>
    )}
    
    {isMaxLevel && (
      <div class="max-rank">
        <span class="max-label">⭐ MAX RANK ⭐</span>
      </div>
    )}
  </div>

  <div class="progress-bar-container">
    <div class="progress-bar" style={`width: ${progress}%`}>
      {progress > 15 && <span class="progress-text">{progress}%</span>}
    </div>
    {progress <= 15 && <span class="progress-text-outside">{progress}%</span>}
  </div>

  {showDetails && (
    <div class="progress-details">
      <div class="detail-item">
        <span class="detail-label">Current EXP</span>
        <span class="detail-value">{currentExp} / 100</span>
      </div>
      
      {!isMaxLevel && (
        <div class="detail-item">
          <span class="detail-label">EXP to Next</span>
          <span class="detail-value">{expToNext} EXP</span>
        </div>
      )}
      
      <div class="detail-item multiplier">
        <span class="detail-label">Multiplier</span>
        <span class="detail-value">{currentLevelInfo.multiplier.toFixed(1)}x</span>
      </div>
    </div>
  )}

  {showDetails && (
    <div class="level-roadmap">
      <span class="roadmap-label">Rank Progression</span>
      <div class="roadmap-track">
        {levelKeys.map((lvl) => {
          const info = LEVELS[lvl];
          const isComplete = currentExp >= info.expRequired;
          const isCurrent = lvl === currentLevel;
          
          return (
            <div 
              class={`roadmap-node ${isComplete ? 'complete' : ''} ${isCurrent ? 'current' : ''}`}
              style={`--node-color: ${info.color};`}
              title={`${info.title} - ${info.expRequired} EXP`}
            >
              <span class="node-icon">{info.icon}</span>
              <span class="node-level">{lvl}</span>
            </div>
          );
        })}
      </div>
    </div>
  )}
</div>

<style>
  .level-progress {
    background: linear-gradient(135deg, rgba(26, 16, 37, 0.8), rgba(10, 5, 16, 0.8));
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: 16px;
    padding: 1.5rem;
  }

  .progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .current-rank {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .rank-icon {
    font-size: 2rem;
    color: var(--current-color);
    text-shadow: 0 0 20px var(--current-color);
  }

  .rank-info {
    display: flex;
    flex-direction: column;
  }

  .rank-title {
    font-weight: 700;
    font-size: 1.125rem;
    color: #f8fafc;
  }

  .rank-level {
    font-family: 'Space Mono', monospace;
    font-size: 0.75rem;
    color: var(--current-color);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .next-rank {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.875rem;
  }

  .next-label {
    color: rgba(255, 255, 255, 0.4);
  }

  .next-title {
    color: var(--next-color);
    font-weight: 600;
  }

  .next-icon {
    color: var(--next-color);
    opacity: 0.6;
  }

  .max-rank {
    background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
    padding: 0.375rem 0.875rem;
    border-radius: 100px;
    border: 1px solid rgba(251, 191, 36, 0.4);
  }

  .max-label {
    font-weight: 700;
    font-size: 0.75rem;
    color: #fbbf24;
    letter-spacing: 0.1em;
  }

  .progress-bar-container {
    position: relative;
    height: 24px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 100px;
    overflow: hidden;
    margin-bottom: 1rem;
  }

  .progress-bar {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    background: linear-gradient(90deg, var(--current-color), var(--next-color));
    border-radius: 100px;
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 0.75rem;
  }

  .progress-text {
    font-family: 'Space Mono', monospace;
    font-size: 0.75rem;
    font-weight: 700;
    color: white;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  }

  .progress-text-outside {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    font-family: 'Space Mono', monospace;
    font-size: 0.75rem;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.5);
  }

  .progress-details {
    display: flex;
    gap: 1.5rem;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    margin-bottom: 1rem;
  }

  .detail-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .detail-label {
    font-size: 0.6875rem;
    color: rgba(255, 255, 255, 0.4);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .detail-value {
    font-family: 'Space Mono', monospace;
    font-size: 0.9375rem;
    font-weight: 600;
    color: #f8fafc;
  }

  .detail-item.multiplier .detail-value {
    color: var(--current-color);
  }

  .level-roadmap {
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
  }

  .roadmap-label {
    display: block;
    font-size: 0.6875rem;
    color: rgba(255, 255, 255, 0.4);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.75rem;
  }

  .roadmap-track {
    display: flex;
    justify-content: space-between;
    gap: 0.25rem;
  }

  .roadmap-node {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    padding: 0.375rem 0.5rem;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.03);
    opacity: 0.4;
    transition: all 0.3s;
    cursor: default;
  }

  .roadmap-node.complete {
    opacity: 0.7;
    background: color-mix(in srgb, var(--node-color) 15%, transparent);
  }

  .roadmap-node.current {
    opacity: 1;
    background: color-mix(in srgb, var(--node-color) 25%, transparent);
    border: 1px solid var(--node-color);
    box-shadow: 0 0 15px color-mix(in srgb, var(--node-color) 30%, transparent);
  }

  .node-icon {
    font-size: 0.875rem;
    color: var(--node-color);
  }

  .node-level {
    font-family: 'Space Mono', monospace;
    font-size: 0.625rem;
    color: rgba(255, 255, 255, 0.6);
  }

  .roadmap-node.current .node-level {
    color: var(--node-color);
  }

  @media (max-width: 640px) {
    .progress-details {
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .roadmap-node {
      padding: 0.25rem;
    }
    
    .node-icon {
      font-size: 0.75rem;
    }
    
    .node-level {
      display: none;
    }
  }
</style>
