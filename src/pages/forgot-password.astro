---
// src/pages/forgot-password.astro
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";

let error = '';
let success = false;

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const email = formData.get('email') as string;

  if (!email) {
    error = 'Please enter your email address.';
  } else {
    // Use Supabase's built-in password reset
    const { error: resetError } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: `${Astro.url.origin}/reset-password`,
    });

    if (resetError) {
      // Don't reveal if email exists or not for security
      console.error('Password reset error:', resetError);
    }
    
    // Always show success to prevent email enumeration
    success = true;
  }
}
---

<Layout title="Reset Password">
  <div class="forgot-page">
    <div class="forgot-container">
      {success ? (
        <div class="success-card">
          <div class="success-icon">ðŸ“§</div>
          <h1>Check Your Email</h1>
          <p>If an account exists with that email, we've sent password reset instructions.</p>
          <p class="subtext">The link will expire in 1 hour. Don't forget to check your spam folder!</p>
          <div class="card-actions">
            <a href="/login" class="btn btn-primary">Back to Login</a>
          </div>
        </div>
      ) : (
        <div class="forgot-card">
          <div class="card-header">
            <h1>Forgot Password?</h1>
            <p>No worries! Enter your email and we'll send you reset instructions.</p>
          </div>

          {error && <div class="alert error">{error}</div>}

          <form method="POST" class="forgot-form">
            <div class="form-group">
              <label for="email">Email Address</label>
              <input 
                type="email" 
                id="email" 
                name="email" 
                placeholder="you@example.com"
                required
                autocomplete="email"
              />
            </div>

            <button type="submit" class="btn btn-primary btn-full">Send Reset Link</button>
          </form>

          <div class="card-footer">
            <p>Remember your password? <a href="/login">Log in</a></p>
          </div>
        </div>
      )}
    </div>
  </div>

  <style>
    .forgot-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
    }

    .forgot-container {
      width: 100%;
      max-width: 420px;
    }

    .forgot-card, .success-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .card-header {
      padding: 2rem 2rem 0;
      text-align: center;
    }

    .card-header h1 {
      font-size: 1.75rem;
      color: #1a1a2e;
      margin-bottom: 0.5rem;
    }

    .card-header p {
      color: #6b7280;
      font-size: 0.9375rem;
    }

    .forgot-form {
      padding: 1.5rem 2rem 2rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
    }

    .form-group input {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .btn {
      padding: 0.875rem 1.5rem;
      border-radius: 10px;
      font-weight: 600;
      font-size: 1rem;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-full {
      width: 100%;
    }

    .card-footer {
      padding: 1.5rem 2rem;
      background: #f9fafb;
      text-align: center;
      font-size: 0.9375rem;
      color: #6b7280;
    }

    .card-footer a {
      color: #2563eb;
      text-decoration: none;
      font-weight: 600;
    }

    .card-footer a:hover {
      text-decoration: underline;
    }

    .alert {
      margin: 1.5rem 2rem 0;
      padding: 1rem;
      border-radius: 10px;
      font-size: 0.9375rem;
    }

    .alert.error {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Success Card */
    .success-card {
      padding: 3rem 2rem;
      text-align: center;
    }

    .success-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .success-card h1 {
      font-size: 1.5rem;
      color: #1a1a2e;
      margin-bottom: 1rem;
    }

    .success-card p {
      color: #374151;
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }

    .success-card .subtext {
      color: #6b7280;
      font-size: 0.9375rem;
    }

    .card-actions {
      margin-top: 1.5rem;
    }
  </style>
</Layout>
