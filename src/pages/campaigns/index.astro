---
// src/pages/campaigns/index.astro
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabase";

const session = Astro.locals.session;
const profile = Astro.locals.profile;

const isApproved = profile?.status === 'active' && profile?.is_active;

const { data: campaignsRaw } = await supabase
  .from('campaigns')
  .select('id, title, slug, description, budget, payment_per_post, deadline, status')
  .eq('status', 'active')
  .order('created_at', { ascending: false });

const campaigns = (campaignsRaw || []).map(campaign => {
  let daysRemaining = null;
  let isUrgent = false;
  let isExpired = false;
  
  if (campaign.deadline) {
    const deadlineDate = new Date(campaign.deadline);
    const now = Date.now();
    daysRemaining = Math.ceil((deadlineDate.getTime() - now) / (1000 * 60 * 60 * 24));
    isUrgent = daysRemaining >= 1 && daysRemaining <= 7;
    isExpired = daysRemaining < 1;
  }
  
  return { ...campaign, daysRemaining, isUrgent, isExpired };
});
---

<Layout title="Campaigns">
  <div class="campaigns-page">
    <div class="page-header">
      <div class="header-content">
        <span class="header-label"><span class="label-line"></span> Browse Opportunities</span>
        <h1>Active Campaigns</h1>
        <p>Find brand collaborations that match your style and start earning</p>
      </div>
      {!session && (
        <a href="/signup" class="btn btn-primary">Join to Apply</a>
      )}
    </div>

    {!session && (
      <div class="info-banner">
        <div class="banner-icon">üí°</div>
        <div class="banner-content">
          <h3>How It Works</h3>
          <p>Create an account, get approved, and start applying to campaigns. Earn money creating authentic content for brands you love.</p>
        </div>
        <div class="banner-actions">
          <a href="/signup" class="btn btn-primary">Get Started</a>
        </div>
      </div>
    )}

    {session && !isApproved && (
      <div class="pending-banner">
        <div class="banner-icon">‚è≥</div>
        <div class="banner-content">
          <h3>Account Pending Approval</h3>
          <p>You can browse campaigns, but you'll need an approved account to apply. We'll notify you once approved.</p>
        </div>
      </div>
    )}

    {campaigns && campaigns.length > 0 ? (
      <div class="campaigns-grid">
        {campaigns.map((campaign, index) => (
          <div class={`campaign-card ${campaign.isUrgent ? 'urgent' : ''} ${campaign.isExpired ? 'expired' : ''}`} style={`--delay: ${index * 0.1}s`}>
            <div class="card-glow"></div>
            <div class="card-content">
              <div class="card-header">
                <span class="status-badge">‚óè Active</span>
                {campaign.payment_per_post && (
                  <span class="card-payout">${campaign.payment_per_post}</span>
                )}
              </div>
              
              <h2 class="card-title">{campaign.title}</h2>
              
              {campaign.description && (
                <p class="card-desc">
                  {campaign.description.substring(0, 150)}{campaign.description.length > 150 ? '...' : ''}
                </p>
              )}
              
              <div class="card-meta">
                {campaign.budget && (
                  <span class="meta-item">
                    <span class="meta-icon">‚óá</span>
                    ${campaign.budget} budget
                  </span>
                )}
                
                {campaign.deadline && (
                  <span class={`meta-item ${campaign.isUrgent ? 'urgent' : ''} ${campaign.isExpired ? 'expired' : ''}`}>
                    <span class="meta-icon">‚óá</span>
                    {campaign.isExpired ? (
                      <span class="expired-text">Ended</span>
                    ) : campaign.isUrgent ? (
                      <span class="urgent-text">{campaign.daysRemaining} days left!</span>
                    ) : (
                      <span>Ends {new Date(campaign.deadline).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                    )}
                  </span>
                )}
              </div>
              
              <div class="card-footer">
                {isApproved ? (
                  <a href={`/campaigns/${campaign.slug}`} class="card-btn">
                    View & Apply ‚Üí
                  </a>
                ) : session ? (
                  <span class="card-btn disabled">Account Pending</span>
                ) : (
                  <a href="/signup" class="card-btn">
                    Sign Up to Apply ‚Üí
                  </a>
                )}
                
                {campaign.isUrgent && !campaign.isExpired && (
                  <span class="urgency-badge">‚ö° Ending Soon</span>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>
    ) : (
      <div class="empty-state">
        <div class="empty-icon">üì¢</div>
        <h2>No Active Campaigns</h2>
        <p>Check back soon! New campaigns are added regularly.</p>
        {!session && (
          <a href="/signup" class="btn btn-primary">Join the Waitlist</a>
        )}
      </div>
    )}

    {!session && (
      <section class="how-it-works">
        <div class="section-header">
          <span class="header-label"><span class="label-line"></span> The Process <span class="label-line"></span></span>
          <h2>Start Earning as a Creator</h2>
        </div>
        <div class="steps">
          <div class="step">
            <div class="step-number">01</div>
            <h3>Create Account</h3>
            <p>Sign up and join our waitlist for approval.</p>
          </div>
          <div class="step">
            <div class="step-number">02</div>
            <h3>Get Approved</h3>
            <p>Our team reviews your application.</p>
          </div>
          <div class="step">
            <div class="step-number">03</div>
            <h3>Apply to Campaigns</h3>
            <p>Browse and apply to campaigns that fit your style.</p>
          </div>
          <div class="step">
            <div class="step-number">04</div>
            <h3>Create & Earn</h3>
            <p>Submit your content and get paid!</p>
          </div>
        </div>
      </section>
    )}
  </div>

  <style>
    .campaigns-page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 3rem;
      gap: 2rem;
    }

    .header-label {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      font-size: 0.8125rem;
      color: var(--cosmic-blue);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      font-weight: 600;
    }

    .label-line {
      width: 30px;
      height: 1px;
      background: var(--cosmic-blue);
    }

    .header-content h1 {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--star-white);
      margin-bottom: 0.5rem;
      letter-spacing: -0.02em;
    }

    .header-content p {
      color: var(--star-dim);
      font-size: 1.125rem;
    }

    .info-banner, .pending-banner {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      padding: 1.5rem;
      border-radius: 16px;
      margin-bottom: 2rem;
      backdrop-filter: blur(10px);
    }

    .info-banner {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .pending-banner {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05));
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .banner-icon {
      font-size: 2.5rem;
    }

    .banner-content {
      flex: 1;
    }

    .banner-content h3 {
      font-size: 1.125rem;
      color: var(--star-white);
      margin-bottom: 0.25rem;
    }

    .banner-content p {
      color: var(--star-dim);
      margin: 0;
    }

    .campaigns-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 1.5rem;
    }

    .campaign-card {
      position: relative;
      background: linear-gradient(135deg, rgba(26, 26, 46, 0.8), rgba(8, 8, 18, 0.8));
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 20px;
      overflow: hidden;
      animation: card-in 0.6s ease-out var(--delay) backwards;
      transition: all 0.4s;
    }

    @keyframes card-in {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .campaign-card:hover {
      transform: translateY(-6px);
      border-color: rgba(79, 139, 255, 0.3);
    }

    .campaign-card.urgent {
      border-color: rgba(245, 158, 11, 0.4);
    }

    .campaign-card.expired {
      opacity: 0.6;
    }

    .card-glow {
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, var(--glow-blue) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.4s;
      pointer-events: none;
    }

    .campaign-card:hover .card-glow {
      opacity: 0.08;
    }

    .card-content {
      position: relative;
      padding: 1.5rem;
      z-index: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .status-badge {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--success);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .card-payout {
      font-family: var(--font-mono);
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--cosmic-cyan);
    }

    .card-title {
      font-size: 1.375rem;
      font-weight: 700;
      color: var(--star-white);
      margin-bottom: 0.75rem;
      line-height: 1.3;
    }

    .card-desc {
      color: var(--star-dim);
      font-size: 0.9375rem;
      line-height: 1.6;
      margin-bottom: 1.25rem;
      flex: 1;
    }

    .card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8125rem;
      color: var(--star-dim);
    }

    .meta-icon {
      color: var(--cosmic-purple);
      font-size: 0.625rem;
    }

    .meta-item.urgent .meta-icon { color: var(--warning); }
    .meta-item.expired .meta-icon { color: var(--danger); }
    .urgent-text { color: var(--warning); font-weight: 600; }
    .expired-text { color: var(--danger); font-weight: 600; }

    .card-footer {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding-top: 1.25rem;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .card-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
      padding: 0.875rem 1.25rem;
      background: linear-gradient(135deg, rgba(79, 139, 255, 0.2), rgba(168, 85, 247, 0.2));
      border: 1px solid rgba(79, 139, 255, 0.3);
      border-radius: 12px;
      color: var(--star-white);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9375rem;
      transition: all 0.3s;
    }

    .card-btn:hover {
      background: linear-gradient(135deg, var(--cosmic-blue), var(--cosmic-purple));
      border-color: transparent;
    }

    .card-btn.disabled {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
      color: var(--star-muted);
      cursor: not-allowed;
    }

    .urgency-badge {
      font-size: 0.75rem;
      padding: 0.375rem 0.75rem;
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: var(--warning);
      border-radius: 999px;
      font-weight: 600;
      white-space: nowrap;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      background: linear-gradient(135deg, rgba(26, 26, 46, 0.6), rgba(8, 8, 18, 0.6));
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 20px;
    }

    .empty-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .empty-state h2 {
      color: var(--star-white);
      margin-bottom: 0.5rem;
    }

    .empty-state p {
      color: var(--star-dim);
      margin-bottom: 1.5rem;
    }

    /* How it works */
    .how-it-works {
      margin-top: 5rem;
      padding: 3rem;
      background: linear-gradient(135deg, rgba(26, 26, 46, 0.5), rgba(8, 8, 18, 0.5));
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 24px;
      backdrop-filter: blur(10px);
    }

    .how-it-works .section-header {
      text-align: center;
      margin-bottom: 3rem;
    }

    .how-it-works .section-header .header-label {
      justify-content: center;
    }

    .how-it-works h2 {
      font-size: 1.75rem;
      color: var(--star-white);
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    .steps {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 2rem;
    }

    .step {
      text-align: center;
    }

    .step-number {
      font-family: var(--font-mono);
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--cosmic-blue);
      margin-bottom: 1rem;
      letter-spacing: 0.1em;
    }

    .step h3 {
      font-size: 1rem;
      color: var(--star-white);
      margin-bottom: 0.5rem;
      font-weight: 700;
    }

    .step p {
      font-size: 0.875rem;
      color: var(--star-dim);
      line-height: 1.6;
    }

    @media (max-width: 768px) {
      .page-header {
        flex-direction: column;
      }

      .info-banner, .pending-banner {
        flex-direction: column;
        text-align: center;
      }

      .banner-actions {
        width: 100%;
      }

      .banner-actions .btn {
        width: 100%;
        justify-content: center;
      }

      .campaigns-grid {
        grid-template-columns: 1fr;
      }

      .steps {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 480px) {
      .steps {
        grid-template-columns: 1fr;
      }
    }
  </style>
</Layout>
