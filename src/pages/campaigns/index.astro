---
// src/pages/campaigns/index.astro
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabase";

const session = Astro.locals.session;
const profile = Astro.locals.profile;

const isApproved = profile?.status === 'active' && profile?.is_active;

// Fetch active campaigns
const { data: campaigns } = await supabase
  .from('campaigns')
  .select('id, title, slug, description, budget, payment_per_post, deadline, status')
  .eq('status', 'active')
  .order('created_at', { ascending: false });

// Calculate days remaining for deadline
function getDaysRemaining(deadline: string) {
  if (!deadline) return null;
  return Math.ceil(
    (new Date(deadline).getTime() - Date.now()) / (1000 * 60 * 60 * 24)
  );
}
---

<Layout title="Campaigns">
  <div class="campaigns-page">

    <div class="page-header">
      <div class="header-content">
        <h1>Active Campaigns</h1>
        <p>Browse and apply to brand campaigns that match your style</p>
      </div>
      {!session && <a href="/signup" class="btn btn-primary">Join to Apply</a>}
    </div>

    {!session && (
      <div class="info-banner">
        <div class="banner-icon">üí°</div>
        <div class="banner-content">
          <h3>How It Works</h3>
          <p>Create an account, get approved, and start applying to campaigns.</p>
        </div>
        <a href="/signup" class="btn btn-primary">Get Started</a>
      </div>
    )}

    {session && !isApproved && (
      <div class="pending-banner">
        <div class="banner-icon">‚è≥</div>
        <div class="banner-content">
          <h3>Account Pending Approval</h3>
          <p>You can browse campaigns, but approval is required to apply.</p>
        </div>
      </div>
    )}

    {campaigns && campaigns.length > 0 ? (
      <div class="campaigns-grid">
        {campaigns.map((campaign) => {
          const daysRemaining = getDaysRemaining(campaign.deadline);
          const isUrgent = daysRemaining !== null && daysRemaining <= 7 && daysRemaining >= 1;
          const isExpired = daysRemaining !== null && daysRemaining < 1;

          return (
            <div class={`campaign-card ${isUrgent ? 'urgent' : ''} ${isExpired ? 'expired' : ''}`}>

              {campaign.description && (
                <p class="campaign-desc">
                  {campaign.description.slice(0, 150)}
                  {campaign.description.length > 150 && '...'}
                </p>
              )}

              <div class="campaign-meta">
                {campaign.payment_per_post && (
                  <div class="meta-item payment">
                    <span>üí∞</span>
                    <strong>${campaign.payment_per_post}</strong>
                    <small>per post</small>
                  </div>
                )}

                {campaign.budget && (
                  <div class="meta-item">
                    <span>üíµ</span>
                    <strong>${campaign.budget}</strong>
                    <small>budget</small>
                  </div>
                )}

                {campaign.deadline && (
                  <div class={`meta-item ${isUrgent ? 'urgent' : ''} ${isExpired ? 'expired' : ''}`}>
                    <span>üìÖ</span>
                    {isExpired ? (
                      <strong class="expired">Ended</strong>
                    ) : isUrgent ? (
                      <strong class="urgent">{daysRemaining} days left!</strong>
                    ) : (
                      <strong>{new Date(campaign.deadline).toLocaleDateString()}</strong>
                    )}
                  </div>
                )}
              </div>

              <div class="campaign-footer">
                {isApproved ? (
                  <a href={`/campaigns/${campaign.slug}`} class="btn btn-primary">
                    View & Apply
                  </a>
                ) : session ? (
                  <button class="btn btn-disabled" disabled>
                    Account Pending
                  </button>
                ) : (
                  <a href="/signup" class="btn btn-secondary">
                    Sign Up to Apply
                  </a>
                )}

                {isUrgent && !isExpired && (
                  <span class="urgency-badge">‚ö° Ending Soon</span>
                )}
              </div>

            </div>
          );
        })}
      </div>
    ) : (
      <div class="empty-state">
        <div class="empty-icon">üì¢</div>
        <h2>No Active Campaigns</h2>
        <p>Check back soon! New campaigns are added regularly.</p>
        {!session && <a href="/signup" class="btn btn-primary">Join the Waitlist</a>}
      </div>
    )}

  </div>
</Layout>
