---
// src/pages/campaigns/index.astro
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import { createClient } from "@supabase/supabase-js";

const session = Astro.locals.session;
const profile = Astro.locals.profile;

const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.SUPABASE_SERVICE_KEY || import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
  { auth: { autoRefreshToken: false, persistSession: false } }
);

// Get query params
const url = new URL(Astro.request.url);
const category = url.searchParams.get('category') || '';
const search = url.searchParams.get('search') || '';
const sort = url.searchParams.get('sort') || 'newest';

// Build query
let query = supabase
  .from('campaigns')
  .select(`
    *,
    manager:profiles!campaigns_manager_id_fkey(id, full_name, username, avatar_url)
  `)
  .eq('status', 'active');

if (category) {
  query = query.eq('category', category);
}

if (search) {
  query = query.ilike('title', `%${search}%`);
}

// Sorting
if (sort === 'newest') {
  query = query.order('created_at', { ascending: false });
} else if (sort === 'pay-high') {
  query = query.order('payment_per_post', { ascending: false, nullsFirst: false });
} else if (sort === 'deadline') {
  query = query.order('deadline', { ascending: true, nullsFirst: false });
}

const { data: campaigns } = await query;

// Get user's existing applications
let userApplications: Record<string, string> = {};
if (session && profile) {
  const { data: apps } = await supabase
    .from('applications')
    .select('campaign_id, status')
    .eq('creator_id', profile.id);
  
  if (apps) {
    apps.forEach(app => {
      userApplications[app.campaign_id] = app.status;
    });
  }
}

const categories = [
  { value: '', label: 'All Categories' },
  { value: 'fashion', label: 'Fashion & Beauty' },
  { value: 'tech', label: 'Technology' },
  { value: 'food', label: 'Food & Beverage' },
  { value: 'lifestyle', label: 'Lifestyle' },
  { value: 'fitness', label: 'Health & Fitness' },
  { value: 'travel', label: 'Travel' },
  { value: 'gaming', label: 'Gaming' },
  { value: 'entertainment', label: 'Entertainment' },
  { value: 'education', label: 'Education' },
  { value: 'other', label: 'Other' },
];
---

<Layout title="Browse Campaigns">
  <div class="campaigns-page">
    <!-- Hero -->
    <div class="hero">
      <div class="hero-content">
        <h1>Find Your Next Campaign</h1>
        <p>Browse opportunities from top brands and start earning</p>
        
        <!-- Search -->
        <form method="GET" class="search-form">
          <input type="hidden" name="category" value={category} />
          <input type="hidden" name="sort" value={sort} />
          <div class="search-input">
            <input 
              type="text" 
              name="search" 
              placeholder="Search campaigns..." 
              value={search}
            />
            <button type="submit">üîç</button>
          </div>
        </form>
      </div>
    </div>

    <div class="page-content">
      <!-- Filters -->
      <div class="filters-bar">
        <div class="filter-group">
          <label>Category:</label>
          <select id="category-filter">
            {categories.map(cat => (
              <option value={cat.value} selected={category === cat.value}>{cat.label}</option>
            ))}
          </select>
        </div>
        
        <div class="filter-group">
          <label>Sort by:</label>
          <select id="sort-filter">
            <option value="newest" selected={sort === 'newest'}>Newest First</option>
            <option value="pay-high" selected={sort === 'pay-high'}>Highest Pay</option>
            <option value="deadline" selected={sort === 'deadline'}>Deadline Soon</option>
          </select>
        </div>

        <span class="results-count">{campaigns?.length || 0} campaigns</span>
      </div>

      <!-- Campaigns Grid -->
      {campaigns && campaigns.length > 0 ? (
        <div class="campaigns-grid">
          {campaigns.map(campaign => {
            const paymentAmount = campaign.payment_per_post || campaign.payout_per_post || campaign.budget_per_creator || 0;
            const applicationStatus = userApplications[campaign.id];
            
            return (
              <a href={`/campaigns/${campaign.id}`} class="campaign-card">
                {applicationStatus && (
                  <div class={`application-badge ${applicationStatus}`}>
                    {applicationStatus === 'pending' && '‚è≥ Applied'}
                    {applicationStatus === 'accepted' && '‚úÖ Accepted'}
                    {applicationStatus === 'rejected' && '‚ùå Not Selected'}
                  </div>
                )}
                
                <div class="card-header">
                  {campaign.category && <span class="category">{campaign.category}</span>}
                  {paymentAmount > 0 && <span class="payment">${paymentAmount}</span>}
                </div>
                
                <h3>{campaign.title}</h3>
                
                {campaign.description && (
                  <p class="description">
                    {campaign.description.length > 100 
                      ? campaign.description.substring(0, 100) + '...' 
                      : campaign.description}
                  </p>
                )}
                
                <div class="card-meta">
                  {campaign.manager && (
                    <div class="brand">
                      <img src={campaign.manager.avatar_url || `https://ui-avatars.com/api/?name=${campaign.manager.full_name || 'Brand'}`} alt="" />
                      <span>{campaign.manager.full_name || campaign.manager.username || 'Brand'}</span>
                    </div>
                  )}
                  
                  {campaign.deadline && (
                    <span class="deadline">
                      üìÖ {new Date(campaign.deadline).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                    </span>
                  )}
                </div>

                <div class="card-footer">
                  {campaign.content_type && (
                    <span class="content-type">{campaign.content_type}</span>
                  )}
                  <span class="cta">View Details ‚Üí</span>
                </div>
              </a>
            );
          })}
        </div>
      ) : (
        <div class="empty-state">
          <span class="empty-icon">üì¢</span>
          <h2>No Campaigns Found</h2>
          <p>
            {search ? `No campaigns matching "${search}"` : 'Check back soon for new opportunities!'}
          </p>
          {search && (
            <a href="/campaigns" class="btn btn-primary">Clear Search</a>
          )}
        </div>
      )}
    </div>
  </div>

  <script>
    const categoryFilter = document.getElementById('category-filter') as HTMLSelectElement;
    const sortFilter = document.getElementById('sort-filter') as HTMLSelectElement;

    function updateFilters() {
      const url = new URL(window.location.href);
      url.searchParams.set('category', categoryFilter.value);
      url.searchParams.set('sort', sortFilter.value);
      window.location.href = url.toString();
    }

    categoryFilter?.addEventListener('change', updateFilters);
    sortFilter?.addEventListener('change', updateFilters);
  </script>

  <style>
    .campaigns-page { min-height: 100vh; background: #f8fafc; }
    
    .hero { 
      background: linear-gradient(135deg, #1a1a2e 0%, #2d2d4a 100%); 
      padding: 3rem 0; 
      text-align: center;
    }
    .hero-content { max-width: 600px; margin: 0 auto; padding: 0 1.5rem; }
    .hero h1 { font-size: 2rem; color: white; margin: 0 0 0.5rem 0; }
    .hero p { color: rgba(255,255,255,0.7); margin: 0 0 1.5rem 0; }
    
    .search-form { max-width: 500px; margin: 0 auto; }
    .search-input { display: flex; background: white; border-radius: 12px; overflow: hidden; }
    .search-input input { 
      flex: 1; 
      padding: 1rem 1.25rem; 
      border: none; 
      font-size: 1rem; 
      outline: none;
    }
    .search-input button { 
      padding: 1rem 1.25rem; 
      background: #2563eb; 
      border: none; 
      color: white; 
      font-size: 1.125rem;
      cursor: pointer;
    }
    
    .page-content { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem; }
    
    .filters-bar { 
      display: flex; 
      align-items: center; 
      gap: 1.5rem; 
      background: white; 
      padding: 1rem 1.25rem; 
      border-radius: 12px; 
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .filter-group { display: flex; align-items: center; gap: 0.5rem; }
    .filter-group label { font-size: 0.875rem; color: #6b7280; }
    .filter-group select { 
      padding: 0.5rem 1rem; 
      border: 1px solid #e5e7eb; 
      border-radius: 8px; 
      font-size: 0.875rem;
      background: white;
      cursor: pointer;
    }
    .results-count { margin-left: auto; font-size: 0.875rem; color: #6b7280; }
    
    .campaigns-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
      gap: 1.5rem; 
    }
    
    .campaign-card { 
      background: white; 
      border-radius: 16px; 
      padding: 1.5rem; 
      text-decoration: none;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }
    .campaign-card:hover { 
      transform: translateY(-4px); 
      box-shadow: 0 12px 24px rgba(0,0,0,0.1); 
    }
    
    .application-badge {
      position: absolute;
      top: 1rem;
      right: 1rem;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.6875rem;
      font-weight: 600;
    }
    .application-badge.pending { background: #fef3c7; color: #92400e; }
    .application-badge.accepted { background: #d1fae5; color: #065f46; }
    .application-badge.rejected { background: #fee2e2; color: #991b1b; }
    
    .card-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 0.75rem; 
    }
    .category { 
      background: #f3f4f6; 
      color: #374151; 
      padding: 0.25rem 0.75rem; 
      border-radius: 9999px; 
      font-size: 0.6875rem; 
      text-transform: capitalize;
    }
    .payment { 
      background: linear-gradient(135deg, #d1fae5, #a7f3d0); 
      color: #065f46; 
      padding: 0.25rem 0.75rem; 
      border-radius: 9999px; 
      font-size: 0.875rem; 
      font-weight: 700;
    }
    
    .campaign-card h3 { 
      margin: 0 0 0.75rem 0; 
      font-size: 1.125rem; 
      color: #1a1a2e; 
      line-height: 1.3;
    }
    
    .description { 
      color: #6b7280; 
      font-size: 0.875rem; 
      line-height: 1.5; 
      margin: 0 0 1rem 0;
      flex: 1;
    }
    
    .card-meta { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding-top: 1rem; 
      border-top: 1px solid #e5e7eb;
      margin-bottom: 1rem;
    }
    .brand { display: flex; align-items: center; gap: 0.5rem; }
    .brand img { width: 24px; height: 24px; border-radius: 50%; }
    .brand span { font-size: 0.8125rem; color: #374151; }
    .deadline { font-size: 0.8125rem; color: #6b7280; }
    
    .card-footer { display: flex; justify-content: space-between; align-items: center; }
    .content-type { 
      background: #dbeafe; 
      color: #1e40af; 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-size: 0.6875rem; 
      text-transform: uppercase;
    }
    .cta { 
      font-size: 0.875rem; 
      color: #2563eb; 
      font-weight: 500;
    }
    
    .empty-state { 
      text-align: center; 
      padding: 4rem 2rem; 
      background: white; 
      border-radius: 16px; 
    }
    .empty-icon { font-size: 4rem; display: block; margin-bottom: 1rem; }
    .empty-state h2 { color: #1a1a2e; margin: 0 0 0.5rem 0; }
    .empty-state p { color: #6b7280; margin: 0 0 1.5rem 0; }
    
    .btn { 
      display: inline-block;
      padding: 0.75rem 1.5rem; 
      border-radius: 8px; 
      font-weight: 600; 
      text-decoration: none;
    }
    .btn-primary { background: #2563eb; color: white; }
    
    @media (max-width: 640px) {
      .filters-bar { 
        flex-direction: column; 
        align-items: stretch; 
      }
      .results-count { margin-left: 0; text-align: center; }
      .campaigns-grid { grid-template-columns: 1fr; }
    }
  </style>
</Layout>
