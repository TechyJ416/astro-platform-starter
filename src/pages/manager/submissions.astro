---
// src/pages/manager/submissions.astro
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import { createClient } from "@supabase/supabase-js";

const session = Astro.locals.session;
const profile = Astro.locals.profile;

if (!session) {
  return Astro.redirect('/login?redirect=/manager/submissions');
}

if (profile?.role !== 'manager' && profile?.role !== 'admin') {
  return Astro.redirect('/dashboard');
}

const supabase = createClient(
  import.meta.env.SUPABASE_URL,
  import.meta.env.SUPABASE_SERVICE_KEY || import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
  { auth: { autoRefreshToken: false, persistSession: false } }
);

let successMessage = '';
let errorMessage = '';

// Handle actions
if (Astro.request.method === 'POST') {
  const form = await Astro.request.formData();
  const action = form.get('action') as string;
  const submissionId = form.get('submission_id') as string;

  if (action === 'approve') {
    const { error } = await supabase
      .from('posts')
      .update({ 
        status: 'approved', 
        reviewed_at: new Date().toISOString(),
        reviewed_by: session.user.id
      })
      .eq('id', submissionId);
    
    if (error) errorMessage = error.message;
    else successMessage = 'Submission approved! Creator will be notified.';
  }

  if (action === 'reject') {
    const notes = form.get('notes') as string;
    const { error } = await supabase
      .from('posts')
      .update({ 
        status: 'rejected', 
        reviewed_at: new Date().toISOString(),
        reviewed_by: session.user.id,
        review_notes: notes || null
      })
      .eq('id', submissionId);
    
    if (error) errorMessage = error.message;
    else successMessage = 'Submission rejected.';
  }

  if (action === 'request_revision') {
    const notes = form.get('notes') as string;
    const { error } = await supabase
      .from('posts')
      .update({ 
        status: 'revision_requested', 
        reviewed_at: new Date().toISOString(),
        reviewed_by: session.user.id,
        review_notes: notes || 'Please make revisions and resubmit.'
      })
      .eq('id', submissionId);
    
    if (error) errorMessage = error.message;
    else successMessage = 'Revision requested. Creator will be notified.';
  }
}

// Fetch manager's campaigns
const { data: campaigns } = await supabase
  .from('campaigns')
  .select('id, title, payout_per_post')
  .eq('manager_id', session.user.id);

const campaignIds = campaigns?.map(c => c.id) || [];

// Fetch submissions
const { data: submissions } = campaignIds.length > 0
  ? await supabase
      .from('posts')
      .select(`
        *,
        campaign:campaigns(id, title, payout_per_post),
        creator:profiles!posts_creator_id_fkey(id, full_name, email, avatar_url, level, is_verified)
      `)
      .in('campaign_id', campaignIds)
      .order('created_at', { ascending: false })
  : { data: [] };

// Filter
const filter = Astro.url.searchParams.get('filter') || 'pending';
const campaignFilter = Astro.url.searchParams.get('campaign') || '';

const filteredSubs = (submissions || []).filter(sub => {
  const statusMatch = filter === 'all' || sub.status === filter;
  const campaignMatch = !campaignFilter || sub.campaign_id === campaignFilter;
  return statusMatch && campaignMatch;
});

const statusCounts = {
  all: submissions?.length || 0,
  pending: submissions?.filter(s => s.status === 'pending').length || 0,
  approved: submissions?.filter(s => s.status === 'approved').length || 0,
  rejected: submissions?.filter(s => s.status === 'rejected').length || 0,
  revision_requested: submissions?.filter(s => s.status === 'revision_requested').length || 0,
};
---

<Layout title="Review Submissions">
  <div class="submissions-page">
    <!-- Header -->
    <div class="page-header">
      <div class="header-content">
        <div>
          <a href="/manager" class="back-link">‚Üê Back to Dashboard</a>
          <h1>Review Submissions</h1>
          <p>Review and approve content submissions from creators</p>
        </div>
      </div>
    </div>

    <div class="page-content">
      {successMessage && <div class="alert success">{successMessage}</div>}
      {errorMessage && <div class="alert error">{errorMessage}</div>}

      <!-- Filters -->
      <div class="filters-bar">
        <div class="filter-tabs">
          <a href="?filter=pending" class={`tab ${filter === 'pending' ? 'active' : ''}`}>
            Pending ({statusCounts.pending})
          </a>
          <a href="?filter=revision_requested" class={`tab ${filter === 'revision_requested' ? 'active' : ''}`}>
            Revisions ({statusCounts.revision_requested})
          </a>
          <a href="?filter=approved" class={`tab ${filter === 'approved' ? 'active' : ''}`}>
            Approved ({statusCounts.approved})
          </a>
          <a href="?filter=rejected" class={`tab ${filter === 'rejected' ? 'active' : ''}`}>
            Rejected ({statusCounts.rejected})
          </a>
          <a href="?filter=all" class={`tab ${filter === 'all' ? 'active' : ''}`}>
            All ({statusCounts.all})
          </a>
        </div>

        <select class="campaign-filter" onchange={`window.location.href='?filter=${filter}&campaign=' + this.value`}>
          <option value="">All Campaigns</option>
          {campaigns?.map(c => (
            <option value={c.id} selected={campaignFilter === c.id}>{c.title}</option>
          ))}
        </select>
      </div>

      <!-- Submissions Grid -->
      {filteredSubs.length > 0 ? (
        <div class="submissions-grid">
          {filteredSubs.map(sub => (
            <div class={`submission-card ${sub.status}`}>
              <!-- Preview -->
              <div class="submission-preview">
                {sub.thumbnail_url || sub.media_url || sub.content_url ? (
                  <img src={sub.thumbnail_url || sub.media_url || sub.content_url} alt="Submission preview" />
                ) : (
                  <div class="no-preview">
                    <span>üìÑ</span>
                    <p>No preview</p>
                  </div>
                )}
                <span class={`status-badge ${sub.status}`}>
                  {sub.status.replace('_', ' ')}
                </span>
              </div>

              <!-- Content -->
              <div class="submission-content">
                <h3>{sub.title}</h3>
                
                <div class="creator-row">
                  <div class="creator-avatar-small">
                    {sub.creator?.avatar_url ? (
                      <img src={sub.creator.avatar_url} alt="" />
                    ) : (
                      <span>{sub.creator?.full_name?.charAt(0) || '?'}</span>
                    )}
                  </div>
                  <span class="creator-name">
                    {sub.creator?.full_name}
                    {sub.creator?.is_verified && <span class="verified-mini">‚úì</span>}
                  </span>
                </div>

                <div class="campaign-row">
                  <span class="campaign-name">{sub.campaign?.title}</span>
                  <span class="payout">${sub.campaign?.payout_per_post || 0}</span>
                </div>

                {sub.caption && (
                  <p class="submission-caption">{sub.caption.substring(0, 150)}{sub.caption.length > 150 ? '...' : ''}</p>
                )}

                <div class="submission-meta">
                  <span>üìÖ {new Date(sub.created_at).toLocaleDateString()}</span>
                  {sub.media_type && <span>üìπ {sub.media_type}</span>}
                </div>

                {sub.content_url && (
                  <a href={sub.content_url} target="_blank" class="content-link">
                    üîó View Content
                  </a>
                )}
              </div>

              <!-- Actions -->
              {sub.status === 'pending' && (
                <div class="submission-actions">
                  <form method="POST" class="action-form">
                    <input type="hidden" name="submission_id" value={sub.id} />
                    <button type="submit" name="action" value="approve" class="btn btn-success">
                      ‚úì Approve
                    </button>
                  </form>
                  <button type="button" class="btn btn-warning" onclick={`showRevisionModal('${sub.id}')`}>
                    ‚Ü© Revisions
                  </button>
                  <button type="button" class="btn btn-danger" onclick={`showRejectModal('${sub.id}')`}>
                    ‚úï Reject
                  </button>
                </div>
              )}

              {sub.status === 'revision_requested' && (
                <div class="revision-notice">
                  <p><strong>Revision requested:</strong> {sub.review_notes}</p>
                </div>
              )}

              {sub.status === 'approved' && (
                <div class="approved-notice">
                  <span>‚úì Approved</span>
                  <span class="payout-badge">üí∞ ${sub.campaign?.payout_per_post || 0}</span>
                </div>
              )}

              {sub.status === 'rejected' && sub.review_notes && (
                <div class="rejected-notice">
                  <p>{sub.review_notes}</p>
                </div>
              )}
            </div>
          ))}
        </div>
      ) : (
        <div class="empty-state">
          <span class="empty-icon">üì§</span>
          <h2>No submissions found</h2>
          <p>
            {filter === 'pending' 
              ? "You don't have any pending submissions to review."
              : `No ${filter.replace('_', ' ')} submissions at the moment.`}
          </p>
        </div>
      )}
    </div>

    <!-- Revision Modal -->
    <div id="revision-modal" class="modal">
      <div class="modal-content">
        <h3>Request Revisions</h3>
        <form method="POST" id="revision-form">
          <input type="hidden" name="action" value="request_revision" />
          <input type="hidden" name="submission_id" id="revision-submission-id" />
          <div class="form-group">
            <label>What changes are needed?</label>
            <textarea name="notes" rows="4" required placeholder="Please describe what needs to be changed..."></textarea>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal('revision-modal')">Cancel</button>
            <button type="submit" class="btn btn-warning">Request Revisions</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Reject Modal -->
    <div id="reject-modal" class="modal">
      <div class="modal-content">
        <h3>Reject Submission</h3>
        <form method="POST" id="reject-form">
          <input type="hidden" name="action" value="reject" />
          <input type="hidden" name="submission_id" id="reject-submission-id" />
          <div class="form-group">
            <label>Reason for rejection (optional)</label>
            <textarea name="notes" rows="4" placeholder="Explain why this submission doesn't meet requirements..."></textarea>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal('reject-modal')">Cancel</button>
            <button type="submit" class="btn btn-danger">Reject Submission</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    function showRevisionModal(id: string) {
      (document.getElementById('revision-submission-id') as HTMLInputElement).value = id;
      document.getElementById('revision-modal')?.classList.add('active');
    }

    function showRejectModal(id: string) {
      (document.getElementById('reject-submission-id') as HTMLInputElement).value = id;
      document.getElementById('reject-modal')?.classList.add('active');
    }

    function closeModal(modalId: string) {
      document.getElementById(modalId)?.classList.remove('active');
    }

    // Close modal on backdrop click
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal(modal.id);
      });
    });
  </script>

  <style>
    .submissions-page {
      min-height: 100vh;
      background: #f8fafc;
    }

    .page-header {
      background: linear-gradient(135deg, #1a1a2e 0%, #2d2d4a 100%);
      padding: 2rem 0;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
    }

    .back-link {
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      font-size: 0.875rem;
    }

    .page-header h1 {
      font-size: 1.75rem;
      color: white;
      margin: 0.5rem 0 0.25rem;
    }

    .page-header p {
      color: rgba(255,255,255,0.7);
      margin: 0;
    }

    .page-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    .alert {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }

    .alert.success { background: #d1fae5; color: #065f46; }
    .alert.error { background: #fee2e2; color: #991b1b; }

    .filters-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .filter-tabs {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .tab {
      padding: 0.5rem 1rem;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      text-decoration: none;
      color: #6b7280;
      font-size: 0.875rem;
    }

    .tab:hover { border-color: #2563eb; color: #2563eb; }
    .tab.active { background: #2563eb; border-color: #2563eb; color: white; }

    .campaign-filter {
      padding: 0.5rem 1rem;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.875rem;
      background: white;
    }

    .submissions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 1.5rem;
    }

    .submission-card {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
    }

    .submission-preview {
      position: relative;
      aspect-ratio: 16/9;
      background: #f3f4f6;
    }

    .submission-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .no-preview {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #9ca3af;
    }

    .no-preview span { font-size: 2rem; }
    .no-preview p { margin: 0.5rem 0 0; font-size: 0.875rem; }

    .status-badge {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      font-size: 0.6875rem;
      padding: 0.25rem 0.625rem;
      border-radius: 999px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-badge.pending { background: #fef3c7; color: #d97706; }
    .status-badge.approved { background: #d1fae5; color: #059669; }
    .status-badge.rejected { background: #fee2e2; color: #dc2626; }
    .status-badge.revision_requested { background: #dbeafe; color: #2563eb; }

    .submission-content {
      padding: 1.25rem;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .submission-content h3 {
      margin: 0;
      font-size: 1rem;
      color: #1a1a2e;
    }

    .creator-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .creator-avatar-small {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #2563eb, #8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.75rem;
      font-weight: 600;
      overflow: hidden;
    }

    .creator-avatar-small img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .creator-name {
      font-size: 0.875rem;
      color: #374151;
    }

    .verified-mini {
      color: #10b981;
      font-size: 0.75rem;
    }

    .campaign-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background: #f9fafb;
      border-radius: 6px;
    }

    .campaign-name {
      font-size: 0.8125rem;
      color: #6b7280;
    }

    .payout {
      font-size: 0.875rem;
      font-weight: 600;
      color: #059669;
    }

    .submission-caption {
      margin: 0;
      font-size: 0.8125rem;
      color: #6b7280;
      line-height: 1.5;
    }

    .submission-meta {
      display: flex;
      gap: 1rem;
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .content-link {
      font-size: 0.8125rem;
      color: #2563eb;
      text-decoration: none;
    }

    .content-link:hover { text-decoration: underline; }

    .submission-actions {
      display: flex;
      gap: 0.5rem;
      padding: 1rem 1.25rem;
      border-top: 1px solid #e5e7eb;
    }

    .action-form { display: contents; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem 0.875rem;
      border-radius: 6px;
      font-weight: 500;
      font-size: 0.8125rem;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      flex: 1;
      justify-content: center;
    }

    .btn-success { background: #10b981; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-secondary { background: #f3f4f6; color: #374151; }

    .revision-notice,
    .rejected-notice {
      padding: 0.75rem 1.25rem;
      background: #fef3c7;
      border-top: 1px solid #fde68a;
      font-size: 0.8125rem;
    }

    .rejected-notice { background: #fee2e2; border-color: #fecaca; }

    .revision-notice p,
    .rejected-notice p { margin: 0; color: #92400e; }
    .rejected-notice p { color: #991b1b; }

    .approved-notice {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1.25rem;
      background: #d1fae5;
      border-top: 1px solid #a7f3d0;
      font-size: 0.875rem;
      color: #065f46;
    }

    .payout-badge {
      background: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-weight: 600;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      background: white;
      border-radius: 16px;
    }

    .empty-icon { font-size: 4rem; display: block; margin-bottom: 1rem; }
    .empty-state h2 { margin: 0 0 0.5rem 0; color: #1a1a2e; }
    .empty-state p { color: #6b7280; margin: 0; }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      max-width: 500px;
      width: 100%;
    }

    .modal-content h3 {
      margin: 0 0 1rem 0;
      color: #1a1a2e;
    }

    .modal .form-group {
      margin-bottom: 1rem;
    }

    .modal .form-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .modal textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-family: inherit;
      resize: vertical;
    }

    .modal-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    @media (max-width: 640px) {
      .submissions-grid { grid-template-columns: 1fr; }
      .submission-actions { flex-wrap: wrap; }
    }
  </style>
</Layout>
