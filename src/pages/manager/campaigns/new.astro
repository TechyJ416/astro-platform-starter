---
// src/pages/manager/campaigns/new.astro
export const prerender = false;

import Layout from "../../../layouts/Layout.astro";
import { createClient } from "@supabase/supabase-js";

const session = Astro.locals.session;
const profile = Astro.locals.profile;

if (!session) {
  return Astro.redirect('/login?redirect=/manager/campaigns/new');
}

if (profile?.role !== 'manager' && profile?.role !== 'admin') {
  return Astro.redirect('/dashboard');
}

const supabase = createClient(
  import.meta.env.SUPABASE_URL,
  import.meta.env.SUPABASE_SERVICE_KEY || import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
  { auth: { autoRefreshToken: false, persistSession: false } }
);

let errorMessage = '';
let createdCampaign: any = null;

if (Astro.request.method === 'POST') {
  const form = await Astro.request.formData();
  
  const title = (form.get('title') as string)?.trim();
  const description = (form.get('description') as string)?.trim();
  const requirements = (form.get('requirements') as string)?.trim();
  const budget = parseFloat(form.get('budget') as string) || 0;
  const payoutPerPost = parseFloat(form.get('payout_per_post') as string) || 0;
  const deadline = form.get('deadline') as string;
  const category = form.get('category') as string;
  const contentType = form.get('content_type') as string;
  const status = form.get('status') as string || 'draft';
  
  // Generate slug
  const slug = title.toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '') + '-' + Date.now().toString(36);

  if (!title) {
    errorMessage = 'Campaign title is required.';
  } else if (budget < 0) {
    errorMessage = 'Budget must be a positive number.';
  } else {
    const { data, error } = await supabase
      .from('campaigns')
      .insert({
        title,
        slug,
        description,
        requirements,
        budget,
        payout_per_post: payoutPerPost,
        deadline: deadline || null,
        category,
        content_type: contentType,
        status,
        manager_id: profile.id,
      })
      .select()
      .single();

    if (error) {
    errorMessage = 'Create failed: ' + error.message;
  } else {
    return Astro.redirect(`/manager/campaigns/${data.id}?created=true`);
  }
}
}
---

<Layout title="Create Campaign">
  <div class="create-page">
    <!-- Header -->
    <div class="page-header">
      <div class="header-content">
        <a href="/manager/campaigns" class="back-link">‚Üê Back to Campaigns</a>
        <h1>Create New Campaign</h1>
        <p>Launch a new creator campaign</p>
      </div>
    </div>

    <div class="page-content">
      {errorMessage && (
        <div class="alert error">{errorMessage}</div>
      )}

      <form method="POST" class="campaign-form">
        <!-- Basic Info -->
        <div class="form-section">
          <h2>üìã Basic Information</h2>
          
          <div class="form-group">
            <label for="title">Campaign Title *</label>
            <input 
              type="text" 
              id="title" 
              name="title" 
              required 
              placeholder="e.g., Summer Fashion Showcase"
            />
            <span class="hint">A clear, catchy title that describes your campaign</span>
          </div>

          <div class="form-group">
            <label for="description">Description *</label>
            <textarea 
              id="description" 
              name="description" 
              rows="4" 
              required
              placeholder="Describe what you're looking for from creators..."
            ></textarea>
            <span class="hint">Explain your campaign goals and what kind of content you need</span>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="category">Category</label>
              <select id="category" name="category">
                <option value="">Select category...</option>
                <option value="fashion">Fashion & Beauty</option>
                <option value="tech">Technology</option>
                <option value="food">Food & Beverage</option>
                <option value="lifestyle">Lifestyle</option>
                <option value="fitness">Health & Fitness</option>
                <option value="travel">Travel</option>
                <option value="gaming">Gaming</option>
                <option value="entertainment">Entertainment</option>
                <option value="education">Education</option>
                <option value="business">Business</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label for="content_type">Content Type</label>
              <select id="content_type" name="content_type">
                <option value="">Any type</option>
                <option value="video">Video</option>
                <option value="photo">Photo</option>
                <option value="story">Story/Reel</option>
                <option value="review">Review</option>
                <option value="unboxing">Unboxing</option>
                <option value="tutorial">Tutorial</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Requirements -->
        <div class="form-section">
          <h2>üìù Requirements</h2>
          
          <div class="form-group">
            <label for="requirements">Content Requirements</label>
            <textarea 
              id="requirements" 
              name="requirements" 
              rows="5"
              placeholder="‚Ä¢ Must include product in frame
‚Ä¢ Minimum 30 second video
‚Ä¢ Use hashtags: #YourBrand #Ad
‚Ä¢ Tag @yourbrand in post"
            ></textarea>
            <span class="hint">List specific requirements creators must follow</span>
          </div>

          <div class="form-group">
            <label for="deadline">Submission Deadline</label>
            <input type="date" id="deadline" name="deadline" />
            <span class="hint">When do you need content delivered by?</span>
          </div>
        </div>

        <!-- Budget -->
        <div class="form-section">
          <h2>üí∞ Budget & Compensation</h2>
          
          <div class="form-row">
            <div class="form-group">
              <label for="budget">Total Budget ($)</label>
              <input 
                type="number" 
                id="budget" 
                name="budget" 
                min="0" 
                step="0.01"
                placeholder="5000"
              />
              <span class="hint">Maximum amount you'll spend on this campaign</span>
            </div>
            <div class="form-group">
              <label for="payout_per_post">Payout Per Post ($)</label>
              <input 
                type="number" 
                id="payout_per_post" 
                name="payout_per_post" 
                min="0" 
                step="0.01"
                placeholder="100"
              />
              <span class="hint">Amount paid to creators per approved submission</span>
            </div>
          </div>

          <div class="budget-preview">
            <div class="budget-stat">
              <span class="budget-label">Estimated Creators</span>
              <span class="budget-value" id="estimated-creators">0</span>
            </div>
            <div class="budget-stat">
              <span class="budget-label">Total Budget</span>
              <span class="budget-value" id="total-budget">$0</span>
            </div>
          </div>
        </div>

        <!-- Status -->
        <div class="form-section">
          <h2>üöÄ Launch Options</h2>
          
          <div class="status-options">
            <label class="status-option">
              <input type="radio" name="status" value="draft" checked />
              <div class="status-card">
                <span class="status-icon">üìù</span>
                <div>
                  <strong>Save as Draft</strong>
                  <p>Review and edit before launching</p>
                </div>
              </div>
            </label>
            <label class="status-option">
              <input type="radio" name="status" value="active" />
              <div class="status-card">
                <span class="status-icon">üöÄ</span>
                <div>
                  <strong>Launch Now</strong>
                  <p>Make visible to creators immediately</p>
                </div>
              </div>
            </label>
          </div>
        </div>

        <!-- Actions -->
        <div class="form-actions">
          <a href="/manager/campaigns" class="btn btn-secondary">Cancel</a>
          <button type="submit" class="btn btn-primary">Create Campaign</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Budget calculator
    const budgetInput = document.getElementById('budget') as HTMLInputElement;
    const payoutInput = document.getElementById('payout_per_post') as HTMLInputElement;
    const creatorsSpan = document.getElementById('estimated-creators');
    const totalSpan = document.getElementById('total-budget');

    function updateEstimates() {
      const budget = parseFloat(budgetInput?.value) || 0;
      const payout = parseFloat(payoutInput?.value) || 0;
      const creators = payout > 0 ? Math.floor(budget / payout) : 0;
      
      if (creatorsSpan) creatorsSpan.textContent = creators.toString();
      if (totalSpan) totalSpan.textContent = '$' + budget.toLocaleString();
    }

    budgetInput?.addEventListener('input', updateEstimates);
    payoutInput?.addEventListener('input', updateEstimates);
  </script>

  <style>
    .create-page {
      min-height: 100vh;
      background: #f8fafc;
    }

    .page-header {
      background: linear-gradient(135deg, #1a1a2e 0%, #2d2d4a 100%);
      padding: 2rem 0;
    }

    .header-content {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 1.5rem;
    }

    .back-link {
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      font-size: 0.875rem;
      display: inline-block;
      margin-bottom: 0.5rem;
    }

    .back-link:hover {
      color: white;
    }

    .page-header h1 {
      font-size: 1.75rem;
      color: white;
      margin: 0 0 0.25rem 0;
    }

    .page-header p {
      color: rgba(255,255,255,0.7);
      margin: 0;
    }

    .page-content {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    .alert {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }

    .alert.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .campaign-form {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .form-section {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .form-section h2 {
      font-size: 1.125rem;
      color: #1a1a2e;
      margin: 0 0 1.25rem 0;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.9375rem;
      transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      font-family: inherit;
    }

    .hint {
      display: block;
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 0.375rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    .budget-preview {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-top: 1.5rem;
      padding: 1rem;
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border-radius: 12px;
    }

    .budget-stat {
      text-align: center;
    }

    .budget-label {
      display: block;
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 0.25rem;
    }

    .budget-value {
      display: block;
      font-size: 1.5rem;
      font-weight: 700;
      color: #1a1a2e;
    }

    .status-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    .status-option {
      cursor: pointer;
    }

    .status-option input {
      display: none;
    }

    .status-card {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      transition: all 0.2s;
    }

    .status-option input:checked + .status-card {
      border-color: #2563eb;
      background: #f0f9ff;
    }

    .status-icon {
      font-size: 1.5rem;
    }

    .status-card strong {
      display: block;
      color: #1a1a2e;
      margin-bottom: 0.125rem;
    }

    .status-card p {
      margin: 0;
      font-size: 0.8125rem;
      color: #6b7280;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      padding-top: 1rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      text-decoration: none;
      font-size: 0.9375rem;
      transition: all 0.2s;
      border: none;
      cursor: pointer;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    @media (max-width: 640px) {
      .form-row,
      .status-options {
        grid-template-columns: 1fr;
      }
    }
  </style>
</Layout>
