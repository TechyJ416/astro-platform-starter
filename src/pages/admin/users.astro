---
// src/pages/admin/users.astro
export const prerender = false;

import AdminLayout from "../../layouts/AdminLayout.astro";
import { createClient } from "@supabase/supabase-js";
import { sendApprovalEmail, sendDenialEmail } from "../../lib/email";

const isMasterKeySession = Astro.locals.isMasterKeySession || false;
const session = Astro.locals.session;

if (!isMasterKeySession && !session) {
  return Astro.redirect('/admin/login');
}

// Create admin client with service key for user management
const supabaseUrl = import.meta.env.SUPABASE_URL;
const supabaseServiceKey = import.meta.env.SUPABASE_SERVICE_KEY;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

const supabase = createClient(
  supabaseUrl,
  supabaseServiceKey || supabaseAnonKey,
  { auth: { autoRefreshToken: false, persistSession: false } }
);

const hasServiceKey = !!supabaseServiceKey;

let actionMessage = '';
let actionError = '';

const action = Astro.url.searchParams.get('action');
const editUserId = Astro.url.searchParams.get('edit');

// Get user being edited
let editUser = null;
if (editUserId) {
  const { data } = await supabase.from('profiles').select('*').eq('id', editUserId).single();
  editUser = data;
}

if (Astro.request.method === 'POST') {
  const form = await Astro.request.formData();
  const formAction = form.get('action') as string;

  // ============ CREATE USER (Master Key Only) ============
  if (formAction === 'create_user') {
    if (!isMasterKeySession) {
      actionError = 'Only master key sessions can create users.';
    } else if (!hasServiceKey) {
      actionError = 'SUPABASE_SERVICE_KEY is required to create users.';
    } else {
      const email = (form.get('email') as string)?.trim();
      const password = form.get('password') as string;
      const fullName = (form.get('fullName') as string)?.trim();
      const role = (form.get('role') as string) || 'creator';

      if (!email || !password) {
        actionError = 'Email and password are required.';
      } else if (password.length < 8) {
        actionError = 'Password must be at least 8 characters.';
      } else {
        const { data: authData, error: authError } = await supabase.auth.admin.createUser({
          email,
          password,
          email_confirm: true,
          user_metadata: { full_name: fullName },
        });

        if (authError) {
          actionError = authError.message;
        } else if (authData.user) {
          const { error: profileError } = await supabase.from('profiles').upsert({
            id: authData.user.id,
            email,
            full_name: fullName,
            role,
            status: 'active',
            is_active: true,
            is_verified: true,
          });

          if (profileError) {
            actionError = `User created but profile failed: ${profileError.message}`;
          } else {
            return Astro.redirect('/admin/users?created=true');
          }
        }
      }
    }
  }

  // ============ APPROVE WAITLIST USER ============
  if (formAction === 'approve') {
    const userId = form.get('userId') as string;
    const { data: user } = await supabase.from('profiles').select('email, full_name').eq('id', userId).single();
    
    const { error } = await supabase.from('profiles').update({
      status: 'active',
      is_active: true,
    }).eq('id', userId);

    if (error) {
      actionError = error.message;
    } else {
      actionMessage = `${user?.full_name || user?.email} has been approved and can now log in.`;
      // Send approval email to user
      if (user?.email) {
        await sendApprovalEmail(user.email, user.full_name || '');
      }
    }
  }

  // ============ DENY WAITLIST USER ============
  if (formAction === 'deny') {
    const userId = form.get('userId') as string;
    const { data: user } = await supabase.from('profiles').select('email, full_name').eq('id', userId).single();
    
    const { error } = await supabase.from('profiles').update({
      status: 'denied',
      is_active: false,
    }).eq('id', userId);

    if (error) {
      actionError = error.message;
    } else {
      actionMessage = `${user?.full_name || user?.email}'s application has been denied.`;
      // Send denial email to user
      if (user?.email) {
        await sendDenialEmail(user.email, user.full_name || '');
      }
    }
  }

  // ============ RESET PASSWORD (Master Key Only) ============
  if (formAction === 'reset_password') {
    if (!isMasterKeySession) {
      actionError = 'Only master key sessions can reset passwords.';
    } else if (!hasServiceKey) {
      actionError = 'SUPABASE_SERVICE_KEY is required to reset passwords.';
    } else {
      const userId = form.get('userId') as string;
      const newPassword = form.get('newPassword') as string;

      if (!newPassword || newPassword.length < 8) {
        actionError = 'Password must be at least 8 characters.';
      } else {
        const { error } = await supabase.auth.admin.updateUserById(userId, {
          password: newPassword,
        });

        if (error) actionError = error.message;
        else actionMessage = 'Password reset successfully.';
      }
    }
  }

  // ============ UPDATE USER ============
  if (formAction === 'update_user') {
    const userId = form.get('userId') as string;
    const fullName = (form.get('fullName') as string)?.trim();
    const username = (form.get('username') as string)?.trim().toLowerCase().replace(/[^a-z0-9_]/g, '') || null;
    const role = form.get('role') as string;
    const status = form.get('status') as string;
    const isActive = form.get('isActive') === 'on';
    const isVerified = form.get('isVerified') === 'on';

    const { error } = await supabase.from('profiles').update({
      full_name: fullName,
      username,
      role,
      status,
      is_active: isActive,
      is_verified: isVerified,
    }).eq('id', userId);

    if (error) {
      if (error.code === '23505') {
        actionError = 'Username already taken.';
      } else {
        actionError = error.message;
      }
    } else {
      return Astro.redirect('/admin/users?updated=true');
    }
  }

  // ============ QUICK ACTIONS ============
  const userId = form.get('userId') as string;
  
  if (formAction === 'toggle_active' && userId) {
    const { data: user } = await supabase.from('profiles').select('is_active').eq('id', userId).single();
    const { error } = await supabase.from('profiles').update({ 
      is_active: !user?.is_active,
      status: !user?.is_active ? 'active' : 'suspended'
    }).eq('id', userId);
    if (error) actionError = error.message;
    else actionMessage = `User ${user?.is_active ? 'suspended' : 'activated'}.`;
  }

  if (formAction === 'set_role' && userId) {
    const newRole = form.get('newRole') as string;
    const { error } = await supabase.from('profiles').update({ role: newRole }).eq('id', userId);
    if (error) actionError = error.message;
    else actionMessage = `User role updated to ${newRole}.`;
  }

  if (formAction === 'delete_user' && userId) {
    if (!isMasterKeySession) {
      actionError = 'Only master key sessions can delete users.';
    } else if (!hasServiceKey) {
      actionError = 'SUPABASE_SERVICE_KEY is required to delete users.';
    } else {
      await supabase.from('profiles').delete().eq('id', userId);
      const { error } = await supabase.auth.admin.deleteUser(userId);
      if (error) actionError = error.message;
      else actionMessage = 'User deleted permanently.';
    }
  }
}

// Success messages from redirects
if (Astro.url.searchParams.get('created')) actionMessage = 'User created successfully!';
if (Astro.url.searchParams.get('updated')) actionMessage = 'User updated successfully!';

// Fetch all users
const { data: users, error } = await supabase
  .from("profiles")
  .select("id, email, full_name, role, status, is_active, is_verified, avatar_url, bio, created_at, level, completed_campaigns, is_premium")
  .order("created_at", { ascending: false });

// Stats
const allUsers = users || [];
const pendingUsers = allUsers.filter(u => u.status === 'pending');
const activeUsers = allUsers.filter(u => u.status === 'active' && u.is_active);
const deniedUsers = allUsers.filter(u => u.status === 'denied');
const adminCount = allUsers.filter(u => u.role === 'admin').length;
const modCount = allUsers.filter(u => u.role === 'moderator').length;
const creatorCount = allUsers.filter(u => u.role === 'creator').length;

// Filter
const filter = Astro.url.searchParams.get('filter') || (pendingUsers.length > 0 ? 'pending' : 'all');
const searchQuery = Astro.url.searchParams.get('q')?.toLowerCase() || '';

const filteredUsers = allUsers.filter(user => {
  let matchesFilter = true;
  if (filter === 'pending') matchesFilter = user.status === 'pending';
  else if (filter === 'active') matchesFilter = user.status === 'active' && user.is_active;
  else if (filter === 'denied') matchesFilter = user.status === 'denied';
  else if (filter === 'suspended') matchesFilter = user.status === 'suspended' || (!user.is_active && user.status !== 'denied' && user.status !== 'pending');
  else if (filter === 'admin') matchesFilter = user.role === 'admin';
  else if (filter === 'moderator') matchesFilter = user.role === 'moderator';
  else if (filter === 'creator') matchesFilter = user.role === 'creator';
  else if (filter === 'manager') matchesFilter = user.role === 'manager';
  else if (filter === 'verified') matchesFilter = user.is_verified === true;

  if (searchQuery) {
    const matchesSearch = 
      user.email?.toLowerCase().includes(searchQuery) ||
      user.full_name?.toLowerCase().includes(searchQuery);
    return matchesFilter && matchesSearch;
  }
  return matchesFilter;
});

const managerCount = allUsers.filter(u => u.role === 'manager').length;
const verifiedCount = allUsers.filter(u => u.is_verified).length;

const showForm = action === 'new' || editUserId;
---

<AdminLayout title="Users">
  {actionMessage && <div class="alert success">{actionMessage}</div>}
  {actionError && <div class="alert error">{actionError}</div>}
  {error && <div class="alert error">{error.message}</div>}

  {!hasServiceKey && isMasterKeySession && (
    <div class="alert warning">
      ‚ö†Ô∏è SUPABASE_SERVICE_KEY not configured. Password reset and user creation disabled.
    </div>
  )}

  {showForm ? (
    <div class="panel">
      <div class="panel-header">
        <h2>{editUser ? 'Edit User' : 'Create New User'}</h2>
        <a href="/admin/users" class="btn btn-secondary">‚Üê Back</a>
      </div>
      
      {action === 'new' ? (
        <form method="POST" class="form">
          <input type="hidden" name="action" value="create_user" />
          
          {!isMasterKeySession && (
            <div class="alert warning">‚ö†Ô∏è Only master key sessions can create users.</div>
          )}
          
          <div class="form-row">
            <div class="form-group">
              <label>Email *</label>
              <input type="email" name="email" required placeholder="user@example.com" />
            </div>
            <div class="form-group">
              <label>Full Name</label>
              <input type="text" name="fullName" placeholder="John Doe" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Password * <span class="hint">(min 8 chars)</span></label>
              <input type="password" name="password" required minlength="8" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
            <div class="form-group">
              <label>Role</label>
              <select name="role">
                <option value="creator">Creator</option>
                <option value="manager">Campaign Manager</option>
                <option value="moderator">Moderator</option>
                <option value="admin">Admin</option>
              </select>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" disabled={!isMasterKeySession}>Create User</button>
            <a href="/admin/users" class="btn btn-secondary">Cancel</a>
          </div>
        </form>
      ) : editUser ? (
        <>
          <form method="POST" class="form">
            <input type="hidden" name="action" value="update_user" />
            <input type="hidden" name="userId" value={editUser.id} />
            
            <div class="user-header">
              <div class="user-avatar large">
                {editUser.avatar_url ? (
                  <img src={editUser.avatar_url} alt={editUser.full_name || 'User'} />
                ) : (
                  <span>{editUser.full_name?.charAt(0) || editUser.email?.charAt(0)?.toUpperCase() || '?'}</span>
                )}
              </div>
              <div>
                <div class="user-email-display">{editUser.email}</div>
                <div class="user-id">ID: {editUser.id}</div>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Full Name</label>
                <input type="text" name="fullName" value={editUser.full_name || ''} placeholder="John Doe" />
              </div>
              <div class="form-group">
                <label>Username</label>
                <input type="text" name="username" value={editUser.username || ''} placeholder="johndoe" />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Role</label>
                <select name="role">
                  <option value="creator" selected={editUser.role === 'creator'}>Creator</option>
                  <option value="manager" selected={editUser.role === 'manager'}>Campaign Manager</option>
                  <option value="moderator" selected={editUser.role === 'moderator'}>Moderator</option>
                  <option value="admin" selected={editUser.role === 'admin'}>Admin</option>
                </select>
              </div>
              <div class="form-group">
                <label>Status</label>
                <select name="status">
                  <option value="pending" selected={editUser.status === 'pending'}>Pending (Waitlist)</option>
                  <option value="active" selected={editUser.status === 'active'}>Active</option>
                  <option value="suspended" selected={editUser.status === 'suspended'}>Suspended</option>
                  <option value="denied" selected={editUser.status === 'denied'}>Denied</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group checkboxes">
                <label class="checkbox-label">
                  <input type="checkbox" name="isActive" checked={editUser.is_active} />
                  <span>Account Active</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="isVerified" checked={editUser.is_verified} />
                  <span>Verified Creator/Manager</span>
                </label>
              </div>
            </div>

            <div class="quick-links">
              <a href={`/profile/${editUser.id}`} target="_blank" class="btn btn-secondary">üë§ View Public Profile</a>
              <a href={`/admin/badges?user=${editUser.id}`} class="btn btn-secondary">üèÜ Manage Badges</a>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Save Changes</button>
              <a href="/admin/users" class="btn btn-secondary">Cancel</a>
            </div>
          </form>

          {isMasterKeySession && hasServiceKey && (
            <>
              <div class="section-divider">
                <h3>üîê Reset Password</h3>
                <p>Set a new password for this user.</p>
                <form method="POST" class="inline-form">
                  <input type="hidden" name="action" value="reset_password" />
                  <input type="hidden" name="userId" value={editUser.id} />
                  <input type="password" name="newPassword" required minlength="8" placeholder="New password (min 8 chars)" class="form-input" />
                  <button type="submit" class="btn btn-warning">Reset Password</button>
                </form>
              </div>

              <div class="section-divider danger">
                <h3>‚ö†Ô∏è Danger Zone</h3>
                <p>Permanently delete this user. This cannot be undone.</p>
                <form method="POST" onsubmit="return confirm('Permanently delete this user? This cannot be undone.');">
                  <input type="hidden" name="action" value="delete_user" />
                  <input type="hidden" name="userId" value={editUser.id} />
                  <button type="submit" class="btn btn-danger">Delete User Permanently</button>
                </form>
              </div>
            </>
          )}
        </>
      ) : null}
    </div>
  ) : (
    <>
      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class={`stat-card ${pendingUsers.length > 0 ? 'highlight-warning' : ''}`}>
          <div class="stat-icon">‚è≥</div>
          <div><div class="stat-value">{pendingUsers.length}</div><div class="stat-label">Pending Approval</div></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚úÖ</div>
          <div><div class="stat-value">{activeUsers.length}</div><div class="stat-label">Active Users</div></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üë•</div>
          <div><div class="stat-value">{allUsers.length}</div><div class="stat-label">Total Users</div></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üõ°Ô∏è</div>
          <div><div class="stat-value">{adminCount + modCount}</div><div class="stat-label">Staff</div></div>
        </div>
      </div>

      <!-- Pending Waitlist Alert -->
      {pendingUsers.length > 0 && filter !== 'pending' && (
        <div class="pending-alert">
          <span class="pending-icon">‚è≥</span>
          <div>
            <strong>{pendingUsers.length} user{pendingUsers.length > 1 ? 's' : ''} waiting for approval</strong>
            <p>Review and approve or deny pending signups.</p>
          </div>
          <a href="?filter=pending" class="btn btn-warning">Review Waitlist</a>
        </div>
      )}

      <!-- Toolbar -->
      <div class="toolbar">
        <div class="filter-tabs">
          <a href="?filter=pending" class:list={["filter-tab", { active: filter === 'pending' }]}>
            ‚è≥ Pending ({pendingUsers.length})
          </a>
          <a href="?filter=all" class:list={["filter-tab", { active: filter === 'all' }]}>All</a>
          <a href="?filter=active" class:list={["filter-tab", { active: filter === 'active' }]}>Active</a>
          <a href="?filter=verified" class:list={["filter-tab", { active: filter === 'verified' }]}>‚úì Verified</a>
          <a href="?filter=admin" class:list={["filter-tab", { active: filter === 'admin' }]}>Admins</a>
          <a href="?filter=moderator" class:list={["filter-tab", { active: filter === 'moderator' }]}>Mods</a>
          <a href="?filter=manager" class:list={["filter-tab", { active: filter === 'manager' }]}>Managers</a>
          <a href="?filter=creator" class:list={["filter-tab", { active: filter === 'creator' }]}>Creators</a>
          <a href="?filter=denied" class:list={["filter-tab", { active: filter === 'denied' }]}>Denied</a>
        </div>
        <div class="toolbar-actions">
          <form class="search-form" method="GET">
            {filter !== 'all' && <input type="hidden" name="filter" value={filter} />}
            <input type="text" name="q" placeholder="Search users..." value={searchQuery} class="search-input" />
          </form>
          {isMasterKeySession && (
            <a href="?action=new" class="btn btn-primary">+ New User</a>
          )}
        </div>
      </div>

      <!-- Users List -->
      <div class="panel">
        <div class="panel-header">
          <h2>
            {filter === 'pending' ? '‚è≥ Waitlist - Pending Approval' : 
             filter === 'all' ? 'All Users' : 
             `${filter.charAt(0).toUpperCase() + filter.slice(1)} Users`}
          </h2>
          <span class="panel-count">{filteredUsers.length} users</span>
        </div>

        {filteredUsers.length > 0 ? (
          <div class="users-list">
            {filteredUsers.map(user => (
              <div class={`user-card ${user.status === 'pending' ? 'pending-user' : ''}`}>
                <div class="user-main">
                  <div class="user-avatar">
                    {user.avatar_url ? (
                      <img src={user.avatar_url} alt={user.full_name || 'User'} />
                    ) : (
                      <span>{user.full_name?.charAt(0) || user.email?.charAt(0)?.toUpperCase() || '?'}</span>
                    )}
                  </div>
                  <div class="user-info">
                    <div class="user-name">
                      {user.full_name || 'No name'}
                      {user.is_verified && <span class="verified-check" title="Verified">‚úì</span>}
                      {user.is_premium && <span class="premium-star" title="Premium">‚≠ê</span>}
                      {user.status === 'pending' && <span class="status-tag pending">Pending</span>}
                      {user.status === 'denied' && <span class="status-tag denied">Denied</span>}
                      {user.status === 'suspended' && <span class="status-tag suspended">Suspended</span>}
                      {!user.is_active && user.status === 'active' && <span class="status-tag suspended">Inactive</span>}
                    </div>
                    <div class="user-email">{user.email}</div>
                    <div class="user-date">
                      Signed up {new Date(user.created_at).toLocaleDateString()} ‚Ä¢ 
                      Level {user.level || 1} ‚Ä¢ 
                      {user.completed_campaigns || 0} campaigns
                    </div>
                  </div>
                </div>

                <div class="user-meta">
                  <span class={`role-badge ${user.role || 'creator'}`}>{user.role || 'creator'}</span>
                  <span class="level-badge">Lvl {user.level || 1}</span>
                </div>

                <div class="user-actions">
                  {user.status === 'pending' ? (
                    <div class="waitlist-actions">
                      <form method="POST" class="inline">
                        <input type="hidden" name="userId" value={user.id} />
                        <button name="action" value="approve" class="btn btn-sm btn-success">‚úì Approve</button>
                      </form>
                      <form method="POST" class="inline">
                        <input type="hidden" name="userId" value={user.id} />
                        <button name="action" value="deny" class="btn btn-sm btn-danger">‚úï Deny</button>
                      </form>
                      <a href={`/admin/users/${user.id}`} class="btn btn-sm btn-secondary">View</a>
                    </div>
                  ) : (
                    <>
                      <a href={`/profile/${user.id}`} target="_blank" class="btn btn-sm btn-secondary" title="View Public Profile">
                        üë§
                      </a>
                      <a href={`/admin/badges?user=${user.id}`} class="btn btn-sm btn-secondary" title="Manage Badges">
                        üèÜ
                      </a>
                      <a href={`/admin/preview/${user.id}`} class="btn btn-sm btn-primary" title="Preview as this user">
                        üëÅÔ∏è
                      </a>
                      <a href={`?edit=${user.id}`} class="btn btn-sm btn-secondary">Edit</a>
                      <div class="dropdown">
                        <button class="btn btn-sm btn-secondary dropdown-trigger">‚ãØ</button>
                        <div class="dropdown-menu">
                          <a href={`/admin/users/${user.id}`} class="dropdown-item">üìã Details</a>
                          {['admin', 'moderator', 'creator', 'manager'].map(role => (
                            <form method="POST">
                              <input type="hidden" name="userId" value={user.id} />
                              <input type="hidden" name="action" value="set_role" />
                              <button type="submit" name="newRole" value={role} class="dropdown-item" disabled={user.role === role}>
                                Set {role}
                              </button>
                            </form>
                          ))}
                          <form method="POST" class="inline">
                            <input type="hidden" name="userId" value={user.id} />
                            <button type="submit" name="action" value="toggle_active" class="dropdown-item">
                              {user.is_active ? 'üö´ Suspend' : '‚úÖ Activate'}
                            </button>
                          </form>
                        </div>
                      </div>
                    </>
                  )}
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div class="empty-state">
            <div class="empty-icon">{filter === 'pending' ? 'üéâ' : 'üë•'}</div>
            <h3>{filter === 'pending' ? 'No pending applications!' : 'No users found'}</h3>
            <p>{filter === 'pending' ? 'All waitlist applications have been reviewed.' : searchQuery ? 'Try a different search.' : 'No users match this filter.'}</p>
          </div>
        )}
      </div>
    </>
  )}

  <style>
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .stat-card { background: white; padding: 1.25rem; border-radius: 12px; display: flex; align-items: center; gap: 1rem; }
    .stat-card.highlight-warning { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; }
    .stat-icon { font-size: 1.5rem; width: 44px; height: 44px; background: #f3f4f6; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: #1a1a2e; }
    .stat-label { font-size: 0.8125rem; color: #6b7280; }

    .pending-alert { display: flex; align-items: center; gap: 1rem; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 1.5rem; }
    .pending-icon { font-size: 2rem; }
    .pending-alert strong { color: #92400e; }
    .pending-alert p { font-size: 0.875rem; color: #78350f; margin: 0.25rem 0 0; }
    .pending-alert .btn { margin-left: auto; flex-shrink: 0; }

    .toolbar { display: flex; justify-content: space-between; align-items: center; background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
    .toolbar-actions { display: flex; gap: 0.75rem; align-items: center; }
    .filter-tabs { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .filter-tab { padding: 0.5rem 1rem; border-radius: 8px; text-decoration: none; color: #6b7280; font-size: 0.875rem; font-weight: 500; }
    .filter-tab:hover { background: #f3f4f6; color: #1a1a2e; }
    .filter-tab.active { background: #2563eb; color: white; }
    
    .search-form { display: flex; }
    .search-input { padding: 0.5rem 1rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; width: 200px; }
    .search-input:focus { outline: none; border-color: #2563eb; }

    .panel { background: white; border-radius: 12px; overflow: hidden; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem 1.5rem; border-bottom: 1px solid #e5e7eb; }
    .panel-header h2 { font-size: 1rem; color: #1a1a2e; margin: 0; }
    .panel-count { font-size: 0.875rem; color: #6b7280; }

    .users-list { padding: 0; }
    .user-card { display: flex; align-items: center; gap: 1.5rem; padding: 1rem 1.5rem; border-bottom: 1px solid #f0f0f0; }
    .user-card:last-child { border-bottom: none; }
    .user-card:hover { background: #f9fafb; }
    .user-card.pending-user { background: #fffbeb; }
    .user-card.pending-user:hover { background: #fef3c7; }

    .user-main { display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0; }
    .user-avatar { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, #dbeafe, #c7d2fe); display: flex; align-items: center; justify-content: center; font-weight: 600; color: #2563eb; flex-shrink: 0; overflow: hidden; }
    .user-avatar.large { width: 64px; height: 64px; font-size: 1.5rem; }
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .user-info { min-width: 0; }
    .user-name { font-weight: 600; color: #1a1a2e; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    .user-email { font-size: 0.875rem; color: #6b7280; }
    .user-email-display { font-size: 1rem; color: #374151; }
    .user-id { font-size: 0.75rem; color: #9ca3af; font-family: monospace; }
    .user-date { font-size: 0.75rem; color: #9ca3af; margin-top: 0.125rem; }
    
    .status-tag { font-size: 0.625rem; padding: 0.125rem 0.5rem; border-radius: 4px; font-weight: 600; text-transform: uppercase; }
    .status-tag.pending { background: #fef3c7; color: #d97706; }
    .status-tag.denied { background: #fee2e2; color: #dc2626; }
    .status-tag.suspended { background: #f3f4f6; color: #6b7280; }

    .user-meta { display: flex; align-items: center; gap: 0.5rem; }
    .role-badge { font-size: 0.6875rem; padding: 0.25rem 0.75rem; border-radius: 999px; font-weight: 600; text-transform: uppercase; }
    .role-badge.admin { background: #fee2e2; color: #dc2626; }
    .role-badge.moderator { background: #fef3c7; color: #d97706; }
    .role-badge.creator { background: #d1fae5; color: #059669; }
    .role-badge.manager { background: #dbeafe; color: #2563eb; }

    .level-badge { font-size: 0.6875rem; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; background: #f3f4f6; color: #6b7280; }

    .verified-check { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; background: #10b981; color: white; border-radius: 50%; font-size: 0.625rem; margin-left: 0.25rem; }
    .premium-star { font-size: 0.875rem; margin-left: 0.25rem; }

    .user-actions { display: flex; gap: 0.5rem; align-items: center; }
    .waitlist-actions { display: flex; gap: 0.5rem; }
    
    .dropdown { position: relative; }
    .dropdown-trigger { cursor: pointer; }
    .dropdown-menu { position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); min-width: 140px; z-index: 50; display: none; }
    .dropdown:hover .dropdown-menu, .dropdown:focus-within .dropdown-menu { display: block; }
    .dropdown-item { display: block; width: 100%; padding: 0.5rem 1rem; text-align: left; border: none; background: none; font-size: 0.875rem; color: #374151; cursor: pointer; }
    .dropdown-item:hover { background: #f3f4f6; }
    .dropdown-item:disabled { opacity: 0.5; cursor: not-allowed; }

    .form { padding: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .form-group label { font-weight: 600; font-size: 0.875rem; color: #374151; }
    .form-group .hint { font-weight: 400; color: #9ca3af; font-size: 0.75rem; }
    .form-group input, .form-group select { padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #2563eb; }
    .form-group.checkboxes { flex-direction: row; gap: 1.5rem; align-items: center; padding-top: 1.5rem; }
    .checkbox-label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500; color: #374151; }
    .checkbox-label input { width: 18px; height: 18px; }
    .form-input { padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; flex: 1; }
    .form-actions { display: flex; gap: 1rem; margin-top: 0.5rem; }
    .quick-links { display: flex; gap: 0.5rem; margin: 1rem 0; padding: 1rem; background: #f9fafb; border-radius: 8px; }
    
    .user-header { display: flex; align-items: center; gap: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb; margin-bottom: 0.5rem; }

    .section-divider { padding: 1.5rem; border-top: 1px solid #e5e7eb; }
    .section-divider h3 { font-size: 1rem; margin-bottom: 0.5rem; }
    .section-divider p { font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem; }
    .section-divider.danger { background: #fef2f2; }
    .section-divider.danger h3 { color: #dc2626; }
    .inline-form { display: flex; gap: 0.75rem; align-items: center; }

    .btn { padding: 0.625rem 1.25rem; border-radius: 8px; font-weight: 600; text-decoration: none; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
    .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8125rem; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-secondary { background: #f3f4f6; color: #374151; }
    .btn-success { background: #059669; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-danger { background: #dc2626; color: white; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .inline { display: inline; }

    .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    .alert.success { background: #d1fae5; color: #065f46; }
    .alert.error { background: #fee2e2; color: #991b1b; }
    .alert.warning { background: #fef3c7; color: #92400e; }

    .empty-state { text-align: center; padding: 4rem 2rem; color: #6b7280; }
    .empty-icon { font-size: 3rem; margin-bottom: 1rem; }
    .empty-state h3 { font-size: 1.125rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem; }

    @media (max-width: 1024px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
      .toolbar { flex-direction: column; align-items: stretch; }
      .user-card { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
      .user-meta { width: 100%; justify-content: space-between; }
      .user-actions { width: 100%; justify-content: flex-start; }
      .waitlist-actions { flex-wrap: wrap; }
      .inline-form { flex-direction: column; align-items: stretch; }
      .inline-form .form-input { width: 100%; }
      .pending-alert { flex-direction: column; text-align: center; }
      .pending-alert .btn { margin: 0.5rem 0 0; }
    }
  </style>
</AdminLayout>
