---
// src/pages/admin/campaigns.astro
export const prerender = false;

import AdminLayout from "../../layouts/AdminLayout.astro";
import { createClient } from "@supabase/supabase-js";

const isMasterKeySession = Astro.locals.isMasterKeySession || false;
const session = Astro.locals.session;
const profile = Astro.locals.profile;

if (!isMasterKeySession && !session) {
  return Astro.redirect('/admin/login');
}

// Create admin client with service role - REQUIRED for bypassing RLS
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || import.meta.env.SUPABASE_URL;
const supabaseServiceKey = import.meta.env.SUPABASE_SERVICE_KEY;

// Check if service key is available
const hasServiceKey = !!supabaseServiceKey;

const supabase = createClient(
  supabaseUrl,
  supabaseServiceKey || import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
  { auth: { autoRefreshToken: false, persistSession: false } }
);

// Get admin's user ID for optional manager assignment
const adminUserId = profile?.id || session?.user?.id || null;

let successMessage = '';
let errorMessage = '';

// Show warning if no service key
if (!hasServiceKey) {
  errorMessage = '‚ö†Ô∏è SUPABASE_SERVICE_KEY not configured. Campaign creation/editing will fail. Add it to your environment variables.';
}

const action = Astro.url.searchParams.get('action');
const editId = Astro.url.searchParams.get('edit');

// Get managers for assignment dropdown
const { data: managers } = await supabase
  .from('profiles')
  .select('id, full_name, username, email')
  .in('role', ['manager', 'admin'])
  .order('full_name');

// Get campaign being edited
let editCampaign = null;
if (editId) {
  const { data } = await supabase.from('campaigns').select('*').eq('id', editId).single();
  editCampaign = data;
}

if (Astro.request.method === 'POST') {
  const form = await Astro.request.formData();
  const formAction = form.get('action') as string;

  if (!hasServiceKey) {
    errorMessage = 'Cannot save: SUPABASE_SERVICE_KEY is not configured.';
  } else if (formAction === 'create' || formAction === 'update') {
    const title = (form.get('title') as string)?.trim();
    
    // Validation
    if (!title) {
      errorMessage = 'Campaign title is required.';
    } else {
      // Generate slug from title if not provided
      let slug = (form.get('slug') as string)?.trim();
      if (!slug) {
        slug = title.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '') + '-' + Date.now().toString(36);
      }
      
      const description = (form.get('description') as string)?.trim() || null;
      const requirements = (form.get('requirements') as string)?.trim() || null;
      const category = (form.get('category') as string) || null;
      const status = (form.get('status') as string) || 'draft';
      const budgetStr = form.get('budget') as string;
      const budget = budgetStr ? parseFloat(budgetStr) : null;
      const paymentStr = form.get('paymentPerPost') as string;
      const paymentPerPost = paymentStr ? parseFloat(paymentStr) : null;
      const maxCreatorsStr = form.get('maxCreators') as string;
      const maxCreators = maxCreatorsStr ? parseInt(maxCreatorsStr) : null;
      const deadline = (form.get('deadline') as string) || null;
      const managerId = (form.get('manager_id') as string) || null;

      const campaignData: Record<string, any> = {
        title,
        slug,
        description,
        requirements,
        category,
        status,
        budget,
        budget_total: budget,
        payment_per_post: paymentPerPost,
        payout_per_post: paymentPerPost,
        budget_per_creator: paymentPerPost,
        max_creators: maxCreators,
        deadline: deadline || null,
        application_deadline: deadline || null,
      };

      // Only set manager_id if provided (allows null for admin-managed campaigns)
      if (managerId && managerId !== 'none') {
        campaignData.manager_id = managerId;
      }

      if (formAction === 'update') {
        const campaignId = form.get('campaignId') as string;
        const { error } = await supabase.from('campaigns').update(campaignData).eq('id', campaignId);
        if (error) {
          errorMessage = error.code === '23505' ? 'A campaign with this slug already exists.' : `Update failed: ${error.message}`;
        } else {
          successMessage = 'Campaign updated successfully!';
          editCampaign = null;
        }
      } else {
        const { error } = await supabase.from('campaigns').insert(campaignData);
        if (error) {
          errorMessage = error.code === '23505' ? 'A campaign with this slug already exists.' : `Create failed: ${error.message}`;
        } else {
          successMessage = 'Campaign created successfully!';
        }
      }
    }
  }

  if (formAction === 'activate' || formAction === 'pause' || formAction === 'complete') {
    const campaignId = form.get('campaignId') as string;
    const statusMap: Record<string, string> = { activate: 'active', pause: 'paused', complete: 'completed' };
    const { error } = await supabase.from('campaigns').update({ status: statusMap[formAction] }).eq('id', campaignId);
    if (error) errorMessage = error.message;
    else successMessage = `Campaign ${formAction}d successfully.`;
  }

  if (formAction === 'delete') {
    const campaignId = form.get('campaignId') as string;
    
    // Check for related applications/submissions first
    const { count: appCount } = await supabase.from('applications').select('*', { count: 'exact', head: true }).eq('campaign_id', campaignId);
    const { count: subCount } = await supabase.from('submissions').select('*', { count: 'exact', head: true }).eq('campaign_id', campaignId);
    
    if ((appCount && appCount > 0) || (subCount && subCount > 0)) {
      errorMessage = `Cannot delete: Campaign has ${appCount || 0} application(s) and ${subCount || 0} submission(s). Remove them first.`;
    } else {
      const { error } = await supabase.from('campaigns').delete().eq('id', campaignId);
      if (error) errorMessage = error.message;
      else successMessage = 'Campaign deleted.';
    }
  }
}

// Success messages from redirects
if (Astro.url.searchParams.get('created')) successMessage = 'Campaign created successfully!';
if (Astro.url.searchParams.get('updated')) successMessage = 'Campaign updated successfully!';

// Load campaigns with manager info
const { data: campaigns, error: loadError } = await supabase
  .from('campaigns')
  .select('*, manager:profiles!campaigns_manager_id_fkey(id, full_name, username)')
  .order('created_at', { ascending: false });

if (loadError && loadError.code === '42P01') {
  errorMessage = 'Campaigns table not found. Please run the database migration.';
}

const filter = Astro.url.searchParams.get('filter') || 'all';
const filtered = campaigns?.filter(c => {
  if (filter === 'all') return true;
  if (filter === 'active') return c.status === 'active';
  if (filter === 'draft') return c.status === 'draft' || !c.status;
  if (filter === 'paused') return c.status === 'paused';
  if (filter === 'completed') return c.status === 'completed';
  return true;
}) || [];

const stats = {
  total: campaigns?.length || 0,
  active: campaigns?.filter(c => c.status === 'active').length || 0,
  draft: campaigns?.filter(c => c.status === 'draft' || !c.status).length || 0,
  completed: campaigns?.filter(c => c.status === 'completed').length || 0,
};

const showForm = action === 'new' || editId;
---

<AdminLayout title="Campaigns">
  {successMessage && <div class="alert success">{successMessage}</div>}
  {errorMessage && <div class="alert error">{errorMessage}</div>}
  {!hasServiceKey && (
    <div class="alert warning">
      ‚ö†Ô∏è <strong>SUPABASE_SERVICE_KEY not configured.</strong> Campaign creation and editing will fail. 
      Add this environment variable to enable full admin functionality.
    </div>
  )}

  {showForm ? (
    <div class="panel">
      <div class="panel-header">
        <h2>{editCampaign ? 'Edit Campaign' : 'Create New Campaign'}</h2>
        <a href="/admin/campaigns" class="btn btn-secondary">‚Üê Back</a>
      </div>
      <form method="POST" class="form">
        <input type="hidden" name="action" value={editCampaign ? 'update' : 'create'} />
        {editCampaign && <input type="hidden" name="campaignId" value={editCampaign.id} />}
        
        <div class="form-row">
          <div class="form-group">
            <label>Campaign Title *</label>
            <input type="text" name="title" required placeholder="Summer UGC Campaign" value={editCampaign?.title || ''} />
          </div>
          <div class="form-group">
            <label>Slug <span class="hint">(auto-generated if empty)</span></label>
            <input type="text" name="slug" placeholder="summer-ugc-campaign" value={editCampaign?.slug || ''} />
          </div>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea name="description" rows="3" placeholder="Describe the campaign goals...">{editCampaign?.description || ''}</textarea>
        </div>

        <div class="form-group">
          <label>Requirements</label>
          <textarea name="requirements" rows="3" placeholder="‚Ä¢ Must include product&#10;‚Ä¢ Minimum 30 seconds&#10;‚Ä¢ Use hashtag #YourBrand">{editCampaign?.requirements || ''}</textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Assign Manager</label>
            <select name="manager_id">
              <option value="none">No Manager (Admin-managed)</option>
              {managers?.map(m => (
                <option value={m.id} selected={editCampaign?.manager_id === m.id}>
                  {m.full_name || m.username || m.email}
                </option>
              ))}
            </select>
          </div>
          <div class="form-group">
            <label>Category</label>
            <select name="category">
              <option value="">Select category...</option>
              <option value="fashion" selected={editCampaign?.category === 'fashion'}>Fashion & Beauty</option>
              <option value="tech" selected={editCampaign?.category === 'tech'}>Technology</option>
              <option value="food" selected={editCampaign?.category === 'food'}>Food & Beverage</option>
              <option value="lifestyle" selected={editCampaign?.category === 'lifestyle'}>Lifestyle</option>
              <option value="fitness" selected={editCampaign?.category === 'fitness'}>Health & Fitness</option>
              <option value="travel" selected={editCampaign?.category === 'travel'}>Travel</option>
              <option value="gaming" selected={editCampaign?.category === 'gaming'}>Gaming</option>
              <option value="entertainment" selected={editCampaign?.category === 'entertainment'}>Entertainment</option>
              <option value="other" selected={editCampaign?.category === 'other'}>Other</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Status</label>
            <select name="status">
              <option value="draft" selected={!editCampaign || editCampaign.status === 'draft'}>Draft</option>
              <option value="active" selected={editCampaign?.status === 'active'}>Active</option>
              <option value="paused" selected={editCampaign?.status === 'paused'}>Paused</option>
              <option value="completed" selected={editCampaign?.status === 'completed'}>Completed</option>
            </select>
          </div>
          <div class="form-group">
            <label>Budget ($)</label>
            <input type="number" name="budget" placeholder="5000" min="0" step="0.01" value={editCampaign?.budget || ''} />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Payment Per Post ($)</label>
            <input type="number" name="paymentPerPost" placeholder="100" min="0" step="0.01" value={editCampaign?.payment_per_post || editCampaign?.payout_per_post || ''} />
          </div>
          <div class="form-group">
            <label>Max Creators</label>
            <input type="number" name="maxCreators" placeholder="50" min="1" value={editCampaign?.max_creators || ''} />
          </div>
        </div>

        <div class="form-group">
          <label>Deadline</label>
          <input type="date" name="deadline" value={editCampaign?.deadline?.split('T')[0] || ''} />
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">{editCampaign ? 'Update Campaign' : 'Create Campaign'}</button>
          <a href="/admin/campaigns" class="btn btn-secondary">Cancel</a>
        </div>
      </form>
    </div>
  ) : (
    <>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon">üì¢</div><div><div class="stat-value">{stats.total}</div><div class="stat-label">Total</div></div></div>
        <div class="stat-card highlight"><div class="stat-icon">üü¢</div><div><div class="stat-value">{stats.active}</div><div class="stat-label">Active</div></div></div>
        <div class="stat-card"><div class="stat-icon">üìù</div><div><div class="stat-value">{stats.draft}</div><div class="stat-label">Draft</div></div></div>
        <div class="stat-card"><div class="stat-icon">‚úÖ</div><div><div class="stat-value">{stats.completed}</div><div class="stat-label">Completed</div></div></div>
      </div>

      <div class="toolbar">
        <div class="tabs">
          <a href="?filter=all" class:list={["tab", { active: filter === 'all' }]}>All</a>
          <a href="?filter=active" class:list={["tab", { active: filter === 'active' }]}>Active</a>
          <a href="?filter=draft" class:list={["tab", { active: filter === 'draft' }]}>Draft</a>
          <a href="?filter=paused" class:list={["tab", { active: filter === 'paused' }]}>Paused</a>
          <a href="?filter=completed" class:list={["tab", { active: filter === 'completed' }]}>Completed</a>
        </div>
        <a href="?action=new" class="btn btn-primary">+ New Campaign</a>
      </div>

      {filtered.length > 0 ? (
        <div class="grid">
          {filtered.map(c => (
            <div class="card">
              <div class="card-header">
                <h3>{c.title}</h3>
                <span class={`badge ${c.status || 'draft'}`}>{c.status || 'draft'}</span>
              </div>
              {c.description && <p class="card-desc">{c.description.substring(0, 100)}{c.description.length > 100 ? '...' : ''}</p>}
              <div class="card-meta">
                {c.manager && <span>üë§ {c.manager.full_name || c.manager.username}</span>}
                {!c.manager && <span>üë§ Admin-managed</span>}
                {c.budget != null && <span>üí∞ ${c.budget}</span>}
                {(c.payment_per_post || c.payout_per_post) != null && <span>üìÑ ${c.payment_per_post || c.payout_per_post}/post</span>}
                {c.deadline && <span>üìÖ {new Date(c.deadline).toLocaleDateString()}</span>}
              </div>
              <div class="card-actions">
                <a href={`/admin/campaigns/${c.id}/applications`} class="btn btn-sm btn-secondary">üìù Apps</a>
                <a href={`/admin/campaigns/${c.id}/submissions`} class="btn btn-sm btn-secondary">üì§ Subs</a>
                <a href={`?edit=${c.id}`} class="btn btn-sm btn-secondary">‚úèÔ∏è Edit</a>
                {c.status !== 'active' && (
                  <form method="POST" class="inline"><input type="hidden" name="campaignId" value={c.id} /><button name="action" value="activate" class="btn btn-sm btn-success">‚ñ∂Ô∏è</button></form>
                )}
                {c.status === 'active' && (
                  <form method="POST" class="inline"><input type="hidden" name="campaignId" value={c.id} /><button name="action" value="pause" class="btn btn-sm btn-warning">‚è∏Ô∏è</button></form>
                )}
                <form method="POST" class="inline" onsubmit="return confirm('Delete this campaign?');">
                  <input type="hidden" name="campaignId" value={c.id} />
                  <button name="action" value="delete" class="btn btn-sm btn-danger">üóëÔ∏è</button>
                </form>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="empty"><span>üì¢</span><p>No campaigns found</p><a href="?action=new" class="btn btn-primary">Create First Campaign</a></div>
      )}
    </>
  )}

  <style>
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .stat-card { background: white; padding: 1.25rem; border-radius: 12px; display: flex; align-items: center; gap: 1rem; }
    .stat-card.highlight { background: linear-gradient(135deg, #d1fae5, #a7f3d0); }
    .stat-icon { font-size: 1.5rem; width: 44px; height: 44px; background: #f3f4f6; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: #1a1a2e; }
    .stat-label { font-size: 0.8125rem; color: #6b7280; }
    
    .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; background: white; padding: 1rem; border-radius: 12px; flex-wrap: wrap; gap: 1rem; }
    .tabs { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .tab { padding: 0.5rem 1rem; border-radius: 8px; text-decoration: none; color: #6b7280; font-weight: 500; }
    .tab:hover { background: #f3f4f6; }
    .tab.active { background: #2563eb; color: white; }
    
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
    .card { background: white; border-radius: 12px; padding: 1.25rem; }
    .card-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem; gap: 0.5rem; }
    .card-header h3 { font-size: 1rem; color: #1a1a2e; word-break: break-word; }
    .badge { font-size: 0.6875rem; padding: 0.25rem 0.5rem; border-radius: 6px; font-weight: 600; text-transform: uppercase; white-space: nowrap; }
    .badge.active { background: #d1fae5; color: #059669; }
    .badge.draft { background: #f3f4f6; color: #6b7280; }
    .badge.paused { background: #fef3c7; color: #d97706; }
    .badge.completed { background: #dbeafe; color: #2563eb; }
    .card-desc { font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem; }
    .card-meta { display: flex; gap: 1rem; font-size: 0.8125rem; color: #6b7280; margin-bottom: 1rem; flex-wrap: wrap; }
    .card-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .inline { display: inline; }
    
    .panel { background: white; border-radius: 12px; overflow: hidden; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem; border-bottom: 1px solid #e5e7eb; }
    .panel-header h2 { font-size: 1.125rem; color: #1a1a2e; }
    .form { padding: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .form-group label { font-weight: 600; font-size: 0.875rem; color: #374151; }
    .form-group .hint { font-weight: 400; color: #9ca3af; font-size: 0.75rem; }
    .form-group input, .form-group select, .form-group textarea { padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #2563eb; }
    .form-actions { display: flex; gap: 1rem; margin-top: 0.5rem; }
    
    .btn { padding: 0.625rem 1.25rem; border-radius: 8px; font-weight: 600; text-decoration: none; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
    .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8125rem; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-secondary { background: #f3f4f6; color: #374151; }
    .btn-success { background: #059669; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-danger { background: #dc2626; color: white; }
    
    .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    .alert.success { background: #d1fae5; color: #065f46; }
    .alert.error { background: #fee2e2; color: #991b1b; }
    .alert.warning { background: #fef3c7; color: #92400e; }
    
    .empty { text-align: center; padding: 4rem 2rem; background: white; border-radius: 12px; }
    .empty span { font-size: 3rem; display: block; margin-bottom: 1rem; }
    .empty p { color: #6b7280; margin-bottom: 1rem; }
    
    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .form-row { grid-template-columns: 1fr; }
      .toolbar { flex-direction: column; align-items: stretch; }
    }
  </style>
</AdminLayout>
