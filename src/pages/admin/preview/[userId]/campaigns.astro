---
// src/pages/admin/preview/[userId]/campaigns.astro
export const prerender = false;

import AdminLayout from "../../../../layouts/AdminLayout.astro";
import { createClient } from "@supabase/supabase-js";

const { userId } = Astro.params;

// Check admin access
const isMasterKeySession = Astro.locals.isMasterKeySession || false;
const session = Astro.locals.session;
const adminProfile = Astro.locals.profile;

if (!isMasterKeySession && !session) {
  return Astro.redirect('/admin/login');
}

const isAdmin = isMasterKeySession || adminProfile?.role === 'admin';
if (!isAdmin) {
  return Astro.redirect('/admin');
}

// Create service client
const supabase = createClient(
  import.meta.env.SUPABASE_URL,
  import.meta.env.SUPABASE_SERVICE_KEY || import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
  { auth: { autoRefreshToken: false, persistSession: false } }
);

// Fetch target user
const { data: profile } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', userId)
  .single();

if (!profile) {
  return Astro.redirect('/admin/users?error=user_not_found');
}

// Fetch all applications with campaign details
const { data: applications } = await supabase
  .from('campaign_applications')
  .select(`
    *,
    campaign:campaigns(*)
  `)
  .eq('user_id', userId)
  .order('created_at', { ascending: false });

// Group by status
const grouped = {
  approved: applications?.filter(a => a.status === 'approved') || [],
  pending: applications?.filter(a => a.status === 'pending') || [],
  rejected: applications?.filter(a => a.status === 'rejected' || a.status === 'denied') || [],
};
---

<AdminLayout title={`Campaigns Preview: ${profile.full_name || profile.email}`}>
  <div class="preview-banner">
    <div class="preview-info">
      <span class="preview-icon">üëÅÔ∏è</span>
      <span>Viewing <strong>{profile.full_name || profile.email}</strong>'s Campaigns</span>
    </div>
    <div class="preview-actions">
      <a href={`/admin/preview/${userId}`} class="btn-preview">‚Üê Back to Preview Hub</a>
      <a href={`/admin/preview/${userId}/dashboard`} class="btn-preview">Dashboard</a>
    </div>
  </div>

  <div class="campaigns-preview">
    <h1>My Campaigns</h1>

    <!-- Active Campaigns -->
    <section class="campaign-section">
      <h2>‚úÖ Approved ({grouped.approved.length})</h2>
      {grouped.approved.length > 0 ? (
        <div class="campaign-grid">
          {grouped.approved.map(app => (
            <div class="campaign-card approved">
              <div class="campaign-header">
                <span class="brand">{app.campaign?.brand_name || 'Unknown Brand'}</span>
                <span class="status-badge status-approved">Approved</span>
              </div>
              <h3>{app.campaign?.title || 'Unknown Campaign'}</h3>
              <p class="description">{app.campaign?.description?.substring(0, 100)}...</p>
              <div class="campaign-meta">
                <span>üí∞ ${app.campaign?.payment_amount || 0}</span>
                <span>üìÖ {app.campaign?.deadline ? new Date(app.campaign.deadline).toLocaleDateString() : 'No deadline'}</span>
              </div>
              <div class="campaign-actions">
                <span class="btn btn-primary disabled">Submit Content</span>
                <span class="btn btn-secondary disabled">View Brief</span>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="empty-state">No approved campaigns</div>
      )}
    </section>

    <!-- Pending Applications -->
    <section class="campaign-section">
      <h2>‚è≥ Pending ({grouped.pending.length})</h2>
      {grouped.pending.length > 0 ? (
        <div class="campaign-grid">
          {grouped.pending.map(app => (
            <div class="campaign-card pending">
              <div class="campaign-header">
                <span class="brand">{app.campaign?.brand_name || 'Unknown Brand'}</span>
                <span class="status-badge status-pending">Pending</span>
              </div>
              <h3>{app.campaign?.title || 'Unknown Campaign'}</h3>
              <p class="description">{app.campaign?.description?.substring(0, 100)}...</p>
              <div class="campaign-meta">
                <span>üí∞ ${app.campaign?.payment_amount || 0}</span>
                <span>üìÖ Applied {new Date(app.created_at).toLocaleDateString()}</span>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="empty-state">No pending applications</div>
      )}
    </section>

    <!-- Rejected -->
    <section class="campaign-section">
      <h2>‚ùå Not Approved ({grouped.rejected.length})</h2>
      {grouped.rejected.length > 0 ? (
        <div class="campaign-grid">
          {grouped.rejected.map(app => (
            <div class="campaign-card rejected">
              <div class="campaign-header">
                <span class="brand">{app.campaign?.brand_name || 'Unknown Brand'}</span>
                <span class="status-badge status-rejected">Rejected</span>
              </div>
              <h3>{app.campaign?.title || 'Unknown Campaign'}</h3>
              <p class="description">{app.campaign?.description?.substring(0, 100)}...</p>
              {app.rejection_reason && (
                <p class="rejection-reason">Reason: {app.rejection_reason}</p>
              )}
            </div>
          ))}
        </div>
      ) : (
        <div class="empty-state">No rejected applications</div>
      )}
    </section>
  </div>

  <style>
    .preview-banner {
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .preview-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .preview-icon { font-size: 1.25rem; }

    .preview-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-preview {
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      text-decoration: none;
      font-size: 0.875rem;
    }

    .campaigns-preview {
      background: #f8fafc;
      border-radius: 16px;
      padding: 2rem;
    }

    .campaigns-preview h1 {
      font-size: 1.5rem;
      color: #1a1a2e;
      margin-bottom: 2rem;
    }

    .campaign-section {
      margin-bottom: 2rem;
    }

    .campaign-section h2 {
      font-size: 1rem;
      color: #374151;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .campaign-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }

    .campaign-card {
      background: white;
      border-radius: 12px;
      padding: 1.25rem;
      border: 2px solid #e5e7eb;
    }

    .campaign-card.approved { border-color: #d1fae5; }
    .campaign-card.pending { border-color: #fef3c7; }
    .campaign-card.rejected { border-color: #fee2e2; opacity: 0.8; }

    .campaign-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .brand {
      font-size: 0.75rem;
      color: #6b7280;
      text-transform: uppercase;
      font-weight: 600;
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 100px;
      font-size: 0.6875rem;
      font-weight: 600;
    }

    .status-approved { background: #d1fae5; color: #065f46; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-rejected { background: #fee2e2; color: #991b1b; }

    .campaign-card h3 {
      font-size: 1rem;
      color: #1a1a2e;
      margin-bottom: 0.5rem;
    }

    .description {
      font-size: 0.875rem;
      color: #6b7280;
      margin-bottom: 0.75rem;
    }

    .campaign-meta {
      display: flex;
      gap: 1rem;
      font-size: 0.8125rem;
      color: #6b7280;
      margin-bottom: 1rem;
    }

    .campaign-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.8125rem;
      font-weight: 600;
      text-decoration: none;
    }

    .btn-primary { background: #2563eb; color: white; }
    .btn-secondary { background: #f3f4f6; color: #374151; }
    .btn.disabled { opacity: 0.5; cursor: not-allowed; }

    .rejection-reason {
      font-size: 0.8125rem;
      color: #991b1b;
      font-style: italic;
    }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: #9ca3af;
      background: white;
      border-radius: 8px;
    }
  </style>
</AdminLayout>
