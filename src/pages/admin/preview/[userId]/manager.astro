---
// src/pages/admin/preview/[userId]/manager.astro
export const prerender = false;

import AdminLayout from "../../../../layouts/AdminLayout.astro";
import { createClient } from "@supabase/supabase-js";

const { userId } = Astro.params;

// Check admin access
const isMasterKeySession = Astro.locals.isMasterKeySession || false;
const session = Astro.locals.session;
const profile = Astro.locals.profile;

if (!isMasterKeySession && !session) {
  return Astro.redirect('/admin/login');
}

const isAdmin = isMasterKeySession || profile?.role === 'admin';
if (!isAdmin) {
  return Astro.redirect('/admin');
}

const supabase = createClient(
  import.meta.env.SUPABASE_URL,
  import.meta.env.SUPABASE_SERVICE_KEY || import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
  { auth: { autoRefreshToken: false, persistSession: false } }
);

// Fetch target user
const { data: targetUser, error } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', userId)
  .single();

if (error || !targetUser) {
  return Astro.redirect('/admin/users?error=user_not_found');
}

// Fetch manager's campaigns with stats
const { data: campaigns } = await supabase
  .from('campaigns')
  .select('*')
  .eq('manager_id', userId)
  .order('created_at', { ascending: false });

// Fetch applications for manager's campaigns
const campaignIds = campaigns?.map(c => c.id) || [];
const { data: applications } = campaignIds.length > 0 
  ? await supabase
      .from('campaign_applications')
      .select('id, status, campaign_id')
      .in('campaign_id', campaignIds)
  : { data: [] };

// Fetch submissions for manager's campaigns
const { data: submissions } = campaignIds.length > 0
  ? await supabase
      .from('posts')
      .select('id, status, campaign_id')
      .in('campaign_id', campaignIds)
  : { data: [] };

// Calculate stats
const totalCampaigns = campaigns?.length || 0;
const activeCampaigns = campaigns?.filter(c => c.status === 'active').length || 0;
const pendingApplications = applications?.filter(a => a.status === 'pending').length || 0;
const pendingSubmissions = submissions?.filter(s => s.status === 'pending').length || 0;
const approvedSubmissions = submissions?.filter(s => s.status === 'approved').length || 0;
const totalApplications = applications?.length || 0;

// Calculate total budget and spent
const totalBudget = campaigns?.reduce((sum, c) => sum + (c.budget || 0), 0) || 0;
const totalSpent = campaigns?.reduce((sum, c) => sum + (c.amount_spent || 0), 0) || 0;

// Recent campaigns
const recentCampaigns = campaigns?.slice(0, 5) || [];
---

<AdminLayout title={`Preview: ${targetUser.full_name || targetUser.email} - Manager Dashboard`}>
  <div class="preview-container">
    <!-- Preview Banner -->
    <div class="preview-banner">
      <div class="banner-content">
        <span class="banner-icon">üëÅÔ∏è</span>
        <span>Previewing as <strong>{targetUser.full_name || targetUser.email}</strong> (Manager)</span>
        <a href={`/admin/preview/${userId}`} class="banner-link">‚Üê Back to Preview Hub</a>
      </div>
    </div>

    <!-- Manager Dashboard Preview -->
    <div class="manager-dashboard">
      <!-- Header -->
      <div class="dashboard-header">
        <div class="header-content">
          <div class="welcome-section">
            <h1>Welcome back, {targetUser.full_name?.split(' ')[0] || 'Manager'}!</h1>
            <p>Manage your campaigns and connect with creators</p>
          </div>
          <div class="header-actions">
            <span class="btn btn-primary btn-disabled">+ Create Campaign</span>
          </div>
        </div>
      </div>

      <!-- Stats Overview -->
      <div class="stats-grid">
        <div class="stat-card primary">
          <div class="stat-icon">üì¢</div>
          <div class="stat-content">
            <span class="stat-value">{totalCampaigns}</span>
            <span class="stat-label">Total Campaigns</span>
          </div>
          <div class="stat-badge">{activeCampaigns} active</div>
        </div>

        <div class="stat-card warning">
          <div class="stat-icon">üìù</div>
          <div class="stat-content">
            <span class="stat-value">{pendingApplications}</span>
            <span class="stat-label">Pending Applications</span>
          </div>
        </div>

        <div class="stat-card success">
          <div class="stat-icon">üì§</div>
          <div class="stat-content">
            <span class="stat-value">{pendingSubmissions}</span>
            <span class="stat-label">Pending Submissions</span>
          </div>
        </div>

        <div class="stat-card info">
          <div class="stat-icon">üí∞</div>
          <div class="stat-content">
            <span class="stat-value">${totalBudget.toLocaleString()}</span>
            <span class="stat-label">Total Budget</span>
          </div>
          <div class="stat-badge">${totalSpent.toLocaleString()} spent</div>
        </div>
      </div>

      <!-- Main Content Grid -->
      <div class="content-grid">
        <!-- Left Column -->
        <div class="main-column">
          <!-- Quick Actions -->
          <div class="panel actions-panel">
            <h2>Quick Actions</h2>
            <div class="quick-actions">
              <div class="action-card">
                <span class="action-icon">üì¢</span>
                <div>
                  <strong>New Campaign</strong>
                  <p>Launch a new creator campaign</p>
                </div>
              </div>
              <a href={`/admin/preview/${userId}/manager-creators`} class="action-card">
                <span class="action-icon">üé®</span>
                <div>
                  <strong>Find Creators</strong>
                  <p>Discover and invite creators</p>
                </div>
              </a>
              <a href={`/admin/preview/${userId}/manager-applications`} class="action-card">
                <span class="action-icon">üìù</span>
                <div>
                  <strong>Review Applications</strong>
                  <p>{pendingApplications} pending review</p>
                </div>
              </a>
              <a href={`/admin/preview/${userId}/manager-submissions`} class="action-card">
                <span class="action-icon">‚úÖ</span>
                <div>
                  <strong>Review Submissions</strong>
                  <p>{pendingSubmissions} awaiting approval</p>
                </div>
              </a>
            </div>
          </div>

          <!-- Recent Campaigns -->
          <div class="panel">
            <div class="panel-header">
              <h2>Their Campaigns</h2>
              <a href={`/admin/preview/${userId}/manager-campaigns`} class="view-all">View All ‚Üí</a>
            </div>
            
            {recentCampaigns.length > 0 ? (
              <div class="campaigns-list">
                {recentCampaigns.map(campaign => {
                  const campaignApps = applications?.filter(a => a.campaign_id === campaign.id) || [];
                  const campaignSubs = submissions?.filter(s => s.campaign_id === campaign.id) || [];
                  const pendingApps = campaignApps.filter(a => a.status === 'pending').length;
                  const pendingSubs = campaignSubs.filter(s => s.status === 'pending').length;
                  
                  return (
                    <div class="campaign-card">
                      <div class="campaign-main">
                        <div class="campaign-info">
                          <h3>{campaign.title}</h3>
                          <p class="campaign-meta">
                            <span class={`status-dot ${campaign.status}`}></span>
                            {campaign.status} ‚Ä¢ ${campaign.budget?.toLocaleString() || 0} budget
                          </p>
                        </div>
                        <div class="campaign-stats">
                          {pendingApps > 0 && (
                            <span class="badge warning">{pendingApps} apps</span>
                          )}
                          {pendingSubs > 0 && (
                            <span class="badge success">{pendingSubs} subs</span>
                          )}
                        </div>
                      </div>
                      <div class="campaign-progress">
                        <div class="progress-bar">
                          <div 
                            class="progress-fill" 
                            style={`width: ${Math.min(((campaign.amount_spent || 0) / (campaign.budget || 1)) * 100, 100)}%`}
                          ></div>
                        </div>
                        <span class="progress-text">
                          ${campaign.amount_spent?.toLocaleString() || 0} / ${campaign.budget?.toLocaleString() || 0}
                        </span>
                      </div>
                    </div>
                  );
                })}
              </div>
            ) : (
              <div class="empty-state">
                <span class="empty-icon">üì¢</span>
                <h3>No campaigns yet</h3>
                <p>This manager hasn't created any campaigns.</p>
              </div>
            )}
          </div>
        </div>

        <!-- Right Column -->
        <div class="sidebar-column">
          <!-- Performance Overview -->
          <div class="panel">
            <h2>Performance</h2>
            <div class="metrics-list">
              <div class="metric-item">
                <span class="metric-label">Total Applications</span>
                <span class="metric-value">{totalApplications}</span>
              </div>
              <div class="metric-item">
                <span class="metric-label">Approved Submissions</span>
                <span class="metric-value">{approvedSubmissions}</span>
              </div>
              <div class="metric-item">
                <span class="metric-label">Budget Utilization</span>
                <span class="metric-value">{totalBudget > 0 ? Math.round((totalSpent / totalBudget) * 100) : 0}%</span>
              </div>
              <div class="metric-item">
                <span class="metric-label">Active Campaigns</span>
                <span class="metric-value">{activeCampaigns}</span>
              </div>
            </div>
          </div>

          <!-- Account Info -->
          <div class="panel account-panel">
            <h2>Account</h2>
            <div class="account-info">
              <div class="account-avatar">
                {targetUser.avatar_url ? (
                  <img src={targetUser.avatar_url} alt={targetUser.full_name} />
                ) : (
                  <span>{targetUser.full_name?.charAt(0) || '?'}</span>
                )}
              </div>
              <div>
                <strong>{targetUser.full_name}</strong>
                <p>Campaign Manager</p>
                {targetUser.is_verified && (
                  <span class="verified-badge">‚úì Verified</span>
                )}
              </div>
            </div>
          </div>

          <!-- Admin Actions -->
          <div class="panel admin-panel">
            <h2>üîß Admin Actions</h2>
            <div class="admin-links">
              <a href={`/admin/users?edit=${userId}`}>üìù Edit User</a>
              <a href={`/admin/badges?user=${userId}`}>üèÜ Manage Badges</a>
              <a href={`/profile/${userId}`} target="_blank">üë§ Public Profile</a>
              <a href={`/admin/preview/${userId}`}>‚Üê Preview Hub</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .preview-container {
      min-height: 100vh;
      background: #f8fafc;
    }

    .preview-banner {
      background: linear-gradient(135deg, #7c3aed, #a855f7);
      color: white;
      padding: 0.75rem 1.5rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .banner-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.875rem;
    }

    .banner-icon { font-size: 1.25rem; }
    .banner-link { 
      margin-left: auto; 
      color: rgba(255,255,255,0.9); 
      text-decoration: none;
      padding: 0.25rem 0.75rem;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }
    .banner-link:hover { background: rgba(255,255,255,0.3); }

    .manager-dashboard { padding-bottom: 4rem; }

    .dashboard-header {
      background: linear-gradient(135deg, #1a1a2e 0%, #2d2d4a 100%);
      padding: 2rem 0;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .welcome-section h1 {
      font-size: 1.75rem;
      color: white;
      margin: 0 0 0.25rem 0;
    }

    .welcome-section p {
      color: rgba(255,255,255,0.7);
      margin: 0;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      border-radius: 8px;
      font-weight: 600;
      text-decoration: none;
      font-size: 0.9375rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      color: white;
    }

    .btn-disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Stats Grid */
    .stats-grid {
      max-width: 1200px;
      margin: 0 auto 2rem;
      padding: 0 1.5rem;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1.5rem;
      margin-top: -1.5rem;
      position: relative;
      z-index: 10;
    }

    .stat-card {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
    }

    .stat-card.primary::before { background: linear-gradient(90deg, #2563eb, #3b82f6); }
    .stat-card.warning::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .stat-card.success::before { background: linear-gradient(90deg, #10b981, #34d399); }
    .stat-card.info::before { background: linear-gradient(90deg, #06b6d4, #22d3ee); }

    .stat-icon { font-size: 2rem; }
    .stat-content { display: flex; flex-direction: column; }
    .stat-value { font-size: 2rem; font-weight: 700; color: #1a1a2e; line-height: 1; }
    .stat-label { font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; }
    .stat-badge { font-size: 0.75rem; color: #6b7280; background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 4px; align-self: flex-start; }

    /* Content Grid */
    .content-grid {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 2rem;
    }

    .panel {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
    }

    .panel h2 { font-size: 1.125rem; color: #1a1a2e; margin: 0 0 1rem 0; }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .panel-header h2 { margin: 0; }
    .view-all { font-size: 0.875rem; color: #2563eb; text-decoration: none; }

    /* Quick Actions */
    .actions-panel {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 1px solid #bae6fd;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    .action-card {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      padding: 1rem;
      background: white;
      border-radius: 12px;
      text-decoration: none;
      color: inherit;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .action-card:hover {
      border-color: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
    }

    .action-icon { font-size: 1.5rem; flex-shrink: 0; }
    .action-card strong { display: block; color: #1a1a2e; font-size: 0.9375rem; }
    .action-card p { margin: 0.25rem 0 0; font-size: 0.8125rem; color: #6b7280; }

    /* Campaigns List */
    .campaigns-list { display: flex; flex-direction: column; gap: 1rem; }

    .campaign-card {
      padding: 1rem;
      background: #f9fafb;
      border-radius: 12px;
    }

    .campaign-main {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }

    .campaign-info h3 { margin: 0 0 0.25rem 0; font-size: 1rem; color: #1a1a2e; }
    .campaign-meta { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8125rem; color: #6b7280; margin: 0; }

    .status-dot { width: 8px; height: 8px; border-radius: 50%; }
    .status-dot.active { background: #10b981; }
    .status-dot.draft { background: #6b7280; }
    .status-dot.paused { background: #f59e0b; }
    .status-dot.completed { background: #2563eb; }

    .campaign-stats { display: flex; gap: 0.5rem; }
    .badge { font-size: 0.6875rem; padding: 0.25rem 0.5rem; border-radius: 999px; font-weight: 600; }
    .badge.warning { background: #fef3c7; color: #d97706; }
    .badge.success { background: #d1fae5; color: #059669; }

    .campaign-progress { display: flex; align-items: center; gap: 1rem; }
    .progress-bar { flex: 1; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #2563eb, #3b82f6); border-radius: 3px; }
    .progress-text { font-size: 0.75rem; color: #6b7280; white-space: nowrap; }

    /* Empty State */
    .empty-state { text-align: center; padding: 2rem; }
    .empty-icon { font-size: 3rem; display: block; margin-bottom: 1rem; }
    .empty-state h3 { margin: 0 0 0.5rem 0; color: #1a1a2e; }
    .empty-state p { color: #6b7280; margin: 0; }

    /* Sidebar */
    .metrics-list { display: flex; flex-direction: column; gap: 1rem; }
    .metric-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 8px; }
    .metric-label { font-size: 0.8125rem; color: #6b7280; }
    .metric-value { font-weight: 700; color: #1a1a2e; }

    /* Account Panel */
    .account-info { display: flex; gap: 1rem; align-items: center; }
    .account-avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #2563eb, #8b5cf6); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.25rem; overflow: hidden; }
    .account-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .account-info strong { display: block; color: #1a1a2e; }
    .account-info p { margin: 0; font-size: 0.8125rem; color: #6b7280; }
    .verified-badge { font-size: 0.6875rem; background: #d1fae5; color: #059669; padding: 0.125rem 0.375rem; border-radius: 4px; }

    /* Admin Panel */
    .admin-panel { background: #fef3c7; border: 1px solid #fde68a; }
    .admin-links { display: flex; flex-direction: column; gap: 0.5rem; }
    .admin-links a { display: block; padding: 0.5rem; color: #92400e; text-decoration: none; font-size: 0.875rem; border-radius: 6px; }
    .admin-links a:hover { background: rgba(255,255,255,0.5); }

    @media (max-width: 1024px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .content-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 640px) {
      .stats-grid { grid-template-columns: 1fr; }
      .quick-actions { grid-template-columns: 1fr; }
    }
  </style>
</AdminLayout>
