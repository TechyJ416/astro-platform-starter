---
// src/pages/admin/badges.astro
export const prerender = false;

import AdminLayout from "../../layouts/AdminLayout.astro";
import { createClient } from "@supabase/supabase-js";

const isMasterKeySession = Astro.locals.isMasterKeySession || false;
const session = Astro.locals.session;

if (!isMasterKeySession && !session) {
  return Astro.redirect('/admin/login');
}

const supabase = createClient(
  import.meta.env.SUPABASE_URL,
  import.meta.env.SUPABASE_SERVICE_KEY || import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
  { auth: { autoRefreshToken: false, persistSession: false } }
);

// New leveling system
const LEVELS = [
  { level: 10, title: 'Recruit', multiplier: 1.0, color: '#6b7280', icon: '‚¨°' },
  { level: 20, title: 'Digital Scout', multiplier: 1.1, color: '#8b5cf6', icon: '‚¨¢' },
  { level: 30, title: 'Digital Specialist', multiplier: 1.1, color: '#a855f7', icon: '‚óà' },
  { level: 40, title: 'Ops Enforcer', multiplier: 1.2, color: '#c026d3', icon: '‚óÜ' },
  { level: 50, title: 'Tactical Uplink', multiplier: 1.2, color: '#d946ef', icon: '‚¨£' },
  { level: 60, title: 'Network Commander', multiplier: 1.3, color: '#ec4899', icon: '‚ú¶' },
  { level: 70, title: 'Digital General', multiplier: 1.3, color: '#f43f5e', icon: '‚òÖ' },
  { level: 80, title: 'Campaign Marshal', multiplier: 1.4, color: '#f59e0b', icon: '‚ú™' },
  { level: 90, title: 'Digital Warlord', multiplier: 1.4, color: '#eab308', icon: '‚öî' },
  { level: 100, title: '5 Star Digital General', multiplier: 1.5, color: '#fbbf24', icon: '‚≠ê' },
];

function getLevelInfo(exp: number) {
  for (let i = LEVELS.length - 1; i >= 0; i--) {
    if (exp >= LEVELS[i].level) {
      return LEVELS[i];
    }
  }
  return LEVELS[0];
}

let successMessage = '';
let errorMessage = '';

// Get user to manage (from query param)
const userId = Astro.url.searchParams.get('user');
const badgeSlug = Astro.url.searchParams.get('badge');
let targetUser: any = null;
let userBadges: any[] = [];
let viewBadge: any = null;
let badgeUsers: any[] = [];

// If viewing a specific badge, fetch users with that badge
if (badgeSlug) {
  const { data: badge } = await supabase
    .from('badges')
    .select('*')
    .eq('slug', badgeSlug)
    .single();
  viewBadge = badge;

  if (viewBadge) {
    const { data: users } = await supabase
      .from('user_badges')
      .select(`
        id, awarded_at, notes,
        user:profiles!user_badges_user_id_fkey(id, full_name, email, avatar_url, role, creator_level, creator_exp, is_verified)
      `)
      .eq('badge_id', viewBadge.id)
      .order('awarded_at', { ascending: false });
    badgeUsers = users || [];
  }
}

if (userId) {
  const { data } = await supabase
    .from('profiles')
    .select('id, full_name, email, username, role, is_verified, creator_level, creator_exp, payment_multiplier')
    .eq('id', userId)
    .single();
  targetUser = data;

  if (targetUser) {
    const { data: badges } = await supabase
      .from('user_badges')
      .select(`
        id, awarded_at, notes,
        badge:badges(id, name, slug, icon, color, category)
      `)
      .eq('user_id', userId)
      .order('awarded_at', { ascending: false });
    userBadges = badges || [];
  }
}

// Handle form submission
if (Astro.request.method === 'POST') {
  const form = await Astro.request.formData();
  const action = form.get('action') as string;

  if (action === 'award_badge') {
    const badgeId = form.get('badge_id') as string;
    const targetUserId = form.get('user_id') as string;
    const notes = form.get('notes') as string;

    const { error } = await supabase.from('user_badges').insert({
      user_id: targetUserId,
      badge_id: badgeId,
      notes: notes || null,
      awarded_by: session?.user?.id || null,
    });

    if (error) {
      if (error.code === '23505') {
        errorMessage = 'User already has this badge.';
      } else {
        errorMessage = error.message;
      }
    } else {
      successMessage = 'Badge awarded successfully!';
      // Refresh user badges
      if (targetUserId === userId) {
        const { data } = await supabase
          .from('user_badges')
          .select(`id, awarded_at, notes, badge:badges(id, name, slug, icon, color, category)`)
          .eq('user_id', userId)
          .order('awarded_at', { ascending: false });
        userBadges = data || [];
      }
    }
  }

  if (action === 'remove_badge') {
    const userBadgeId = form.get('user_badge_id') as string;
    const { error } = await supabase.from('user_badges').delete().eq('id', userBadgeId);
    
    if (error) {
      errorMessage = error.message;
    } else {
      successMessage = 'Badge removed.';
      userBadges = userBadges.filter(ub => ub.id !== userBadgeId);
    }
  }

  if (action === 'verify_user') {
    const targetUserId = form.get('user_id') as string;
    const { error } = await supabase.from('profiles').update({
      is_verified: true,
      verified_at: new Date().toISOString(),
      verified_by: session?.user?.id || null,
    }).eq('id', targetUserId);

    if (error) {
      errorMessage = error.message;
    } else {
      successMessage = 'User verified!';
      if (targetUser) targetUser.is_verified = true;

      // Award verified badge
      const { data: verifiedBadge } = await supabase
        .from('badges')
        .select('id')
        .eq('slug', targetUser?.role === 'manager' ? 'verified-manager' : 'verified-creator')
        .single();

      if (verifiedBadge) {
        await supabase.from('user_badges').insert({
          user_id: targetUserId,
          badge_id: verifiedBadge.id,
          awarded_by: session?.user?.id || null,
        }).select();
      }
    }
  }

  if (action === 'unverify_user') {
    const targetUserId = form.get('user_id') as string;
    const { error } = await supabase.from('profiles').update({
      is_verified: false,
      verified_at: null,
      verified_by: null,
    }).eq('id', targetUserId);

    if (error) {
      errorMessage = error.message;
    } else {
      successMessage = 'Verification removed.';
      if (targetUser) targetUser.is_verified = false;
    }
  }

  if (action === 'set_exp') {
    const targetUserId = form.get('user_id') as string;
    const exp = parseInt(form.get('exp') as string);
    const levelInfo = getLevelInfo(exp);
    
    const { error } = await supabase.from('profiles').update({ 
      creator_exp: exp,
      creator_level: levelInfo.level,
      payment_multiplier: levelInfo.multiplier
    }).eq('id', targetUserId);

    if (error) {
      errorMessage = error.message;
    } else {
      successMessage = `EXP set to ${exp}! User is now ${levelInfo.title} (Lv.${levelInfo.level}) with ${levelInfo.multiplier}x multiplier.`;
      if (targetUser) {
        targetUser.creator_exp = exp;
        targetUser.creator_level = levelInfo.level;
        targetUser.payment_multiplier = levelInfo.multiplier;
      }
    }
  }

  if (action === 'set_level_direct') {
    const targetUserId = form.get('user_id') as string;
    const level = parseInt(form.get('level') as string);
    const levelInfo = LEVELS.find(l => l.level === level) || LEVELS[0];
    
    const { error } = await supabase.from('profiles').update({ 
      creator_exp: level,
      creator_level: level,
      payment_multiplier: levelInfo.multiplier
    }).eq('id', targetUserId);

    if (error) {
      errorMessage = error.message;
    } else {
      successMessage = `Rank set to ${levelInfo.title} (Lv.${level}) with ${levelInfo.multiplier}x multiplier!`;
      if (targetUser) {
        targetUser.creator_exp = level;
        targetUser.creator_level = level;
        targetUser.payment_multiplier = levelInfo.multiplier;
      }
    }
  }

  if (action === 'create_badge') {
    const name = form.get('name') as string;
    const slug = (form.get('slug') as string) || name.toLowerCase().replace(/\s+/g, '-');
    const description = form.get('description') as string;
    const icon = form.get('icon') as string || 'üèÜ';
    const color = form.get('color') as string || '#f59e0b';
    const category = form.get('category') as string || 'special';

    const { error } = await supabase.from('badges').insert({
      name, slug, description, icon, color, category,
      requirement_type: 'manual',
    });

    if (error) {
      if (error.code === '23505') {
        errorMessage = 'Badge with this slug already exists.';
      } else {
        errorMessage = error.message;
      }
    } else {
      successMessage = 'Badge created!';
    }
  }
}

// Fetch all badges
const { data: allBadges } = await supabase
  .from('badges')
  .select('*')
  .order('sort_order', { ascending: true });

// Fetch all users for dropdown
const { data: allUsers } = await supabase
  .from('profiles')
  .select('id, full_name, email, username, role')
  .order('full_name', { ascending: true, nullsFirst: false });

// Get recent badge awards
const { data: recentAwards } = await supabase
  .from('user_badges')
  .select(`
    id, awarded_at,
    user:profiles!user_badges_user_id_fkey(id, full_name, email),
    badge:badges(name, icon, color)
  `)
  .order('awarded_at', { ascending: false })
  .limit(20);

// Get badge counts
const { data: badgeCounts } = await supabase
  .from('user_badges')
  .select('badge_id');

const badgeCountMap: Record<string, number> = {};
badgeCounts?.forEach(ub => {
  badgeCountMap[ub.badge_id] = (badgeCountMap[ub.badge_id] || 0) + 1;
});

const tab = Astro.url.searchParams.get('tab') || (userId ? 'user' : badgeSlug ? 'view' : 'badges');

// Get user's current level info if viewing a user
const userLevelInfo = targetUser ? getLevelInfo(targetUser.creator_exp || 10) : null;
---

<AdminLayout title="Badges Management">
  {successMessage && <div class="alert success">{successMessage}</div>}
  {errorMessage && <div class="alert error">{errorMessage}</div>}

  <div class="badges-page">
    <div class="page-header">
      <div>
        <h1>üèÜ Badges & Ranks</h1>
        <p class="subtitle">Manage badges, verify users, and set military ranks</p>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <a href="/admin/badges?tab=badges" class={`tab ${tab === 'badges' ? 'active' : ''}`}>All Badges</a>
      <a href="/admin/badges?tab=ranks" class={`tab ${tab === 'ranks' ? 'active' : ''}`}>Rank System</a>
      <a href="/admin/badges?tab=award" class={`tab ${tab === 'award' ? 'active' : ''}`}>Award Badge</a>
      <a href="/admin/badges?tab=create" class={`tab ${tab === 'create' ? 'active' : ''}`}>Create Badge</a>
      {badgeSlug && viewBadge && (
        <a href={`/admin/badges?badge=${badgeSlug}`} class={`tab ${tab === 'view' ? 'active' : ''}`}>
          {viewBadge.icon} {viewBadge.name}
        </a>
      )}
      {userId && targetUser && (
        <a href={`/admin/badges?user=${userId}&tab=user`} class={`tab ${tab === 'user' ? 'active' : ''}`}>
          User: {targetUser?.full_name || targetUser?.username || 'Unknown'}
        </a>
      )}
    </div>

    <!-- Rank System Tab -->
    {tab === 'ranks' && (
      <div class="panel">
        <h2>‚öîÔ∏è Military Rank System</h2>
        <p class="panel-desc">Creators progress through ranks by earning EXP. Each rank provides payment multipliers.</p>
        
        <div class="ranks-table">
          <div class="ranks-header">
            <span>EXP</span>
            <span>Rank</span>
            <span>Title</span>
            <span>Multiplier</span>
          </div>
          {LEVELS.map((level, index) => (
            <div class="rank-row" style={`--rank-color: ${level.color}`}>
              <span class="rank-exp">{level.level}</span>
              <span class="rank-badge">
                <span class="rank-icon" style={`background: ${level.color}`}>{level.icon}</span>
                Lv.{level.level}
              </span>
              <span class="rank-title">{level.title}</span>
              <span class="rank-multiplier">{level.multiplier.toFixed(1)}x</span>
            </div>
          ))}
        </div>

        <div class="rank-info-cards">
          <div class="info-card">
            <h4>üéØ EXP System</h4>
            <p>EXP is earned through completed campaigns and engagement. Max EXP is 100.</p>
          </div>
          <div class="info-card">
            <h4>üí∞ Payment Multipliers</h4>
            <p>Higher ranks earn more per campaign. A 5 Star Digital General earns 1.5x base payment.</p>
          </div>
          <div class="info-card">
            <h4>‚¨ÜÔ∏è Progression</h4>
            <p>Ranks are: Recruit ‚Üí Digital Scout ‚Üí Digital Specialist ‚Üí Ops Enforcer ‚Üí Tactical Uplink ‚Üí Network Commander ‚Üí Digital General ‚Üí Campaign Marshal ‚Üí Digital Warlord ‚Üí 5 Star Digital General</p>
          </div>
        </div>
      </div>
    )}

    <!-- View Badge Users Tab -->
    {tab === 'view' && viewBadge && (
      <div class="panel">
        <div class="badge-header">
          <span class="badge-icon-xlarge" style={`background: ${viewBadge.color}`}>{viewBadge.icon}</span>
          <div>
            <h2>{viewBadge.name}</h2>
            <p class="badge-desc">{viewBadge.description}</p>
            <span class="badge-meta">{viewBadge.category} ‚Ä¢ {badgeUsers.length} users</span>
          </div>
        </div>

        <h3>Users with this badge ({badgeUsers.length})</h3>
        {badgeUsers.length > 0 ? (
          <div class="users-list">
            {badgeUsers.map(ub => {
              const levelInfo = getLevelInfo(ub.user?.creator_exp || 10);
              return (
                <div class="user-row">
                  <div class="user-avatar-small">
                    {ub.user?.avatar_url ? (
                      <img src={ub.user.avatar_url} alt="" />
                    ) : (
                      <span>{(ub.user?.full_name || ub.user?.email || '?').charAt(0).toUpperCase()}</span>
                    )}
                  </div>
                  <div class="user-info">
                    <strong>{ub.user?.full_name || 'Unknown'}</strong>
                    <span class="user-email">{ub.user?.email}</span>
                  </div>
                  <div class="user-meta">
                    <span class={`role-tag ${ub.user?.role}`}>{ub.user?.role}</span>
                    {ub.user?.is_verified && <span class="verified-tag">‚úì</span>}
                    <span class="level-tag" style={`background: ${levelInfo.color}20; color: ${levelInfo.color}; border: 1px solid ${levelInfo.color}40`}>
                      {levelInfo.icon} Lv.{levelInfo.level}
                    </span>
                  </div>
                  <div class="user-actions">
                    <span class="award-date">Awarded {new Date(ub.awarded_at).toLocaleDateString()}</span>
                    <a href={`/profile/${ub.user?.id}`} target="_blank" class="btn btn-sm">üë§</a>
                    <a href={`/admin/badges?user=${ub.user?.id}`} class="btn btn-sm">üèÜ</a>
                  </div>
                </div>
              );
            })}
          </div>
        ) : (
          <p class="empty-text">No users have earned this badge yet.</p>
        )}
      </div>
    )}

    <!-- User Management Tab -->
    {tab === 'user' && targetUser && (
      <div class="panel">
        <div class="user-header">
          <div>
            <h2>{targetUser.full_name || targetUser.username || targetUser.email}</h2>
            <p class="user-meta-line">
              @{targetUser.username || 'no-username'} ‚Ä¢ {targetUser.role} ‚Ä¢ 
              {targetUser.is_verified ? '‚úì Verified' : 'Not Verified'}
            </p>
          </div>
          <a href={`/profile/${targetUser.id}`} target="_blank" class="btn btn-secondary">
            üëÅÔ∏è View Public Profile
          </a>
        </div>

        <!-- Current Rank Display -->
        {userLevelInfo && (
          <div class="current-rank-display" style={`--rank-color: ${userLevelInfo.color}`}>
            <div class="rank-visual">
              <span class="rank-icon-large" style={`background: ${userLevelInfo.color}`}>{userLevelInfo.icon}</span>
              <div class="rank-details">
                <span class="rank-level">Level {userLevelInfo.level}</span>
                <span class="rank-name">{userLevelInfo.title}</span>
              </div>
            </div>
            <div class="rank-stats">
              <div class="stat">
                <span class="stat-value">{targetUser.creator_exp || 10}</span>
                <span class="stat-label">EXP</span>
              </div>
              <div class="stat">
                <span class="stat-value">{userLevelInfo.multiplier.toFixed(1)}x</span>
                <span class="stat-label">Multiplier</span>
              </div>
            </div>
          </div>
        )}

        <!-- Verification -->
        <div class="section">
          <h3>Verification Status</h3>
          <div class="verification-controls">
            {targetUser.is_verified ? (
              <form method="POST" style="display: inline;">
                <input type="hidden" name="action" value="unverify_user" />
                <input type="hidden" name="user_id" value={targetUser.id} />
                <button type="submit" class="btn btn-danger">Remove Verification</button>
              </form>
            ) : (
              <form method="POST" style="display: inline;">
                <input type="hidden" name="action" value="verify_user" />
                <input type="hidden" name="user_id" value={targetUser.id} />
                <button type="submit" class="btn btn-success">‚úì Verify User</button>
              </form>
            )}
          </div>
        </div>

        <!-- Set Rank -->
        <div class="section">
          <h3>‚öîÔ∏è Set Military Rank</h3>
          <form method="POST" class="rank-form">
            <input type="hidden" name="action" value="set_level_direct" />
            <input type="hidden" name="user_id" value={targetUser.id} />
            <div class="rank-select-grid">
              {LEVELS.map(level => (
                <label class={`rank-option ${targetUser.creator_level === level.level ? 'selected' : ''}`} style={`--opt-color: ${level.color}`}>
                  <input type="radio" name="level" value={level.level} checked={targetUser.creator_level === level.level} />
                  <span class="opt-icon">{level.icon}</span>
                  <span class="opt-level">Lv.{level.level}</span>
                  <span class="opt-title">{level.title}</span>
                  <span class="opt-mult">{level.multiplier.toFixed(1)}x</span>
                </label>
              ))}
            </div>
            <button type="submit" class="btn btn-primary">Set Rank</button>
          </form>
        </div>

        <!-- Manual EXP -->
        <div class="section">
          <h3>üìä Manual EXP Adjustment</h3>
          <form method="POST" class="exp-form">
            <input type="hidden" name="action" value="set_exp" />
            <input type="hidden" name="user_id" value={targetUser.id} />
            <div class="exp-input-row">
              <input type="number" name="exp" min="10" max="100" value={targetUser.creator_exp || 10} class="exp-input" />
              <span class="exp-range">/ 100 EXP</span>
              <button type="submit" class="btn btn-primary">Set EXP</button>
            </div>
            <p class="exp-hint">Setting EXP will automatically calculate the appropriate rank and multiplier.</p>
          </form>
        </div>

        <!-- User's Badges -->
        <div class="section">
          <h3>Badges ({userBadges.length})</h3>
          {userBadges.length > 0 ? (
            <div class="user-badges-list">
              {userBadges.map(ub => (
                <div class="user-badge-item">
                  <span class="badge-icon-small" style={`background: ${ub.badge.color}`}>{ub.badge.icon}</span>
                  <div class="badge-details">
                    <strong>{ub.badge.name}</strong>
                    <span class="badge-date">Awarded {new Date(ub.awarded_at).toLocaleDateString()}</span>
                  </div>
                  <form method="POST" class="remove-form">
                    <input type="hidden" name="action" value="remove_badge" />
                    <input type="hidden" name="user_badge_id" value={ub.id} />
                    <button type="submit" class="btn btn-small btn-danger">Remove</button>
                  </form>
                </div>
              ))}
            </div>
          ) : (
            <p class="empty-text">No badges awarded yet.</p>
          )}
        </div>

        <!-- Award Badge -->
        <div class="section">
          <h3>Award New Badge</h3>
          <form method="POST" class="award-form">
            <input type="hidden" name="action" value="award_badge" />
            <input type="hidden" name="user_id" value={targetUser.id} />
            <div class="form-row">
              <select name="badge_id" required>
                <option value="">Select Badge...</option>
                {allBadges?.filter(b => !userBadges.some(ub => ub.badge.id === b.id)).map(badge => (
                  <option value={badge.id}>{badge.icon} {badge.name}</option>
                ))}
              </select>
              <input type="text" name="notes" placeholder="Notes (optional)" />
              <button type="submit" class="btn btn-primary">Award</button>
            </div>
          </form>
        </div>
      </div>
    )}

    <!-- All Badges Tab -->
    {tab === 'badges' && (
      <div class="panel">
        <h2>All Badges ({allBadges?.length || 0})</h2>
        <div class="badges-grid">
          {allBadges?.map(badge => (
            <a href={`/admin/badges?badge=${badge.slug}`} class="badge-card clickable">
              <span class="badge-icon-large" style={`background: ${badge.color}`}>{badge.icon}</span>
              <div class="badge-info">
                <strong>{badge.name}</strong>
                <span class="badge-category">{badge.category}</span>
                <p>{badge.description}</p>
                <span class="badge-count">{badgeCountMap[badge.id] || 0} users</span>
              </div>
            </a>
          ))}
        </div>
      </div>
    )}

    <!-- Award Badge Tab -->
    {tab === 'award' && (
      <div class="panel">
        <h2>Award Badge to User</h2>
        <form method="POST" class="award-form-large">
          <input type="hidden" name="action" value="award_badge" />
          
          <div class="form-group">
            <label>User</label>
            <select name="user_id" required>
              <option value="">Select User...</option>
              {allUsers?.map(user => (
                <option value={user.id}>
                  {user.full_name || user.username || user.email} ({user.role})
                </option>
              ))}
            </select>
          </div>

          <div class="form-group">
            <label>Badge</label>
            <select name="badge_id" required>
              <option value="">Select Badge...</option>
              {allBadges?.map(badge => (
                <option value={badge.id}>{badge.icon} {badge.name} ({badge.category})</option>
              ))}
            </select>
          </div>

          <div class="form-group">
            <label>Notes (optional)</label>
            <input type="text" name="notes" placeholder="Reason for awarding..." />
          </div>

          <button type="submit" class="btn btn-primary">üèÜ Award Badge</button>
        </form>

        <h3 style="margin-top: 2rem;">Recent Awards</h3>
        <div class="recent-awards">
          {recentAwards?.map(award => (
            <div class="award-item">
              <span class="badge-icon-small" style={`background: ${award.badge?.color}`}>{award.badge?.icon}</span>
              <div>
                <strong>{award.badge?.name}</strong> ‚Üí {award.user?.full_name || award.user?.email}
                <span class="award-date">{new Date(award.awarded_at).toLocaleDateString()}</span>
              </div>
            </div>
          ))}
        </div>
      </div>
    )}

    <!-- Create Badge Tab -->
    {tab === 'create' && (
      <div class="panel">
        <h2>Create New Badge</h2>
        <form method="POST" class="create-form">
          <input type="hidden" name="action" value="create_badge" />
          
          <div class="form-row">
            <div class="form-group">
              <label>Name *</label>
              <input type="text" name="name" required placeholder="Badge Name" />
            </div>
            <div class="form-group">
              <label>Slug</label>
              <input type="text" name="slug" placeholder="badge-slug (auto-generated)" />
            </div>
          </div>

          <div class="form-group">
            <label>Description</label>
            <input type="text" name="description" placeholder="What this badge represents..." />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Icon (emoji)</label>
              <input type="text" name="icon" placeholder="üèÜ" maxlength="4" />
            </div>
            <div class="form-group">
              <label>Color</label>
              <input type="color" name="color" value="#f59e0b" />
            </div>
            <div class="form-group">
              <label>Category</label>
              <select name="category">
                <option value="special">Special</option>
                <option value="achievement">Achievement</option>
                <option value="milestone">Milestone</option>
                <option value="rank">Rank</option>
              </select>
            </div>
          </div>

          <button type="submit" class="btn btn-primary">Create Badge</button>
        </form>
      </div>
    )}
  </div>

  <style>
    .badges-page { max-width: 1000px; }

    .page-header { margin-bottom: 1.5rem; }
    .page-header h1 { font-size: 1.5rem; color: #1a1a2e; margin-bottom: 0.25rem; }
    .subtitle { color: #6b7280; }

    .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .tab { padding: 0.625rem 1rem; background: #f3f4f6; border-radius: 6px; text-decoration: none; color: #374151; font-size: 0.875rem; }
    .tab.active { background: #2563eb; color: white; }
    .tab:hover:not(.active) { background: #e5e7eb; }

    .panel { background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .panel h2 { font-size: 1.125rem; color: #1a1a2e; margin-bottom: 1rem; }
    .panel h3 { font-size: 1rem; color: #374151; margin-bottom: 0.75rem; }
    .panel-desc { color: #6b7280; margin-bottom: 1.5rem; }

    /* Ranks Table */
    .ranks-table { margin-bottom: 2rem; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
    .ranks-header { display: grid; grid-template-columns: 60px 100px 1fr 100px; padding: 0.75rem 1rem; background: #f9fafb; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: #6b7280; }
    .rank-row { display: grid; grid-template-columns: 60px 100px 1fr 100px; padding: 0.75rem 1rem; border-top: 1px solid #e5e7eb; align-items: center; transition: background 0.2s; }
    .rank-row:hover { background: #f9fafb; }
    .rank-exp { font-family: monospace; color: #6b7280; }
    .rank-badge { display: flex; align-items: center; gap: 0.5rem; }
    .rank-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; }
    .rank-title { font-weight: 500; color: var(--rank-color); }
    .rank-multiplier { font-family: monospace; font-weight: 600; color: #059669; }

    .rank-info-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
    .info-card { padding: 1rem; background: #f9fafb; border-radius: 8px; }
    .info-card h4 { font-size: 0.875rem; margin-bottom: 0.5rem; }
    .info-card p { font-size: 0.8125rem; color: #6b7280; margin: 0; }

    /* Current Rank Display */
    .current-rank-display { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; background: linear-gradient(135deg, color-mix(in srgb, var(--rank-color) 10%, white), white); border: 2px solid var(--rank-color); border-radius: 12px; margin-bottom: 1.5rem; }
    .rank-visual { display: flex; align-items: center; gap: 1rem; }
    .rank-icon-large { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.75rem; box-shadow: 0 4px 15px color-mix(in srgb, var(--rank-color) 40%, transparent); }
    .rank-details { display: flex; flex-direction: column; }
    .rank-level { font-size: 0.75rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.1em; }
    .rank-name { font-size: 1.25rem; font-weight: 700; color: var(--rank-color); }
    .rank-stats { display: flex; gap: 2rem; }
    .stat { text-align: center; }
    .stat-value { display: block; font-size: 1.5rem; font-weight: 700; color: #1a1a2e; }
    .stat-label { font-size: 0.6875rem; color: #6b7280; text-transform: uppercase; }

    /* Rank Select Grid */
    .rank-form { margin-top: 1rem; }
    .rank-select-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
    .rank-option { display: flex; flex-direction: column; align-items: center; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center; }
    .rank-option:hover { border-color: var(--opt-color); background: color-mix(in srgb, var(--opt-color) 5%, white); }
    .rank-option.selected { border-color: var(--opt-color); background: color-mix(in srgb, var(--opt-color) 10%, white); }
    .rank-option input { display: none; }
    .opt-icon { font-size: 1.5rem; margin-bottom: 0.25rem; }
    .opt-level { font-size: 0.6875rem; color: #6b7280; }
    .opt-title { font-weight: 600; font-size: 0.8125rem; color: var(--opt-color); margin: 0.25rem 0; }
    .opt-mult { font-family: monospace; font-size: 0.75rem; color: #059669; }

    /* EXP Form */
    .exp-form { margin-top: 0.75rem; }
    .exp-input-row { display: flex; align-items: center; gap: 0.75rem; }
    .exp-input { width: 100px; padding: 0.625rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1.125rem; font-weight: 600; text-align: center; }
    .exp-range { color: #6b7280; }
    .exp-hint { font-size: 0.75rem; color: #9ca3af; margin-top: 0.5rem; }

    .badge-header { display: flex; gap: 1.5rem; align-items: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid #e5e7eb; }
    .badge-header h2 { margin: 0 0 0.25rem 0; }
    .badge-desc { color: #6b7280; margin: 0 0 0.5rem 0; }
    .badge-meta { font-size: 0.75rem; color: #9ca3af; text-transform: uppercase; }

    .badge-icon-xlarge { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: white; flex-shrink: 0; }

    .users-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .user-row { display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; }
    .user-avatar-small { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #8b5cf6); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; overflow: hidden; flex-shrink: 0; }
    .user-avatar-small img { width: 100%; height: 100%; object-fit: cover; }
    .user-info { flex: 1; min-width: 0; }
    .user-info strong { display: block; font-size: 0.875rem; }
    .user-email { font-size: 0.75rem; color: #6b7280; }
    .user-meta { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    .role-tag { font-size: 0.625rem; padding: 0.125rem 0.5rem; border-radius: 999px; text-transform: uppercase; font-weight: 600; }
    .role-tag.creator { background: #d1fae5; color: #059669; }
    .role-tag.manager { background: #dbeafe; color: #2563eb; }
    .role-tag.admin { background: #fee2e2; color: #dc2626; }
    .role-tag.moderator { background: #fef3c7; color: #d97706; }
    .verified-tag { background: #10b981; color: white; font-size: 0.625rem; padding: 0.125rem 0.375rem; border-radius: 999px; }
    .level-tag { font-size: 0.625rem; padding: 0.125rem 0.5rem; border-radius: 4px; font-weight: 600; }
    .user-actions { display: flex; gap: 0.5rem; align-items: center; }
    .award-date { font-size: 0.75rem; color: #9ca3af; }

    .user-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb; }
    .user-meta-line { color: #6b7280; font-size: 0.875rem; }

    .section { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #e5e7eb; }
    .section:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }

    .verification-controls { display: flex; gap: 0.5rem; }

    .user-badges-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .user-badge-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; }
    .badge-details { flex: 1; }
    .badge-details strong { display: block; font-size: 0.875rem; }
    .badge-date { font-size: 0.75rem; color: #6b7280; }

    .badge-icon-small { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1rem; flex-shrink: 0; }
    .badge-icon-large { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; flex-shrink: 0; }

    .badges-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
    .badge-card { display: flex; gap: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px; text-decoration: none; color: inherit; transition: all 0.2s; }
    .badge-card.clickable:hover { background: #e5e7eb; transform: translateY(-2px); }
    .badge-info { flex: 1; }
    .badge-info strong { display: block; margin-bottom: 0.25rem; color: #1a1a2e; }
    .badge-info p { font-size: 0.8125rem; color: #6b7280; margin: 0.25rem 0; }
    .badge-category { font-size: 0.6875rem; text-transform: uppercase; color: #9ca3af; background: #e5e7eb; padding: 0.125rem 0.375rem; border-radius: 4px; }
    .badge-count { font-size: 0.75rem; color: #2563eb; font-weight: 500; }

    .award-form, .award-form-large, .create-form { margin-top: 1rem; }
    .form-row { display: flex; gap: 0.5rem; align-items: flex-end; flex-wrap: wrap; }
    .form-group { display: flex; flex-direction: column; gap: 0.375rem; margin-bottom: 1rem; flex: 1; min-width: 150px; }
    .form-group label { font-size: 0.8125rem; font-weight: 500; color: #374151; }
    .form-group input, .form-group select { padding: 0.625rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; }
    .form-group input[type="color"] { height: 38px; padding: 0.25rem; }

    .recent-awards { display: flex; flex-direction: column; gap: 0.5rem; }
    .award-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; font-size: 0.875rem; }

    .empty-text { color: #9ca3af; font-size: 0.875rem; }

    .btn { padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; border: none; cursor: pointer; text-decoration: none; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.375rem; }
    .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: #f3f4f6; color: #374151; }
    .btn-secondary:hover { background: #e5e7eb; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-small { padding: 0.25rem 0.5rem; font-size: 0.75rem; }

    .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    .alert.success { background: #d1fae5; color: #065f46; }
    .alert.error { background: #fee2e2; color: #991b1b; }

    .remove-form { margin: 0; }
  </style>
</AdminLayout>
