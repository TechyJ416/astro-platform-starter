---
// src/pages/admin/users/[id].astro
export const prerender = false;

import AdminLayout from "../../../layouts/AdminLayout.astro";
import { createClient } from "@supabase/supabase-js";

const { id } = Astro.params;
const isMasterKeySession = Astro.locals.isMasterKeySession || false;
const session = Astro.locals.session;

if (!isMasterKeySession && !session) {
  return Astro.redirect('/admin/login');
}

// Create admin client
const supabaseUrl = import.meta.env.SUPABASE_URL;
const supabaseServiceKey = import.meta.env.SUPABASE_SERVICE_KEY;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

const supabase = createClient(
  supabaseUrl,
  supabaseServiceKey || supabaseAnonKey,
  { auth: { autoRefreshToken: false, persistSession: false } }
);

// Fetch user profile
const { data: user, error: userError } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', id)
  .single();

if (!user || userError) {
  return Astro.redirect('/admin/users?error=not_found');
}

// Fetch user's campaign applications
const { data: applications } = await supabase
  .from('campaign_assignments')
  .select('*, campaigns(id, title, status)')
  .eq('creator_id', id)
  .order('assigned_at', { ascending: false });

// Fetch user's submissions
const { data: submissions } = await supabase
  .from('milestone_submissions')
  .select('*, campaign_milestones(title, payment_amount, campaigns(title))')
  .eq('creator_id', id)
  .order('submitted_at', { ascending: false })
  .limit(10);

// Fetch user's payments
const { data: payments } = await supabase
  .from('payments')
  .select('*, campaigns(title)')
  .eq('creator_id', id)
  .order('created_at', { ascending: false })
  .limit(10);

// Fetch payment profile
const { data: paymentProfile } = await supabase
  .from('creator_payment_profiles')
  .select('*')
  .eq('creator_id', id)
  .single();

// Handle actions
let actionMessage = '';
let actionError = '';

if (Astro.request.method === 'POST') {
  const form = await Astro.request.formData();
  const action = form.get('action') as string;

  if (action === 'update_status') {
    const newStatus = form.get('status') as string;
    const { error } = await supabase
      .from('profiles')
      .update({ 
        status: newStatus,
        is_active: newStatus === 'active',
        updated_at: new Date().toISOString(),
      })
      .eq('id', id);

    if (error) {
      actionError = error.message;
    } else {
      actionMessage = `Status updated to ${newStatus}`;
      user.status = newStatus;
      user.is_active = newStatus === 'active';
    }
  }

  if (action === 'update_role') {
    const newRole = form.get('role') as string;
    const { error } = await supabase
      .from('profiles')
      .update({ 
        role: newRole,
        updated_at: new Date().toISOString(),
      })
      .eq('id', id);

    if (error) {
      actionError = error.message;
    } else {
      actionMessage = `Role updated to ${newRole}`;
      user.role = newRole;
    }
  }

  if (action === 'add_note') {
    const note = form.get('note') as string;
    const existingNotes = user.admin_notes || '';
    const timestamp = new Date().toLocaleString();
    const newNotes = `${existingNotes}\n[${timestamp}] ${note}`.trim();
    
    const { error } = await supabase
      .from('profiles')
      .update({ 
        admin_notes: newNotes,
        updated_at: new Date().toISOString(),
      })
      .eq('id', id);

    if (error) {
      actionError = error.message;
    } else {
      actionMessage = 'Note added';
      user.admin_notes = newNotes;
    }
  }
}

// Stats
const totalApplications = applications?.length || 0;
const acceptedApplications = applications?.filter(a => a.status === 'accepted' || a.status === 'completed').length || 0;
const totalSubmissions = submissions?.length || 0;
const approvedSubmissions = submissions?.filter(s => s.status === 'approved').length || 0;
const totalEarned = payments?.filter(p => p.status === 'completed').reduce((sum, p) => sum + p.amount, 0) || 0;

function getStatusBadge(status: string) {
  const badges: Record<string, { label: string; class: string }> = {
    pending: { label: 'Pending', class: 'pending' },
    active: { label: 'Active', class: 'active' },
    suspended: { label: 'Suspended', class: 'suspended' },
    denied: { label: 'Denied', class: 'denied' },
  };
  return badges[status] || { label: status, class: 'default' };
}
---

<AdminLayout title={user.full_name || user.email}>
  {actionMessage && <div class="alert success">{actionMessage}</div>}
  {actionError && <div class="alert error">{actionError}</div>}

  <!-- Breadcrumb -->
  <nav class="breadcrumb">
    <a href="/admin/users">‚Üê Back to Users</a>
  </nav>

  <!-- Header -->
  <div class="user-header">
    <div class="user-avatar">
      {user.avatar_url ? (
        <img src={user.avatar_url} alt={user.full_name || 'User'} />
      ) : (
        <span>{user.full_name?.charAt(0) || user.email?.charAt(0)?.toUpperCase() || '?'}</span>
      )}
    </div>
    <div class="user-info">
      <h1>{user.full_name || 'No Name'}</h1>
      <p class="email">{user.email}</p>
      <div class="user-badges">
        <span class={`status-badge ${getStatusBadge(user.status).class}`}>
          {getStatusBadge(user.status).label}
        </span>
        <span class="role-badge">{user.role}</span>
      </div>
    </div>
    <div class="header-actions">
      <button type="button" class="btn btn-primary" id="view-as-user" data-user-id={user.id}>
        üëÅÔ∏è View as User
      </button>
      <a href={`mailto:${user.email}`} class="btn btn-secondary">üìß Email User</a>
    </div>
  </div>

  <script is:inline>
    document.getElementById('view-as-user')?.addEventListener('click', async function() {
      const userId = this.getAttribute('data-user-id');
      
      try {
        const response = await fetch('/api/admin/impersonate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'start', userId }),
        });
        
        const data = await response.json();
        
        if (response.ok) {
          window.location.href = '/dashboard';
        } else {
          alert('Error: ' + (data.error || 'Failed to start view mode'));
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });
  </script>

  <div class="content-grid">
    <!-- Main Content -->
    <div class="main-column">
      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value">{totalApplications}</div>
          <div class="stat-label">Applications</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{acceptedApplications}</div>
          <div class="stat-label">Accepted</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{totalSubmissions}</div>
          <div class="stat-label">Submissions</div>
        </div>
        <div class="stat-card highlight">
          <div class="stat-value">${totalEarned}</div>
          <div class="stat-label">Total Earned</div>
        </div>
      </div>

      <!-- Applications -->
      <div class="panel">
        <div class="panel-header">
          <h2>Campaign Applications</h2>
        </div>
        {applications && applications.length > 0 ? (
          <div class="list">
            {applications.map(app => (
              <div class="list-item">
                <div class="item-info">
                  <strong>{app.campaigns?.title || 'Unknown Campaign'}</strong>
                  <span class="date">{new Date(app.assigned_at).toLocaleDateString()}</span>
                </div>
                <span class={`status-badge ${app.status === 'accepted' ? 'active' : app.status === 'invited' ? 'pending' : 'denied'}`}>
                  {app.status === 'invited' ? 'Pending' : app.status}
                </span>
              </div>
            ))}
          </div>
        ) : (
          <div class="empty-state small">No applications yet</div>
        )}
      </div>

      <!-- Submissions -->
      <div class="panel">
        <div class="panel-header">
          <h2>Recent Submissions</h2>
        </div>
        {submissions && submissions.length > 0 ? (
          <div class="list">
            {submissions.map(sub => (
              <div class="list-item">
                <div class="item-info">
                  <strong>{sub.campaign_milestones?.title || 'Unknown Milestone'}</strong>
                  <span class="campaign">{sub.campaign_milestones?.campaigns?.title}</span>
                </div>
                <div class="item-meta">
                  <span class={`status-badge ${sub.status === 'approved' ? 'active' : sub.status === 'pending' ? 'pending' : 'denied'}`}>
                    {sub.status}
                  </span>
                  {sub.campaign_milestones?.payment_amount > 0 && (
                    <span class="amount">${sub.campaign_milestones.payment_amount}</span>
                  )}
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div class="empty-state small">No submissions yet</div>
        )}
      </div>

      <!-- Payments -->
      <div class="panel">
        <div class="panel-header">
          <h2>Payment History</h2>
        </div>
        {payments && payments.length > 0 ? (
          <div class="list">
            {payments.map(payment => (
              <div class="list-item">
                <div class="item-info">
                  <strong>${payment.amount}</strong>
                  <span class="desc">{payment.description || payment.campaigns?.title || 'Payment'}</span>
                </div>
                <div class="item-meta">
                  <span class={`status-badge ${payment.status === 'completed' ? 'active' : payment.status === 'pending' ? 'pending' : 'denied'}`}>
                    {payment.status}
                  </span>
                  <span class="date">{new Date(payment.created_at).toLocaleDateString()}</span>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div class="empty-state small">No payments yet</div>
        )}
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Quick Actions -->
      <div class="panel">
        <h3>Quick Actions</h3>
        
        <form method="POST" class="action-form">
          <label>Status</label>
          <div class="select-group">
            <select name="status">
              <option value="pending" selected={user.status === 'pending'}>Pending</option>
              <option value="active" selected={user.status === 'active'}>Active</option>
              <option value="suspended" selected={user.status === 'suspended'}>Suspended</option>
              <option value="denied" selected={user.status === 'denied'}>Denied</option>
            </select>
            <button type="submit" name="action" value="update_status" class="btn btn-sm btn-primary">
              Update
            </button>
          </div>
        </form>

        <form method="POST" class="action-form">
          <label>Role</label>
          <div class="select-group">
            <select name="role">
              <option value="creator" selected={user.role === 'creator'}>Creator</option>
              <option value="moderator" selected={user.role === 'moderator'}>Moderator</option>
              <option value="admin" selected={user.role === 'admin'}>Admin</option>
            </select>
            <button type="submit" name="action" value="update_role" class="btn btn-sm btn-primary">
              Update
            </button>
          </div>
        </form>
      </div>

      <!-- User Details -->
      <div class="panel">
        <h3>Details</h3>
        <div class="details-list">
          <div class="detail">
            <span class="label">User ID</span>
            <span class="value mono">{user.id.substring(0, 8)}...</span>
          </div>
          <div class="detail">
            <span class="label">Joined</span>
            <span class="value">{new Date(user.created_at).toLocaleDateString()}</span>
          </div>
          <div class="detail">
            <span class="label">Last Updated</span>
            <span class="value">{user.updated_at ? new Date(user.updated_at).toLocaleDateString() : 'Never'}</span>
          </div>
          <div class="detail">
            <span class="label">Verified</span>
            <span class="value">{user.is_verified ? '‚úì Yes' : '‚úï No'}</span>
          </div>
        </div>
      </div>

      <!-- Payment Info -->
      <div class="panel">
        <h3>Payment Setup</h3>
        {paymentProfile ? (
          <div class="details-list">
            <div class="detail">
              <span class="label">Stripe Connected</span>
              <span class="value">{paymentProfile.stripe_onboarding_complete ? '‚úì Yes' : '‚úï No'}</span>
            </div>
            <div class="detail">
              <span class="label">Total Earned</span>
              <span class="value">${paymentProfile.total_earned?.toFixed(2) || '0.00'}</span>
            </div>
            <div class="detail">
              <span class="label">Total Paid Out</span>
              <span class="value">${paymentProfile.total_paid_out?.toFixed(2) || '0.00'}</span>
            </div>
          </div>
        ) : (
          <p class="empty-hint">No payment profile</p>
        )}
      </div>

      <!-- Bio -->
      {user.bio && (
        <div class="panel">
          <h3>Bio</h3>
          <p class="bio-text">{user.bio}</p>
        </div>
      )}

      <!-- Admin Notes -->
      <div class="panel">
        <h3>Admin Notes</h3>
        {user.admin_notes && (
          <pre class="notes-content">{user.admin_notes}</pre>
        )}
        <form method="POST" class="note-form">
          <textarea name="note" rows="2" placeholder="Add a note..."></textarea>
          <button type="submit" name="action" value="add_note" class="btn btn-sm btn-secondary">
            Add Note
          </button>
        </form>
      </div>
    </div>
  </div>

  <style>
    .breadcrumb {
      margin-bottom: 1.5rem;
    }

    .breadcrumb a {
      color: #6b7280;
      text-decoration: none;
      font-size: 0.875rem;
    }

    .breadcrumb a:hover {
      color: #2563eb;
    }

    .alert {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .alert.success { background: #d1fae5; color: #065f46; }
    .alert.error { background: #fee2e2; color: #991b1b; }

    /* Header */
    .user-header {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #dbeafe, #c7d2fe);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: 600;
      color: #2563eb;
      overflow: hidden;
      flex-shrink: 0;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-info {
      flex: 1;
    }

    .user-info h1 {
      font-size: 1.5rem;
      color: #1a1a2e;
      margin: 0 0 0.25rem;
    }

    .user-info .email {
      color: #6b7280;
      margin: 0 0 0.75rem;
    }

    .user-badges {
      display: flex;
      gap: 0.5rem;
    }

    .status-badge {
      font-size: 0.6875rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-badge.active { background: #d1fae5; color: #059669; }
    .status-badge.pending { background: #fef3c7; color: #d97706; }
    .status-badge.suspended { background: #fee2e2; color: #dc2626; }
    .status-badge.denied { background: #f3f4f6; color: #6b7280; }

    .role-badge {
      font-size: 0.6875rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-weight: 600;
      text-transform: uppercase;
      background: #dbeafe;
      color: #2563eb;
    }

    .header-actions {
      flex-shrink: 0;
    }

    /* Content Grid */
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 1.5rem;
      align-items: start;
    }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      background: white;
      padding: 1rem;
      border-radius: 10px;
      text-align: center;
    }

    .stat-card.highlight {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
    }

    .stat-card .stat-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1a1a2e;
    }

    .stat-card .stat-label {
      font-size: 0.75rem;
      color: #6b7280;
    }

    /* Panels */
    .panel {
      background: white;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      overflow: hidden;
    }

    .panel-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .panel-header h2 {
      font-size: 1rem;
      color: #1a1a2e;
      margin: 0;
    }

    .sidebar .panel {
      padding: 1.25rem;
    }

    .sidebar h3 {
      font-size: 0.9375rem;
      color: #1a1a2e;
      margin: 0 0 1rem;
    }

    /* Lists */
    .list {
      padding: 0;
    }

    .list-item {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .item-info strong {
      display: block;
      color: #1a1a2e;
      font-size: 0.9375rem;
    }

    .item-info .date,
    .item-info .campaign,
    .item-info .desc {
      font-size: 0.8125rem;
      color: #6b7280;
    }

    .item-meta {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .item-meta .amount {
      font-weight: 600;
      color: #059669;
    }

    .item-meta .date {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    /* Details */
    .details-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .detail {
      display: flex;
      justify-content: space-between;
      font-size: 0.875rem;
    }

    .detail .label {
      color: #6b7280;
    }

    .detail .value {
      font-weight: 500;
      color: #1a1a2e;
    }

    .detail .value.mono {
      font-family: monospace;
    }

    /* Forms */
    .action-form {
      margin-bottom: 1rem;
    }

    .action-form label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.375rem;
    }

    .select-group {
      display: flex;
      gap: 0.5rem;
    }

    .select-group select {
      flex: 1;
      padding: 0.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.875rem;
    }

    .note-form textarea {
      width: 100%;
      padding: 0.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
      resize: vertical;
      font-family: inherit;
    }

    .notes-content {
      background: #f9fafb;
      padding: 0.75rem;
      border-radius: 8px;
      font-size: 0.8125rem;
      white-space: pre-wrap;
      word-break: break-word;
      margin: 0 0 1rem;
      max-height: 200px;
      overflow-y: auto;
    }

    .bio-text {
      font-size: 0.875rem;
      color: #4b5563;
      line-height: 1.6;
      margin: 0;
    }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: #6b7280;
    }

    .empty-state.small {
      padding: 1rem;
      font-size: 0.875rem;
    }

    .empty-hint {
      font-size: 0.875rem;
      color: #9ca3af;
      text-align: center;
    }

    /* Buttons */
    .btn {
      padding: 0.625rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.875rem;
      border: none;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.8125rem;
    }

    .btn-primary { background: #2563eb; color: white; }
    .btn-secondary { background: #f3f4f6; color: #374151; }

    @media (max-width: 900px) {
      .content-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .user-header {
        flex-wrap: wrap;
      }
    }
  </style>
</AdminLayout>
