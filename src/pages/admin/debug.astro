---
// src/pages/admin/debug.astro
export const prerender = false;

import AdminLayout from "../../layouts/AdminLayout.astro";
import { createClient } from "@supabase/supabase-js";

const isMasterKeySession = Astro.locals.isMasterKeySession || false;
const session = Astro.locals.session;

if (!isMasterKeySession && !session) {
  return Astro.redirect('/admin/login');
}

// Check environment variables
const supabaseUrl = import.meta.env.SUPABASE_URL;
const anonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
const serviceKey = import.meta.env.SUPABASE_SERVICE_KEY;

const checks = {
  SUPABASE_URL: !!supabaseUrl,
  SUPABASE_URL_VALUE: supabaseUrl ? `${supabaseUrl.substring(0, 30)}...` : 'NOT SET',
  PUBLIC_SUPABASE_ANON_KEY: !!anonKey,
  ANON_KEY_PREFIX: anonKey ? `${anonKey.substring(0, 20)}...` : 'NOT SET',
  SUPABASE_SERVICE_KEY: !!serviceKey,
  SERVICE_KEY_PREFIX: serviceKey ? `${serviceKey.substring(0, 20)}...` : 'NOT SET',
  SERVICE_KEY_LENGTH: serviceKey ? serviceKey.length : 0,
  ADMIN_MASTER_KEY: !!import.meta.env.ADMIN_MASTER_KEY,
};

// Check if service key looks valid (should be longer than anon key and start with eyJ)
const serviceKeyValid = serviceKey && serviceKey.startsWith('eyJ') && serviceKey.length > 200;
const keysAreDifferent = serviceKey !== anonKey;

// Test database connection with service key
let dbTests: any[] = [];

if (serviceKey) {
  const supabase = createClient(
    supabaseUrl,
    serviceKey,
    { auth: { autoRefreshToken: false, persistSession: false } }
  );

  // Test 1: Read profiles
  try {
    const { data, error } = await supabase.from('profiles').select('id').limit(1);
    dbTests.push({
      name: 'Read profiles',
      success: !error,
      message: error ? error.message : `Success (${data?.length || 0} rows)`
    });
  } catch (e: any) {
    dbTests.push({ name: 'Read profiles', success: false, message: e.message });
  }

  // Test 2: Read all campaigns (including drafts - tests admin access)
  try {
    const { data, error } = await supabase.from('campaigns').select('id, status').limit(5);
    dbTests.push({
      name: 'Read campaigns (all statuses)',
      success: !error,
      message: error ? error.message : `Success (${data?.length || 0} rows: ${data?.map(c => c.status).join(', ') || 'none'})`
    });
  } catch (e: any) {
    dbTests.push({ name: 'Read campaigns', success: false, message: e.message });
  }

  // Test 3: Insert campaign
  try {
    const testSlug = `__test__${Date.now()}`;
    const { data, error } = await supabase
      .from('campaigns')
      .insert({ title: '__DEBUG_TEST__', slug: testSlug, status: 'draft' })
      .select()
      .single();
    
    if (error) {
      dbTests.push({
        name: 'INSERT campaign',
        success: false,
        message: `FAILED: ${error.message} (code: ${error.code})`
      });
    } else {
      dbTests.push({
        name: 'INSERT campaign',
        success: true,
        message: `Success! Created ID: ${data.id}`
      });
      
      // Clean up
      const { error: deleteError } = await supabase.from('campaigns').delete().eq('id', data.id);
      dbTests.push({
        name: 'DELETE campaign (cleanup)',
        success: !deleteError,
        message: deleteError ? deleteError.message : 'Cleaned up test record'
      });
    }
  } catch (e: any) {
    dbTests.push({ name: 'INSERT campaign', success: false, message: `Exception: ${e.message}` });
  }

  // Test 4: Insert community
  try {
    const testSlug = `__test__${Date.now()}`;
    const { data, error } = await supabase
      .from('communities')
      .insert({ name: '__DEBUG_TEST__', slug: testSlug })
      .select()
      .single();
    
    if (error) {
      dbTests.push({
        name: 'INSERT community',
        success: false,
        message: `FAILED: ${error.message} (code: ${error.code})`
      });
    } else {
      dbTests.push({
        name: 'INSERT community',
        success: true,
        message: `Success! Created ID: ${data.id}`
      });
      await supabase.from('communities').delete().eq('id', data.id);
    }
  } catch (e: any) {
    dbTests.push({ name: 'INSERT community', success: false, message: `Exception: ${e.message}` });
  }
}

// Session info
const sessionInfo = {
  isMasterKeySession,
  hasAuthSession: !!session,
  userId: session?.user?.id || 'N/A (Master Key Login)',
  userEmail: session?.user?.email || 'N/A (Master Key Login)',
};
---

<AdminLayout title="Debug Info">
  <div class="debug-page">
    <h1>üîß Admin Debug Info</h1>
    <p class="subtitle">Diagnosing RLS and configuration issues</p>

    <!-- Environment Variables -->
    <div class="panel">
      <h2>Environment Variables</h2>
      <table class="debug-table">
        <tbody>
          <tr>
            <td><code>SUPABASE_URL</code></td>
            <td class={checks.SUPABASE_URL ? 'success' : 'error'}>
              {checks.SUPABASE_URL ? '‚úÖ' : '‚ùå'} {checks.SUPABASE_URL_VALUE}
            </td>
          </tr>
          <tr>
            <td><code>PUBLIC_SUPABASE_ANON_KEY</code></td>
            <td class={checks.PUBLIC_SUPABASE_ANON_KEY ? 'success' : 'error'}>
              {checks.PUBLIC_SUPABASE_ANON_KEY ? '‚úÖ' : '‚ùå'} {checks.ANON_KEY_PREFIX}
            </td>
          </tr>
          <tr class="highlight">
            <td><code>SUPABASE_SERVICE_KEY</code></td>
            <td class={checks.SUPABASE_SERVICE_KEY ? 'success' : 'error'}>
              {checks.SUPABASE_SERVICE_KEY ? '‚úÖ' : '‚ùå'} {checks.SERVICE_KEY_PREFIX} ({checks.SERVICE_KEY_LENGTH} chars)
            </td>
          </tr>
        </tbody>
      </table>
      
      <div class="key-checks">
        <p>Service key starts with 'eyJ': {serviceKeyValid ? '‚úÖ Yes' : '‚ùå No'}</p>
        <p>Service key ‚â† Anon key: {keysAreDifferent ? '‚úÖ Different' : '‚ùå SAME KEY - THIS IS THE PROBLEM!'}</p>
      </div>
    </div>

    <!-- Session Info -->
    <div class="panel">
      <h2>Current Session</h2>
      <table class="debug-table">
        <tbody>
          <tr>
            <td>Login Type</td>
            <td><strong>{sessionInfo.isMasterKeySession ? 'üîë Master Key' : 'üë§ Email/Password'}</strong></td>
          </tr>
          <tr>
            <td>auth.uid() available</td>
            <td class={sessionInfo.hasAuthSession ? 'success' : 'error'}>
              {sessionInfo.hasAuthSession ? '‚úÖ Yes' : '‚ùå No - RLS policies using auth.uid() will FAIL'}
            </td>
          </tr>
          <tr>
            <td>User ID</td>
            <td><code>{sessionInfo.userId}</code></td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Database Tests -->
    <div class="panel">
      <h2>Database Tests (using service_role key)</h2>
      {dbTests.length > 0 ? (
        <div class="test-results">
          {dbTests.map(test => (
            <div class={`test-result ${test.success ? 'success' : 'error'}`}>
              <span class="test-name">{test.name}</span>
              <span class="test-status">{test.success ? '‚úÖ' : '‚ùå'}</span>
              <span class="test-message">{test.message}</span>
            </div>
          ))}
        </div>
      ) : (
        <p class="error">Cannot run tests - SUPABASE_SERVICE_KEY not set</p>
      )}
    </div>

    <!-- Diagnosis -->
    <div class="panel diagnosis">
      <h2>Diagnosis</h2>
      {!keysAreDifferent && (
        <div class="issue critical">
          <h3>üö® CRITICAL: Service key is same as anon key!</h3>
          <p>You're using the <strong>anon</strong> key instead of the <strong>service_role</strong> key.</p>
          <p>Go to Supabase Dashboard ‚Üí Project Settings ‚Üí API and copy the <strong>service_role</strong> secret key.</p>
        </div>
      )}
      
      {!serviceKeyValid && checks.SUPABASE_SERVICE_KEY && (
        <div class="issue warning">
          <h3>‚ö†Ô∏è Service key format looks wrong</h3>
          <p>The key should start with 'eyJ' and be ~300+ characters. Current length: {checks.SERVICE_KEY_LENGTH}</p>
        </div>
      )}

      {sessionInfo.isMasterKeySession && !sessionInfo.hasAuthSession && (
        <div class="issue info">
          <h3>‚ÑπÔ∏è Master Key Login = No auth.uid()</h3>
          <p>This is expected. Master key login doesn't create a Supabase session, so <code>auth.uid()</code> is NULL.</p>
          <p>The service_role key should bypass RLS entirely, making this irrelevant IF the service key is correct.</p>
        </div>
      )}

      {dbTests.every(t => t.success) && (
        <div class="issue success">
          <h3>‚úÖ All tests passed!</h3>
          <p>Database operations work with the service key. If you're still seeing errors, check:</p>
          <ul>
            <li>Did you redeploy after adding the env var?</li>
            <li>Is the env var set in your hosting provider (Vercel/Netlify)?</li>
            <li>Try clearing browser cache and cookies</li>
          </ul>
        </div>
      )}
    </div>
  </div>

  <style>
    .debug-page { max-width: 900px; }
    .debug-page h1 { font-size: 1.5rem; color: #1a1a2e; margin-bottom: 0.25rem; }
    .subtitle { color: #6b7280; margin-bottom: 2rem; }
    
    .panel { background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .panel h2 { font-size: 1.125rem; color: #1a1a2e; margin-bottom: 1rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; }
    
    .debug-table { width: 100%; border-collapse: collapse; }
    .debug-table td { padding: 0.75rem; border-bottom: 1px solid #e5e7eb; }
    .debug-table td:first-child { font-weight: 500; width: 250px; }
    .debug-table tr.highlight { background: #fef3c7; }
    .debug-table code { background: #f3f4f6; padding: 0.125rem 0.375rem; border-radius: 4px; font-size: 0.8125rem; }
    .debug-table .success { color: #065f46; }
    .debug-table .error { color: #991b1b; font-weight: 600; }
    
    .key-checks { margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px; }
    .key-checks p { margin: 0.25rem 0; font-size: 0.875rem; }
    
    .test-results { display: flex; flex-direction: column; gap: 0.5rem; }
    .test-result { display: grid; grid-template-columns: 200px 30px 1fr; gap: 0.5rem; padding: 0.75rem; border-radius: 8px; align-items: center; }
    .test-result.success { background: #d1fae5; }
    .test-result.error { background: #fee2e2; }
    .test-name { font-weight: 600; }
    .test-message { font-size: 0.875rem; color: #4b5563; }
    
    .diagnosis .issue { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    .issue.critical { background: #fee2e2; border: 2px solid #ef4444; }
    .issue.warning { background: #fef3c7; border: 2px solid #f59e0b; }
    .issue.info { background: #dbeafe; border: 2px solid #3b82f6; }
    .issue.success { background: #d1fae5; border: 2px solid #10b981; }
    .issue h3 { margin: 0 0 0.5rem 0; font-size: 1rem; }
    .issue p { margin: 0.25rem 0; font-size: 0.875rem; }
    .issue ul { margin: 0.5rem 0; padding-left: 1.25rem; font-size: 0.875rem; }
  </style>
</AdminLayout>
