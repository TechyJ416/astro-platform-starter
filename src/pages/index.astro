---
// src/pages/index.astro
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";
import { getPageContent } from "../lib/content";

// Load editable page content
const content = await getPageContent('home');

// Get current user session
const session = Astro.locals.session;
const user = session?.user;

// Load user profile if logged in
let userProfile = null;
if (user?.id) {
  const { data } = await supabase.from('profiles').select('*').eq('id', user.id).single();
  userProfile = data;
}

// Check if user account is pending
const isPending = userProfile?.status === 'pending';
const isApproved = userProfile?.status === 'active' && userProfile?.is_active;

// Load settings
let general = {
  siteName: 'Banity',
  tagline: 'Create Authentic Content. Get Paid.',
  description: 'Banity connects creators with brands for authentic UGC campaigns.',
};

let appearance = {
  primaryColor: '#2563eb',
  accentColor: '#059669',
};

try {
  const { data: rows } = await supabase.from('site_settings').select('key, value');
  if (rows) {
    for (const row of rows) {
      if (row.key === 'general') general = { ...general, ...row.value };
      if (row.key === 'appearance') appearance = { ...appearance, ...row.value };
    }
  }
} catch (e) {}

// Load announcements
let announcements: any[] = [];
try {
  const { data } = await supabase
    .from('messages')
    .select('id, subject, body, created_at')
    .eq('is_announcement', true)
    .order('created_at', { ascending: false })
    .limit(5);
  if (data) announcements = data;
} catch (e) {}

// Load active campaigns - only for approved users or public preview
let campaigns: any[] = [];
const showCampaigns = !user || isApproved; // Show if not logged in (public preview) or approved
if (showCampaigns) {
  const { data } = await supabase
    .from('campaigns')
    .select('id, title, slug, description, budget, payment_per_post, deadline, status')
    .eq('status', 'active')
    .order('created_at', { ascending: false })
    .limit(6);
  if (data) campaigns = data;
}

// Load communities
let communities: any[] = [];
const { data: communityData } = await supabase
  .from('communities')
  .select('id, name, slug, description')
  .order('created_at', { ascending: false })
  .limit(4);
if (communityData) communities = communityData;

// Load recent forum topics
let forumTopics: any[] = [];
try {
  const { data: topicData } = await supabase
    .from('forum_topics')
    .select(`
      id, title, content, created_at, reply_count, view_count,
      author:profiles!forum_topics_user_id_fkey(full_name, avatar_url, is_premium, role)
    `)
    .order('last_reply_at', { ascending: false })
    .limit(5);
  if (topicData) forumTopics = topicData;
} catch (e) { /* table may not exist */ }

// Stats
const { count: creatorCount } = await supabase.from('profiles').select('*', { count: 'exact', head: true }).eq('role', 'creator').eq('status', 'active');
const { count: campaignCount } = await supabase.from('campaigns').select('*', { count: 'exact', head: true }).eq('status', 'active');
---

<Layout>
  {/* Announcements Bar */}
  {announcements.length > 0 && (
    <div class="announcements-bar">
      <div class="announcements-container">
        {announcements.map((a, i) => (
          <div class="announcement" data-index={i} style={i > 0 ? 'display: none;' : ''}>
            <span class="announcement-icon">üì¢</span>
            <div class="announcement-content">
              <strong>{a.subject}</strong>
              {a.body && <span class="announcement-body">{a.body.substring(0, 100)}{a.body.length > 100 ? '...' : ''}</span>}
            </div>
          </div>
        ))}
        {announcements.length > 1 && (
          <div class="announcement-nav">
            <button class="nav-btn prev" aria-label="Previous">‚Äπ</button>
            <span class="announcement-count"><span class="current">1</span> / {announcements.length}</span>
            <button class="nav-btn next" aria-label="Next">‚Ä∫</button>
          </div>
        )}
      </div>
    </div>
  )}

  {/* Pending Account Notice */}
  {isPending && (
    <div class="pending-notice">
      <div class="pending-content">
        <span class="pending-icon">‚è≥</span>
        <div>
          <h3>Your account is pending approval</h3>
          <p>We're reviewing your application. You'll receive an email once approved. In the meantime, feel free to explore!</p>
        </div>
      </div>
    </div>
  )}

  {/* Hero Section */}
  <section class="hero" style={`--primary: ${appearance.primaryColor}; --accent: ${appearance.accentColor};`}>
    <div class="hero-content">
      {content.hero?.badge && <span class="hero-badge">{content.hero.badge}</span>}
      <h1>{content.hero?.title || general.tagline}</h1>
      <p class="hero-desc">{content.hero?.subtitle || general.description}</p>
      <div class="hero-buttons">
        {user ? (
          isApproved ? (
            <a href="/dashboard" class="btn btn-primary">Go to Dashboard</a>
          ) : (
            <span class="btn btn-disabled">Awaiting Approval</span>
          )
        ) : (
          <>
            <a href={content.hero?.cta_primary?.link || "/signup"} class="btn btn-primary">
              {content.hero?.cta_primary?.text || "Join as Creator"}
            </a>
            <a href={content.hero?.cta_secondary?.link || "/campaigns"} class="btn btn-secondary">
              {content.hero?.cta_secondary?.text || "Browse Campaigns"}
            </a>
          </>
        )}
      </div>
    </div>
    
    <div class="stats-container">
      <div class="stat">
        <span class="stat-value">{content.stats?.creators || `${creatorCount || 0}+`}</span>
        <span class="stat-label">Creators</span>
      </div>
      <div class="stat">
        <span class="stat-value">{content.stats?.campaigns || campaignCount || 0}</span>
        <span class="stat-label">Active Campaigns</span>
      </div>
      <div class="stat">
        <span class="stat-value">{content.stats?.paid_out || "$50k+"}</span>
        <span class="stat-label">Paid Out</span>
      </div>
    </div>
  </section>

  {/* Active Campaigns Section */}
  {showCampaigns && campaigns.length > 0 && (
    <section class="section campaigns-section">
      <div class="section-header">
        <div>
          <h2>üî• Active Campaigns</h2>
          <p>Join these campaigns and start earning</p>
        </div>
        {isApproved && <a href="/campaigns" class="btn btn-secondary">View All ‚Üí</a>}
      </div>
      
      <div class="campaigns-grid">
        {campaigns.map(campaign => (
          <div class="campaign-card">
            <div class="campaign-header">
              <h3>{campaign.title}</h3>
              <span class="campaign-badge">Active</span>
            </div>
            {campaign.description && (
              <p class="campaign-desc">{campaign.description.substring(0, 100)}{campaign.description.length > 100 ? '...' : ''}</p>
            )}
            <div class="campaign-meta">
              {campaign.payment_per_post && (
                <span class="meta-item">üí∞ ${campaign.payment_per_post}/post</span>
              )}
              {campaign.deadline && (
                <span class="meta-item">üìÖ {new Date(campaign.deadline).toLocaleDateString()}</span>
              )}
            </div>
            <div class="campaign-footer">
              {isApproved ? (
                <a href={`/campaigns/${campaign.slug}`} class="btn btn-primary btn-sm">Apply Now</a>
              ) : user ? (
                <span class="btn btn-disabled btn-sm">Account Pending</span>
              ) : (
                <a href="/signup" class="btn btn-primary btn-sm">Join to Apply</a>
              )}
            </div>
          </div>
        ))}
      </div>

      {!user && (
        <div class="login-prompt">
          <p>üîê <a href="/signup">Create an account</a> to apply for campaigns and start earning.</p>
        </div>
      )}
    </section>
  )}

  {/* Community Forum Section */}
  <section class="section forum-section">
    <div class="section-header">
      <div>
        <h2>üí¨ Community Forum</h2>
        <p>Connect, share tips, and grow with fellow creators</p>
      </div>
      <a href="/forum" class="btn btn-secondary">View All Discussions ‚Üí</a>
    </div>
    
    <div class="forum-preview">
      {forumTopics.length > 0 ? (
        <div class="forum-topics-list">
          {forumTopics.map(topic => (
            <a href={`/forum/topic/${topic.id}`} class="forum-topic-card">
              <div class="topic-avatar">
                {topic.author?.avatar_url ? (
                  <img src={topic.author.avatar_url} alt="" />
                ) : (
                  <span>{(topic.author?.full_name || '?').charAt(0).toUpperCase()}</span>
                )}
              </div>
              <div class="topic-content">
                <h4>{topic.title}</h4>
                <p>{topic.content.substring(0, 100)}{topic.content.length > 100 ? '...' : ''}</p>
                <div class="topic-meta">
                  <span class="topic-author">
                    {topic.author?.full_name || 'Anonymous'}
                    {topic.author?.is_premium && <span class="premium-star">‚≠ê</span>}
                    {topic.author?.role === 'admin' && <span class="admin-badge">Admin</span>}
                  </span>
                  <span class="topic-stats">
                    üí¨ {topic.reply_count || 0} replies ‚Ä¢ üëÅÔ∏è {topic.view_count || 0} views
                  </span>
                </div>
              </div>
            </a>
          ))}
        </div>
      ) : (
        <div class="forum-empty">
          <span>üí¨</span>
          <h4>No discussions yet</h4>
          <p>Be the first to start a conversation!</p>
        </div>
      )}

      <div class="forum-cta">
        {user ? (
          <a href="/forum" class="btn btn-primary">Join the Discussion</a>
        ) : (
          <>
            <p>Sign in to post and engage with the community</p>
            <a href="/signup" class="btn btn-primary">Create Account</a>
          </>
        )}
      </div>
    </div>
  </section>

  {/* How It Works */}
  <section class="section how-it-works">
    <h2>How {general.siteName} Works</h2>
    <div class="features-grid">
      <div class="feature">
        <div class="feature-icon">1</div>
        <h3>Join the Waitlist</h3>
        <p>Sign up and get approved to access exclusive campaigns.</p>
      </div>
      <div class="feature">
        <div class="feature-icon">2</div>
        <h3>Browse Campaigns</h3>
        <p>Find brands looking for authentic content creators like you.</p>
      </div>
      <div class="feature">
        <div class="feature-icon">3</div>
        <h3>Create & Submit</h3>
        <p>Create engaging UGC content and submit for review.</p>
      </div>
      <div class="feature">
        <div class="feature-icon">4</div>
        <h3>Get Paid</h3>
        <p>Receive payment directly to your account upon approval.</p>
      </div>
    </div>
  </section>

  {/* CTA Section */}
  {!user && (
    <section class="cta-section" style={`background: linear-gradient(135deg, ${appearance.primaryColor}, ${appearance.accentColor});`}>
      <h2>Ready to Start Creating?</h2>
      <p>Join our waitlist and be among the first to access new campaigns.</p>
      <a href="/signup" class="btn btn-white">Join the Waitlist</a>
    </section>
  )}

  <style>
    .hero {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding: 5rem 2rem 4rem;
      text-align: center;
    }
    
    .hero-content {
      max-width: 700px;
      margin: 0 auto;
    }

    .hero-badge {
      display: inline-block;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: white;
      padding: 0.5rem 1.25rem;
      border-radius: 100px;
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
    }
    
    .hero h1 {
      font-size: 3rem;
      color: #1a1a2e;
      margin-bottom: 1rem;
      line-height: 1.2;
    }
    
    .hero-desc {
      font-size: 1.25rem;
      color: #64748b;
      margin-bottom: 2rem;
    }
    
    .hero-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 0.875rem 2rem;
      border-radius: 10px;
      font-weight: 600;
      font-size: 1rem;
      text-decoration: none;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      border: none;
      cursor: pointer;
    }
    
    .btn-primary { background: var(--primary, #2563eb); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
    .btn-secondary { background: white; color: #374151; border: 2px solid #e5e7eb; }
    .btn-secondary:hover { border-color: #d1d5db; background: #f9fafb; }
    .btn-white { background: white; color: #1a1a2e; }
    .btn-white:hover { transform: translateY(-2px); }
    .btn-disabled { background: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
    .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
    
    .stats-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2rem;
      max-width: 600px;
      margin: 3rem auto 0;
    }
    
    .stat {
      text-align: center;
    }
    
    .stat-value {
      display: block;
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary, #2563eb);
    }
    
    .stat-label {
      font-size: 0.875rem;
      color: #64748b;
    }

    /* Sections */
    .section {
      padding: 4rem 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 2rem;
    }
    
    .section-header h2 {
      font-size: 1.75rem;
      color: #1a1a2e;
      margin-bottom: 0.25rem;
    }
    
    .section-header p {
      color: #64748b;
    }

    /* Campaigns */
    .campaigns-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.5rem;
    }
    
    .campaign-card {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
    }
    
    .campaign-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }
    
    .campaign-header h3 {
      font-size: 1.125rem;
      color: #1a1a2e;
    }
    
    .campaign-badge {
      font-size: 0.6875rem;
      padding: 0.25rem 0.5rem;
      background: #d1fae5;
      color: #059669;
      border-radius: 6px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .campaign-desc {
      font-size: 0.9375rem;
      color: #64748b;
      margin-bottom: 1rem;
      flex: 1;
    }
    
    .campaign-meta {
      display: flex;
      gap: 1rem;
      font-size: 0.8125rem;
      color: #64748b;
      margin-bottom: 1rem;
    }
    
    .campaign-footer {
      border-top: 1px solid #f0f0f0;
      padding-top: 1rem;
    }

    /* Forum Section */
    .forum-section {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    }

    .forum-preview {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .forum-topics-list {
      display: flex;
      flex-direction: column;
    }

    .forum-topic-card {
      display: flex;
      gap: 1rem;
      padding: 1.25rem 1.5rem;
      text-decoration: none;
      border-bottom: 1px solid #e5e7eb;
      transition: all 0.2s;
    }

    .forum-topic-card:hover {
      background: #f9fafb;
    }

    .forum-topic-card:last-child {
      border-bottom: none;
    }

    .topic-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #6b7280;
      flex-shrink: 0;
      overflow: hidden;
    }

    .topic-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .topic-content {
      flex: 1;
      min-width: 0;
    }

    .topic-content h4 {
      font-size: 1rem;
      color: #1a1a2e;
      margin-bottom: 0.375rem;
      font-weight: 600;
    }

    .topic-content p {
      font-size: 0.875rem;
      color: #6b7280;
      margin-bottom: 0.5rem;
      line-height: 1.5;
    }

    .topic-meta {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.75rem;
    }

    .topic-author {
      color: #374151;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .premium-star {
      color: #f59e0b;
    }

    .admin-badge {
      background: #fef3c7;
      color: #92400e;
      padding: 0.125rem 0.375rem;
      border-radius: 4px;
      font-size: 0.625rem;
      font-weight: 600;
    }

    .topic-stats {
      color: #9ca3af;
    }

    .forum-empty {
      text-align: center;
      padding: 3rem 2rem;
    }

    .forum-empty span {
      font-size: 2.5rem;
      display: block;
      margin-bottom: 0.75rem;
    }

    .forum-empty h4 {
      color: #1a1a2e;
      margin-bottom: 0.25rem;
    }

    .forum-empty p {
      color: #6b7280;
    }

    .forum-cta {
      padding: 1.5rem;
      background: linear-gradient(135deg, #dbeafe, #ede9fe);
      text-align: center;
    }

    .forum-cta p {
      color: #4b5563;
      margin-bottom: 0.75rem;
      font-size: 0.9375rem;
    }

    /* Login Prompt */
    .login-prompt {
      margin-top: 2rem;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 10px;
      text-align: center;
    }
    
    .login-prompt p {
      color: #64748b;
      margin: 0;
    }
    
    .login-prompt a {
      color: var(--primary, #2563eb);
      font-weight: 600;
    }

    /* How It Works */
    .how-it-works {
      background: #f8fafc;
      text-align: center;
    }
    
    .how-it-works h2 {
      font-size: 1.75rem;
      color: #1a1a2e;
      margin-bottom: 3rem;
    }
    
    .features-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 2rem;
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .feature {
      text-align: center;
    }
    
    .feature-icon {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--primary, #2563eb), var(--accent, #059669));
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 auto 1rem;
    }
    
    .feature h3 {
      font-size: 1rem;
      color: #1a1a2e;
      margin-bottom: 0.5rem;
    }
    
    .feature p {
      font-size: 0.875rem;
      color: #64748b;
    }

    /* CTA Section */
    .cta-section {
      text-align: center;
      padding: 4rem 2rem;
      color: white;
    }
    
    .cta-section h2 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    .cta-section p {
      opacity: 0.9;
      margin-bottom: 1.5rem;
    }

    /* Pending Notice */
    .pending-notice {
      background: #fef3c7;
      border-bottom: 2px solid #f59e0b;
    }
    
    .pending-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .pending-icon {
      font-size: 2rem;
    }
    
    .pending-notice h3 {
      color: #92400e;
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }
    
    .pending-notice p {
      color: #78350f;
      font-size: 0.875rem;
      margin: 0;
    }

    /* Announcements Bar */
    .announcements-bar {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      padding: 0.75rem 1rem;
    }
    
    .announcements-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }
    
    .announcement {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      text-align: center;
      flex: 1;
      justify-content: center;
    }
    
    .announcement-icon { font-size: 1.25rem; }
    
    .announcement-content {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .announcement-body { opacity: 0.9; font-size: 0.9375rem; }
    
    .announcement-nav { display: flex; align-items: center; gap: 0.5rem; }
    
    .nav-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.25rem;
    }
    
    .nav-btn:hover { background: rgba(255,255,255,0.3); }
    
    .announcement-count { font-size: 0.8125rem; opacity: 0.9; }

    /* Responsive */
    @media (max-width: 768px) {
      .hero h1 { font-size: 2rem; }
      .hero-buttons { flex-direction: column; }
      .stats-container { grid-template-columns: 1fr; gap: 1rem; }
      .features-grid { grid-template-columns: 1fr; }
      .section-header { flex-direction: column; gap: 1rem; }
      .pending-content { flex-direction: column; text-align: center; }
      .announcements-container { flex-direction: column; gap: 0.5rem; }
    }
  </style>

  {announcements.length > 1 && (
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const announcements = document.querySelectorAll('.announcement');
        const currentSpan = document.querySelector('.announcement-count .current');
        const prevBtn = document.querySelector('.nav-btn.prev');
        const nextBtn = document.querySelector('.nav-btn.next');
        
        if (!announcements.length || !prevBtn || !nextBtn) return;
        
        let current = 0;
        const total = announcements.length;
        
        function show(index: number) {
          announcements.forEach((a, i) => {
            (a as HTMLElement).style.display = i === index ? 'flex' : 'none';
          });
          if (currentSpan) currentSpan.textContent = String(index + 1);
        }
        
        prevBtn.addEventListener('click', () => {
          current = (current - 1 + total) % total;
          show(current);
        });
        
        nextBtn.addEventListener('click', () => {
          current = (current + 1) % total;
          show(current);
        });
        
        setInterval(() => {
          current = (current + 1) % total;
          show(current);
        }, 8000);
      });
    </script>
  )}
</Layout>
