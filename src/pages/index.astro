---
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";
import { getPageContent } from "../lib/content";

/* -----------------------------
   DATA LOADING (UNCHANGED)
------------------------------ */

// Editable page content
const content = await getPageContent("home");

// Session
const session = Astro.locals.session;
const user = session?.user;

// Profile
let userProfile = null;
if (user?.id) {
  const { data } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", user.id)
    .single();
  userProfile = data;
}

const isPending = userProfile?.status === "pending";
const isApproved = userProfile?.status === "active" && userProfile?.is_active;

// Settings
let general = {
  siteName: "Banity",
  tagline: "Create Authentic Content. Get Paid.",
  description: "Banity connects creators with brands for authentic UGC campaigns."
};

try {
  const { data: rows } = await supabase
    .from("site_settings")
    .select("key, value");

  if (rows) {
    for (const row of rows) {
      if (row.key === "general") general = { ...general, ...row.value };
    }
  }
} catch {}

// Announcements
let announcements = [];
try {
  const { data } = await supabase
    .from("messages")
    .select("id, subject")
    .eq("is_announcement", true)
    .order("created_at", { ascending: false })
    .limit(5);

  if (data) announcements = data;
} catch {}

// Campaigns
let campaigns = [];
const showCampaigns = !user || isApproved;

if (showCampaigns) {
  const { data } = await supabase
    .from("campaigns")
    .select("id,title,slug,description,payment_per_post,deadline,status")
    .eq("status", "active")
    .limit(6);

  if (data) campaigns = data;
}

// Stats
const { count: creatorCount } = await supabase
  .from("profiles")
  .select("*", { count: "exact", head: true })
  .eq("role", "creator")
  .eq("status", "active");

const { count: campaignCount } = await supabase
  .from("campaigns")
  .select("*", { count: "exact", head: true })
  .eq("status", "active");
---

<Layout title={general.siteName} description={general.description}>
  <main class="page-wrapper">

    {announcements.length > 0 && (
      <div class="announcements-ticker">
        {announcements.map(a => (
          <span>{a.subject}</span>
        ))}
      </div>
    )}

    {isPending && (
      <div class="pending-banner">
        Your application is under review.
      </div>
    )}

    <!-- HERO -->
    <section class="hero-section">
      <h1>
        <span>Create Content</span>
        <span class="accent">That Matters</span>
      </h1>

      <p>
        Join the next generation of creators. Collaborate with brands.
      </p>

      <div class="hero-cta">
        {user ? (
          isApproved ? (
            <a href="/dashboard" class="cta-primary">Enter Dashboard →</a>
          ) : (
            <span class="cta-pending">Pending Approval</span>
          )
        ) : (
          <>
            <a href="/signup" class="cta-primary">Start Creating →</a>
            <a href="/campaigns" class="cta-secondary">Explore Campaigns</a>
          </>
        )}
      </div>

      <div class="hero-stats">
        <div>
          <strong>{creatorCount || 0}+</strong>
          <span>Creators</span>
        </div>
        <div>
          <strong>{campaignCount || 0}</strong>
          <span>Live Campaigns</span>
        </div>
      </div>
    </section>

    <!-- CAMPAIGNS -->
    {showCampaigns && campaigns.length > 0 && (
      <section class="campaigns-section">
        <h2>Live Campaigns</h2>

        <div class="campaigns-grid">
          {campaigns.map(c => (
            <article class="campaign-card">
              <h3>{c.title}</h3>
              <p>{c.description?.slice(0, 120)}</p>

              {isApproved ? (
                <a href={`/campaigns/${c.slug}`}>Apply →</a>
              ) : (
                <a href="/signup">Join to Apply →</a>
              )}
            </article>
          ))}
        </div>
      </section>
    )}
  </main>

  <style>
    /* ONLY page-specific styles here */
    .hero-section {
      min-height: 100vh;
      text-align: center;
      padding: 8rem 2rem;
    }

    .accent {
      background: linear-gradient(135deg,#4f8bff,#a855f7);
      -webkit-background-clip: text;
      color: transparent;
    }

    .campaigns-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(300px,1fr));
      gap: 1.5rem;
    }
  </style>
</Layout>
