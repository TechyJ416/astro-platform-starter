---
// src/pages/contact.astro
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";

let general = {
  siteName: 'Banity',
  supportEmail: 'support@banity.com',
  contactEmail: 'hello@banity.com',
};

try {
  const { data: rows } = await supabase.from('site_settings').select('key, value');
  if (rows) {
    for (const row of rows) {
      if (row.key === 'general') general = { ...general, ...row.value };
    }
  }
} catch (e) {}

let success = false;
let error = '';

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const name = formData.get('name')?.toString() || '';
    const email = formData.get('email')?.toString() || '';
    const subject = formData.get('subject')?.toString() || '';
    const message = formData.get('message')?.toString() || '';

    if (!name || !email || !message) {
      error = 'Please fill in all required fields.';
    } else {
      // Store in database or send email
      const { error: dbError } = await supabase.from('contact_submissions').insert({
        name, email, subject, message, created_at: new Date().toISOString()
      });
      
      if (dbError) {
        console.error('Contact form error:', dbError);
      }
      success = true;
    }
  } catch (e) {
    error = 'Something went wrong. Please try again.';
  }
}
---

<Layout title="Contact">
  <div class="contact-page">
    <div class="page-header">
      <span class="header-label"><span class="label-line"></span> Get in Touch</span>
      <h1>Contact Us</h1>
      <p>Have questions? We'd love to hear from you.</p>
    </div>

    <div class="contact-grid">
      <div class="contact-info">
        <div class="info-card">
          <div class="info-icon">‚úâÔ∏è</div>
          <h3>Email Us</h3>
          <p>For general inquiries</p>
          <a href={`mailto:${general.contactEmail}`} class="info-link">{general.contactEmail}</a>
        </div>

        <div class="info-card">
          <div class="info-icon">üõü</div>
          <h3>Support</h3>
          <p>Need help with your account?</p>
          <a href={`mailto:${general.supportEmail}`} class="info-link">{general.supportEmail}</a>
        </div>

        <div class="info-card">
          <div class="info-icon">üí¨</div>
          <h3>Community</h3>
          <p>Join our creator community</p>
          <a href="/forum" class="info-link">Visit Forum ‚Üí</a>
        </div>
      </div>

      <div class="contact-form-wrapper">
        {success ? (
          <div class="success-message">
            <div class="success-icon">‚úì</div>
            <h3>Message Sent!</h3>
            <p>We'll get back to you as soon as possible.</p>
            <a href="/" class="btn btn-primary">Back to Home</a>
          </div>
        ) : (
          <form method="POST" class="contact-form">
            {error && <div class="error-message">{error}</div>}
            
            <div class="form-group">
              <label for="name">Name *</label>
              <input type="text" id="name" name="name" required placeholder="Your name" />
            </div>

            <div class="form-group">
              <label for="email">Email *</label>
              <input type="email" id="email" name="email" required placeholder="your@email.com" />
            </div>

            <div class="form-group">
              <label for="subject">Subject</label>
              <input type="text" id="subject" name="subject" placeholder="What's this about?" />
            </div>

            <div class="form-group">
              <label for="message">Message *</label>
              <textarea id="message" name="message" rows="5" required placeholder="Tell us more..."></textarea>
            </div>

            <button type="submit" class="btn btn-primary">Send Message ‚Üí</button>
          </form>
        )}
      </div>
    </div>
  </div>

  <style>
    .contact-page { max-width: 1000px; margin: 0 auto; padding: 2rem; }

    .page-header { text-align: center; margin-bottom: 4rem; }

    .header-label {
      display: inline-flex; align-items: center; gap: 1rem; margin-bottom: 1rem;
      font-size: 0.8125rem; color: var(--cosmic-blue); text-transform: uppercase;
      letter-spacing: 0.15em; font-weight: 600;
    }

    .label-line { width: 30px; height: 1px; background: var(--cosmic-blue); }
    .page-header h1 { font-size: 2.5rem; font-weight: 800; color: var(--star-white); margin-bottom: 0.5rem; }
    .page-header p { color: var(--star-dim); font-size: 1.125rem; }

    .contact-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 3rem; }

    .contact-info { display: flex; flex-direction: column; gap: 1.5rem; }

    .info-card {
      background: linear-gradient(135deg, rgba(26, 26, 46, 0.6), rgba(8, 8, 18, 0.6));
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px; padding: 1.5rem;
      transition: all 0.3s;
    }

    .info-card:hover { border-color: rgba(79, 139, 255, 0.3); }

    .info-icon { font-size: 2rem; margin-bottom: 0.75rem; }
    .info-card h3 { font-size: 1rem; color: var(--star-white); margin-bottom: 0.25rem; }
    .info-card p { font-size: 0.875rem; color: var(--star-dim); margin-bottom: 0.5rem; }
    .info-link { color: var(--cosmic-blue); text-decoration: none; font-weight: 600; font-size: 0.875rem; }
    .info-link:hover { text-decoration: underline; }

    .contact-form-wrapper {
      background: linear-gradient(135deg, rgba(26, 26, 46, 0.7), rgba(8, 8, 18, 0.7));
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 20px; padding: 2rem;
    }

    .contact-form { display: flex; flex-direction: column; gap: 1.5rem; }

    .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .form-group label { font-size: 0.875rem; font-weight: 600; color: var(--star-white); }

    .form-group input, .form-group textarea {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px; padding: 0.875rem 1rem;
      color: var(--star-white); font-size: 0.9375rem;
      font-family: inherit; transition: all 0.3s;
    }

    .form-group input::placeholder, .form-group textarea::placeholder { color: var(--star-muted); }

    .form-group input:focus, .form-group textarea:focus {
      outline: none; border-color: var(--cosmic-blue);
      background: rgba(79, 139, 255, 0.05);
    }

    .form-group textarea { resize: vertical; min-height: 120px; }

    .error-message {
      background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 10px; padding: 0.875rem; color: #f87171; font-size: 0.875rem;
    }

    .success-message {
      text-align: center; padding: 3rem 2rem;
    }

    .success-icon {
      width: 60px; height: 60px; margin: 0 auto 1.5rem;
      background: linear-gradient(135deg, var(--cosmic-blue), var(--cosmic-purple));
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem; color: white;
    }

    .success-message h3 { font-size: 1.5rem; color: var(--star-white); margin-bottom: 0.5rem; }
    .success-message p { color: var(--star-dim); margin-bottom: 1.5rem; }

    @media (max-width: 768px) {
      .contact-grid { grid-template-columns: 1fr; }
    }
  </style>
</Layout>
