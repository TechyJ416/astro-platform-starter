---
// src/pages/login.astro
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";

const session = Astro.locals.session;
if (session) {
  return Astro.redirect('/dashboard');
}

let error = '';
const url = new URL(Astro.request.url);
const redirectTo = url.searchParams.get('redirect') || '/dashboard';

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const email = formData.get('email')?.toString() || '';
    const password = formData.get('password')?.toString() || '';

    const { data, error: authError } = await supabase.auth.signInWithPassword({
      email,
      password,
    });

    if (authError) {
      error = authError.message;
    } else if (data.session) {
      // Set cookie and redirect
      Astro.cookies.set('sb-access-token', data.session.access_token, {
        path: '/',
        httpOnly: true,
        secure: true,
        sameSite: 'lax',
        maxAge: 60 * 60 * 24 * 7,
      });
      Astro.cookies.set('sb-refresh-token', data.session.refresh_token, {
        path: '/',
        httpOnly: true,
        secure: true,
        sameSite: 'lax',
        maxAge: 60 * 60 * 24 * 30,
      });
      return Astro.redirect(redirectTo);
    }
  } catch (e) {
    error = 'Something went wrong. Please try again.';
  }
}
---

<Layout title="Sign In">
  <div class="auth-page">
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <span class="auth-icon">✦</span>
          <h1>Welcome Back</h1>
          <p>Sign in to your account</p>
        </div>

        {error && <div class="error-message">{error}</div>}

        <form method="POST" class="auth-form">
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" required placeholder="your@email.com" autocomplete="email" />
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required placeholder="••••••••" autocomplete="current-password" />
          </div>

          <button type="submit" class="btn btn-primary btn-full">Sign In →</button>
        </form>

        <div class="auth-footer">
          <p>Don't have an account? <a href="/signup">Sign up</a></p>
          <a href="/forgot-password" class="forgot-link">Forgot password?</a>
        </div>
      </div>

      <div class="auth-decoration">
        <div class="deco-orb orb-1"></div>
        <div class="deco-orb orb-2"></div>
        <div class="deco-orb orb-3"></div>
      </div>
    </div>
  </div>

  <style>
    .auth-page {
      min-height: calc(100vh - 200px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .auth-container { position: relative; width: 100%; max-width: 420px; }

    .auth-card {
      position: relative;
      background: linear-gradient(135deg, rgba(26, 26, 46, 0.8), rgba(8, 8, 18, 0.8));
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 24px;
      padding: 2.5rem;
      backdrop-filter: blur(20px);
      z-index: 1;
    }

    .auth-header { text-align: center; margin-bottom: 2rem; }
    
    .auth-icon {
      display: inline-block;
      font-size: 2rem;
      color: var(--cosmic-blue);
      margin-bottom: 1rem;
      text-shadow: 0 0 30px var(--glow-blue);
    }

    .auth-header h1 { font-size: 1.75rem; font-weight: 800; color: var(--star-white); margin-bottom: 0.5rem; }
    .auth-header p { color: var(--star-dim); }

    .auth-form { display: flex; flex-direction: column; gap: 1.25rem; }

    .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .form-group label { font-size: 0.875rem; font-weight: 600; color: var(--star-white); }

    .form-group input {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 0.875rem 1rem;
      color: var(--star-white);
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.3s;
    }

    .form-group input::placeholder { color: var(--star-muted); }

    .form-group input:focus {
      outline: none;
      border-color: var(--cosmic-blue);
      background: rgba(79, 139, 255, 0.08);
      box-shadow: 0 0 0 3px rgba(79, 139, 255, 0.1);
    }

    .btn-full { width: 100%; justify-content: center; margin-top: 0.5rem; }

    .error-message {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 10px;
      padding: 0.875rem;
      color: #f87171;
      font-size: 0.875rem;
      margin-bottom: 1rem;
    }

    .auth-footer {
      margin-top: 2rem;
      text-align: center;
      padding-top: 1.5rem;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .auth-footer p { color: var(--star-dim); font-size: 0.9375rem; }
    .auth-footer a { color: var(--cosmic-blue); text-decoration: none; font-weight: 600; }
    .auth-footer a:hover { text-decoration: underline; }

    .forgot-link { display: block; margin-top: 0.75rem; font-size: 0.875rem; color: var(--star-muted) !important; }

    /* Decorative orbs */
    .auth-decoration { position: absolute; inset: -50px; pointer-events: none; z-index: 0; }

    .deco-orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(60px);
      opacity: 0.4;
    }

    .orb-1 {
      width: 200px; height: 200px;
      background: var(--cosmic-blue);
      top: -50px; left: -50px;
      animation: float 8s ease-in-out infinite;
    }

    .orb-2 {
      width: 150px; height: 150px;
      background: var(--cosmic-purple);
      bottom: -30px; right: -30px;
      animation: float 10s ease-in-out infinite reverse;
    }

    .orb-3 {
      width: 100px; height: 100px;
      background: var(--cosmic-pink);
      top: 50%; right: -60px;
      animation: float 6s ease-in-out infinite 2s;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(20px, -20px); }
    }
  </style>
</Layout>
