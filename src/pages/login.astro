---
// src/pages/login.astro
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";

// Redirect if already logged in
const session = Astro.locals.session;
if (session?.user) {
  return Astro.redirect('/dashboard');
}

let error = '';
let pendingAccount = false;
let deniedAccount = false;
let suspendedAccount = false;

// Check for status from URL (redirected from middleware)
const statusParam = Astro.url.searchParams.get('status');
if (statusParam === 'pending') pendingAccount = true;
if (statusParam === 'denied') deniedAccount = true;
if (statusParam === 'suspended') suspendedAccount = true;

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const email = formData.get('email') as string;
  const password = formData.get('password') as string;

  if (!email || !password) {
    error = 'Email and password are required.';
  } else {
    const { data, error: authError } = await supabase.auth.signInWithPassword({
      email,
      password,
    });

    if (authError) {
      error = authError.message;
    } else if (data.user) {
      // Check user profile status
      const { data: profile } = await supabase
        .from('profiles')
        .select('status, is_active')
        .eq('id', data.user.id)
        .single();

      if (profile?.status === 'pending') {
        await supabase.auth.signOut();
        pendingAccount = true;
      } else if (profile?.status === 'denied') {
        await supabase.auth.signOut();
        deniedAccount = true;
      } else if (!profile?.is_active || profile?.status === 'suspended') {
        await supabase.auth.signOut();
        suspendedAccount = true;
      } else {
        // Set session cookie and redirect
        const response = Astro.response;
        response.headers.set(
          'Set-Cookie',
          `sb-access-token=${data.session?.access_token}; Path=/; HttpOnly; SameSite=Lax; Max-Age=604800`
        );
        return Astro.redirect('/dashboard');
      }
    }
  }
}

const returnTo = Astro.url.searchParams.get('returnTo') || '/dashboard';
---

<Layout>
  <div class="login-page">
    <div class="login-container">
      {pendingAccount ? (
        <div class="status-card pending">
          <div class="status-icon">‚è≥</div>
          <h1>Account Pending Approval</h1>
          <p>Your account is still being reviewed by our team.</p>
          <p class="subtext">We'll send you an email as soon as your account is approved. This usually takes 1-2 business days.</p>
          <div class="status-actions">
            <a href="/" class="btn btn-secondary">Go Home</a>
          </div>
        </div>
      ) : deniedAccount ? (
        <div class="status-card denied">
          <div class="status-icon">‚ùå</div>
          <h1>Application Not Approved</h1>
          <p>Unfortunately, your application was not approved at this time.</p>
          <p class="subtext">If you believe this is a mistake, please contact our support team.</p>
          <div class="status-actions">
            <a href="/" class="btn btn-secondary">Go Home</a>
          </div>
        </div>
      ) : suspendedAccount ? (
        <div class="status-card suspended">
          <div class="status-icon">üö´</div>
          <h1>Account Suspended</h1>
          <p>Your account has been suspended.</p>
          <p class="subtext">Please contact support if you believe this is an error.</p>
          <div class="status-actions">
            <a href="/" class="btn btn-secondary">Go Home</a>
          </div>
        </div>
      ) : (
        <div class="login-card">
          <div class="card-header">
            <h1>Welcome Back</h1>
            <p>Log in to your creator account</p>
          </div>

          {error && <div class="alert error">{error}</div>}

          <form method="POST" class="login-form">
            <div class="form-group">
              <label for="email">Email Address</label>
              <input 
                type="email" 
                id="email" 
                name="email" 
                placeholder="you@example.com"
                required
                autocomplete="email"
              />
            </div>

            <div class="form-group">
              <label for="password">Password</label>
              <input 
                type="password" 
                id="password" 
                name="password" 
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                required
                autocomplete="current-password"
              />
            </div>

            <button type="submit" class="btn btn-primary btn-full">Log In</button>
            
            <div class="forgot-link">
              <a href="/forgot-password">Forgot your password?</a>
            </div>
          </form>

          <div class="card-footer">
            <p>Don't have an account? <a href="/signup">Join the waitlist</a></p>
          </div>
        </div>
      )}
    </div>
  </div>

  <style>
    .login-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
    }

    .login-container {
      width: 100%;
      max-width: 420px;
    }

    .login-card, .status-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .card-header {
      padding: 2rem 2rem 0;
      text-align: center;
    }

    .card-header h1 {
      font-size: 1.75rem;
      color: #1a1a2e;
      margin-bottom: 0.5rem;
    }

    .card-header p {
      color: #6b7280;
      font-size: 0.9375rem;
    }

    .login-form {
      padding: 1.5rem 2rem 2rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
    }

    .form-group input {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .btn {
      padding: 0.875rem 1.5rem;
      border-radius: 10px;
      font-weight: 600;
      font-size: 1rem;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }

    .forgot-link {
      text-align: center;
      margin-top: 1rem;
    }

    .forgot-link a {
      color: #6b7280;
      text-decoration: none;
      font-size: 0.875rem;
    }

    .forgot-link a:hover {
      color: #2563eb;
      text-decoration: underline;
    }

    .btn-full {
      width: 100%;
    }

    .card-footer {
      padding: 1.5rem 2rem;
      background: #f9fafb;
      text-align: center;
      font-size: 0.9375rem;
      color: #6b7280;
    }

    .card-footer a {
      color: #2563eb;
      text-decoration: none;
      font-weight: 600;
    }

    .card-footer a:hover {
      text-decoration: underline;
    }

    .alert {
      margin: 1.5rem 2rem 0;
      padding: 1rem;
      border-radius: 10px;
      font-size: 0.9375rem;
    }

    .alert.error {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Status Cards */
    .status-card {
      padding: 3rem 2rem;
      text-align: center;
    }

    .status-card.pending {
      border-top: 4px solid #f59e0b;
    }

    .status-card.denied {
      border-top: 4px solid #ef4444;
    }

    .status-card.suspended {
      border-top: 4px solid #6b7280;
    }

    .status-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .status-card h1 {
      font-size: 1.5rem;
      color: #1a1a2e;
      margin-bottom: 1rem;
    }

    .status-card p {
      color: #374151;
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }

    .status-card .subtext {
      color: #6b7280;
      font-size: 0.9375rem;
    }

    .status-actions {
      margin-top: 1.5rem;
    }
  </style>
</Layout>
